"use strict";(self.webpackChunkmynameis=self.webpackChunkmynameis||[]).push([[578],{1708:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>d});var t=i(5893),s=i(1151);const a={slug:"container-in-container-09",title:"How Treenq builds workload images",authors:["denis"],tags:["software","paas"]},o=void 0,r={permalink:"/mynameis/blog/container-in-container-09",source:"@site/blog/10-container-in-container/index.mdx",title:"How Treenq builds workload images",description:"Build a container inside a rootless conatiner",date:"2025-06-01T21:59:56.000Z",formattedDate:"June 1, 2025",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"},{label:"paas",permalink:"/mynameis/blog/tags/paas"}],readingTime:7.275,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"container-in-container-09",title:"How Treenq builds workload images",authors:["denis"],tags:["software","paas"]},unlisted:!1,nextItem:{title:"Project ideas I keep",permalink:"/mynameis/blog/ideas-09"}},l={authorsImageUrls:[void 0]},d=[{value:"Build a container inside a rootless conatiner",id:"build-a-container-inside-a-rootless-conatiner",level:2},{value:"Grug: docker in docker",id:"grug-docker-in-docker",level:3},{value:"BuildKit: overlooked option",id:"buildkit-overlooked-option",level:3},{value:"Kaniko: k8s native builder",id:"kaniko-k8s-native-builder",level:3},{value:"Buildah: isolated package",id:"buildah-isolated-package",level:3},{value:"Reconsider real design",id:"reconsider-real-design",level:3},{value:"Conclusion",id:"conclusion",level:3}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"build-a-container-inside-a-rootless-conatiner",children:"Build a container inside a rootless conatiner"}),"\n",(0,t.jsxs)(n.p,{children:["A PaaS has a very dev friendly use case: when a user just conneects a repository we must build the image from a Dockerfile in the repo.\nWe assume at the beginning a team doesn't have a CI pipeline and wants to share a quick demo to the customers.\nThere are many ways to do it. Let's look at all of them and at the design we chosed for ",(0,t.jsx)(n.a,{href:"https://github.com/treenq/treenq",children:"Treenq"})]}),"\n",(0,t.jsx)(n.h3,{id:"grug-docker-in-docker",children:"Grug: docker in docker"}),"\n",(0,t.jsx)(n.p,{children:"As a straight forward approach we can forward docker host to a container and build it.\nIt has quite a lot of problems:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"dind requirees running in privileged mode: it opens a rabbit hole to a host machine"}),"\n",(0,t.jsx)(n.li,{children:"moreover, it doesn't seem an option to make it rootless"}),"\n",(0,t.jsx)(n.li,{children:"docker daemon is running, it's not free for resources"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Even to get started the user case it didn't seem convinient, it requires configuration to make it possible, so I decided to move to more secure options."}),"\n",(0,t.jsx)(n.h3,{id:"buildkit-overlooked-option",children:"BuildKit: overlooked option"}),"\n",(0,t.jsx)(n.p,{children:"What if docker could get rid of priviileged mode?"}),"\n",(0,t.jsx)(n.p,{children:"Buildx (BuildKit) is a module of docker (or moby?) that's responsible specifically for building iamges."}),"\n",(0,t.jsx)(n.p,{children:"BuildKit still has a daemon and it requires a privileged mode either."}),"\n",(0,t.jsxs)(n.p,{children:["However, we can run fake root using ",(0,t.jsx)(n.a,{href:"https://github.com/rootless-containers/rootlesskit/",children:"RootlessKit"}),".\nWe can build our flow in the following way:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"run a daemon"}),"\n",(0,t.jsx)(n.li,{children:"run buildctl to start build"}),"\n",(0,t.jsx)(n.li,{children:"when we are done we close the daemon"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"RootlessKit requires turning off apparmor and seccomp, because the default profile doesn't allow spawning new namespaces.\nAlso, add a few linux capabilities like SETUID, SETGUID and fake root users removing the option no-new-privileges."}),"\n",(0,t.jsx)(n.p,{children:"It seems quite secure, but has a few constraints:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"requires support explicit uid and gid which is not fine and might be annoyign"}),"\n",(0,t.jsx)(n.li,{children:"requires supporting a designated pool of build machines, which is actually makes sence in terms of designing a PaaS, but makes it a way complicated to start"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"kaniko-k8s-native-builder",children:"Kaniko: k8s native builder"}),"\n",(0,t.jsx)(n.p,{children:"Kaniko is created to solve this problem.\nIt allows setting up an environemnt for a cluster where the workload is built near it's runners, perhaps on different nodes in order to avoid any resource fight.\nThe idea is it spans a new container that builds an image, the container feels great in unprivileged environment and doesn't require a docker daemon."}),"\n",(0,t.jsx)(n.p,{children:"Technically it doesn't create a new namespace, instead it unpacks an image layer and does chroot."}),"\n",(0,t.jsxs)(n.p,{children:["You can even span your registry right in this cluster, like a regular one or ",(0,t.jsx)(n.a,{href:"https://github.com/goharbor/harbor",children:"Harbor"})," and the builds flow is completely isolated from the planet.\nIt like like ",(0,t.jsx)(n.strong,{children:"kaniko -> registry -> k8s workload node"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"In terms of security Kaniko is the winner.\nIt does require root to run, but the abstraction is well done to keep it away."}),"\n",(0,t.jsx)(n.p,{children:"Looks fancy, but has a couple restrictions:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"it buidls containers only inside a Kubernetes cluster, it works in k8s, k3s (which we use for e2e tests) and perhaps some more."}),"\n",(0,t.jsx)(n.li,{children:"it has no more capabilities, if I need to inspect an image."}),"\n",(0,t.jsx)(n.li,{children:"it's not able to build windows images"}),"\n",(0,t.jsx)(n.li,{children:"build time performance is slightly lower"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["For instance, I want to rollback, I want it real quick, so before launching a build job I want to look if the image is in the registry.\nFor that purpose I must use skopeo or another tool to talk to a registry.\nNot really a big deal.\nPerhaps, one day Treenq will need ",(0,t.jsx)(n.a,{href:"https://github.com/containers/skopeo",children:"Skopeo"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Looking back it looks a good option and most likely I would say it's worth trying it.\nBut I thought it's very important to have a capability to run builds outside of a cluster, may be even on a isoalted VM, which is not really smart requirement I guess.\nAlso, the complexity to set it up didn't look easy enough, I have to span a k8s resource, make a ServiceAccount for it and many more to start building + adding inspection API near by."}),"\n",(0,t.jsx)(n.h3,{id:"buildah-isolated-package",children:"Buildah: isolated package"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://github.com/containers/podman",children:"Podman"}),", a Docker alternative, has a way cleaner opensource relation and how they structure the packages and repositories.\nPodman has a designated module, ",(0,t.jsx)(n.a,{href:"https://github.com/containers/buildah",children:"Buildah"}),", which is used exactly for building images.\nIt requires no priovileges, root, daemon, nothing (technically speaking, but there is a price for it)."]}),"\n",(0,t.jsx)(n.p,{children:"It doesn't require a daemon to run.\nPackage is written in Go, therefore I can embed it right into the service instead of adding a syscall."}),"\n",(0,t.jsx)(n.p,{children:"DISCLAIMER: I understand I use undocumented API of the package and it can hurt it. If it happens I can freeze the version, and then either the project fulfills the graveyard or it migrates to buildkit."}),"\n",(0,t.jsxs)(n.p,{children:["First step is to understand how to run buidlah in a container.\nThere is an official ",(0,t.jsx)(n.a,{href:"https://hub.docker.com/r/buildah/buildah",children:"image"})," based on Fedora, but I want my app run at least in Ubuntu.\nBetter in alpine/scratch ofc, but it doesn't seem viable."]}),"\n",(0,t.jsxs)(n.p,{children:["There are a some guides on ",(0,t.jsx)(n.a,{href:"https://developers.redhat.com/blog/2019/08/14/best-practices-for-running-buildah-in-a-container",children:"how to run buildah in a container"})," and ",(0,t.jsx)(n.a,{href:"https://opensource.com/article/19/3/tips-tricks-rootless-buildah",children:"in privileged environment"}),", so I can slowly transform this information to prepare Ubuntu image.\nHere is what I got ",(0,t.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/main/Dockerfile",children:"eventually"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"Ok, we can build, next step I want to build a small image from Go application."}),"\n",(0,t.jsxs)(n.p,{children:["There is a ",(0,t.jsx)(n.a,{href:"https://github.com/containers/buildah/blob/main/docs/tutorials/04-include-in-your-build-tool.md",children:"guilde"})," showing how programmatically execute dockerfile steps (run, copy, etc.), but it's not what we need.\nWe simply need to run ",(0,t.jsx)(n.code,{children:"buildah build"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"At this point I have to dig the source code to understand what's happening.\nJumping right inside the build command in the source code we find there is a storage resource is required to start and we can execute the build"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"\tbuildStoreOptions, _ := storage.DefaultStoreOptions()\n\tbuildStore, _ := storage.GetStore(buildStoreOptions)\n"})}),"\n",(0,t.jsx)(n.p,{children:"And next step we can start build:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"\tid, _, err := imagebuildah.BuildDockerfiles(ctx, buildStore, define.BuildOptions{\n\t\tContextDirectory: args.Path,\n\t\tRegistry:         a.registry,\n\t\tOutput:           args.Name,\n\t\tOut:              out,\n\t\tErr:              errOut,\n\t\tReportWriter:     reportOut,\n\t\tIgnoreFile:     dockerignorePath,\n\t\tAdditionalTags: []string{image.FullPath()},\n\t}, args.Dockerfile)\n"})}),"\n",(0,t.jsx)(n.p,{children:"To push the image we need to get a reference to this image in our store and prepare system context: registry authentication, tls flags, certs."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'\tstoreRef, _ := alltransports.ParseImageName("docker://" + image.FullPath())\n\tsystemContext, := &types.SystemContext{\n\t\tDockerCertPath:              a.registryCertDir,\n\t\tDockerInsecureSkipTLSVerify: types.NewOptionalBool(!a.registryTLSVerify),\n\t\tDockerAuthConfig:            &types.DockerAuthConfig{\n\t\t\tIdentityToken: a.registryToken,\n\t\t},\n\t} \n\t_, _, err = buildah.Push(ctx, id, storeRef, buildah.PushOptions{\n\t\tStore:         a.store,\n\t\tSystemContext: systemContext,\n\t})\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Full version of this module is ",(0,t.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go",children:"here"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"One important detail: first lines of your main function must be:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"\tif buildah.InitReexec() {\n\t\treturn\n\t}\n\tunshare.MaybeReexecUsingUserNamespace(false)\n"})}),"\n",(0,t.jsx)(n.p,{children:"It matters to act Buildah as root without being real rool.\nIt logs the OS thread, prepares uid/gid mapping and reexec as a new user in a new namespace.\nSo, softly speaking, it's not ideal to run this code inside the application code."}),"\n",(0,t.jsx)(n.p,{children:"The best design would be to have the application code isolated from pool of builders. Builders can receive the build tasks and still execute it inside a Go app in order to being able to extend he capabilities.\nThis design allows me to extend options to build images: In a similar manner I can embed buildpacks to build simpler apps without a Dockerfile."}),"\n",(0,t.jsx)(n.p,{children:"Buildah, unfortunately, also has a few caveats and it's a little behined of docker."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["For instance buildah can't inject variables/secrets ",(0,t.jsx)(n.a,{href:"https://github.com/containers/buildah/issues/5892",children:"on RUN command"})," while docker can."]}),"\n",(0,t.jsxs)(n.li,{children:["Or it can't detect ",(0,t.jsx)(n.a,{href:"https://github.com/containers/buildah/issues/5408",children:"variables in images"})]}),"\n",(0,t.jsx)(n.li,{children:"Also, runniong it unprivileged is quite tricky and it requires specific arguments for container and specific build of the image itself.\nThe domain is huge to learn, different backends, storages drivers and so on."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["From this ",(0,t.jsx)(n.a,{href:"https://github.com/containers/buildah/issues/2554",children:"issue"})," I learned vfs storage driver copies the entire sublayer on every layer.\nSo it's better to use overlayfs, it requires /dev/fuse to run in non privileged container."]}),"\n",(0,t.jsxs)(n.p,{children:["As a bonus, it might be cool to put it inside alpine, but not sure it's viable at all.\nPutting a cgo app itself requires some ",(0,t.jsx)(n.a,{href:"https://baicai.xlog.app/docker_golang_alpine_cgo_build?locale=en",children:"dance"})," for it."]}),"\n",(0,t.jsx)(n.h3,{id:"reconsider-real-design",children:"Reconsider real design"}),"\n",(0,t.jsx)(n.p,{children:'Technically, I consider current setup "fine" to start, but not scalable well.\nA platform app and build setup must be segregated well.\nUnfortunately, it makes it complicated to host and manage, but it might be changed in the following manner.'}),"\n",(0,t.jsx)(n.p,{children:"App has a buildctl, just as a client and doesn't require any meaningful capabilities privileges.\nAnd there is a pool of machines to execute build job."}),"\n",(0,t.jsx)(n.p,{children:"Alternatively, if buildah features is enough, a pool of build machine can be also moved to another node, but it's a simple async api that waits for a task and starts a build job."}),"\n",(0,t.jsx)(n.p,{children:"I think it requires benchmarking for specific usecase and such benchmark might be quite time consuming."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"img",src:i(409).Z+"",width:"890",height:"695"})}),"\n",(0,t.jsx)(n.h3,{id:"conclusion",children:"Conclusion"}),"\n",(0,t.jsx)(n.p,{children:"Very sad, but we don't have free for everyone the most secure solution to build images.\nAnd when it comes to multitenant platform it becomes even more complicated."})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},409:(e,n,i)=>{i.d(n,{Z:()=>t});const t=i.p+"assets/images/design-39997db514e3b892d65b07dc0c23f124.svg"},1151:(e,n,i)=>{i.d(n,{Z:()=>r,a:()=>o});var t=i(7294);const s={},a=t.createContext(s);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);