(self.webpackChunkmynameis=self.webpackChunkmynameis||[]).push([[237],{2934:(e,n,t)=>{var i={"./01-why-you-need-a-blog/index.mdx":8671,"./02-250mbjson-in-50mb-limit/index.mdx":1232,"./03-do-gamedev/index.mdx":4721,"./04-tq-devlog-0/index.md":8826,"./05-api-design/index.mdx":2485,"./06-unit-test-observability/index.md":3218,"./07-go-dockerfile/index.mdx":6218,"./08-gopls/index.mdx":5155,"./09-ideas/index.mdx":5306,"./10-container-in-container/index.mdx":1708};function o(e){var n=s(e);return t(n)}function s(e){if(!t.o(i,e)){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}return i[e]}o.keys=function(){return Object.keys(i)},o.resolve=s,e.exports=o,o.id=2934},8671:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"why-a-blog",title:"Why this page exists",authors:["denis"],tags:["career"]},a=void 0,r={permalink:"/mynameis/blog/why-a-blog",source:"@site/blog/01-why-you-need-a-blog/index.mdx",title:"Why this page exists",description:'Blog is a\xa0 system to spread ideas across the internet. Shout out about a thing "Look, I have an opinion on that if you care".',date:"2023-12-13T21:25:34.000Z",formattedDate:"December 13, 2023",tags:[{label:"career",permalink:"/mynameis/blog/tags/career"}],readingTime:3.305,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"why-a-blog",title:"Why this page exists",authors:["denis"],tags:["career"]},unlisted:!1,prevItem:{title:"250mb json in a 40mb service limit",permalink:"/mynameis/blog/big-json"}},l={authorsImageUrls:[void 0]},d=[{value:"It makes more than 0 chances somebody will find it and share your opinion",id:"it-makes-more-than-0-chances-somebody-will-find-it-and-share-your-opinion",level:2},{value:"More than 0 chances your future team knows you",id:"more-than-0-chances-your-future-team-knows-you",level:2},{value:"Memo is good",id:"memo-is-good",level:2},{value:"Expressing better",id:"expressing-better",level:2},{value:"You are ready. what now?",id:"you-are-ready-what-now",level:2}];function c(e){const n={a:"a",h2:"h2",p:"p",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:'Blog is a\xa0 system to spread ideas across the internet. Shout out about a thing "Look, I have an opinion on that if you care".'}),"\n",(0,i.jsx)(n.p,{children:"I have opinion on different things, especially in software. I've been working on it since 2015."}),"\n",(0,i.jsx)(n.p,{children:"So let's start from reasoning why you might want to own one."}),"\n",(0,i.jsx)(n.h2,{id:"it-makes-more-than-0-chances-somebody-will-find-it-and-share-your-opinion",children:"It makes more than 0 chances somebody will find it and share your opinion"}),"\n",(0,i.jsx)(n.p,{children:"Or disagree, it's also fine and in some cases means almost the the same for you."}),"\n",(0,i.jsx)(n.p,{children:"You get audience.\xa0"}),"\n",(0,i.jsx)(n.p,{children:"And it's a big deal."}),"\n",(0,i.jsx)(n.p,{children:"First, the audience challenges your ideas. It's good to find a person to discuss your ideas. It allows your either find weaknesses in the idea itself, or perhaps your mindset to find crucial vocabulary to express what it means for you, or become even more confident on a topic. After all, it's just a joy to discuss what you have on top of your head."}),"\n",(0,i.jsx)(n.h2,{id:"more-than-0-chances-your-future-team-knows-you",children:"More than 0 chances your future team knows you"}),"\n",(0,i.jsx)(n.p,{children:"It's a well known that having a referral in a company makes hiring easier to everyone. They get plus a point in confidence they hire not a dumbass, you may skip long questionnaire. They refer you not because you are good at contribution, but it's easier to build ubiquitous language in the team when you know each other."}),"\n",(0,i.jsx)(n.p,{children:"I want to say having written something valuable for others makes you a little more known that you used to be. And if you apply to a new job and they have found it - it bumps your chances a lot."}),"\n",(0,i.jsx)(n.p,{children:"Im convinced in the idea that not just delivering good result to your company, but telling the best pieces to the others will pay me off later on."}),"\n",(0,i.jsx)(n.p,{children:"The only thing is under question if we really have built and understood something important for the industry."}),"\n",(0,i.jsx)(n.h2,{id:"memo-is-good",children:"Memo is good"}),"\n",(0,i.jsx)(n.p,{children:"During software experience I realised the wide range technologies I apply can hardly be stored in my head."}),"\n",(0,i.jsx)(n.p,{children:"Tools such Obsidian are fancy, but Im not disciplined enough to handle my cloud to store it or just structure them well enough, it doesn't fit me."}),"\n",(0,i.jsx)(n.p,{children:"So Im going to structure my experience here."}),"\n",(0,i.jsx)(n.p,{children:"It's not just putting all I have in my memory, but also try structuring all new stuff I have in my head."}),"\n",(0,i.jsx)(n.p,{children:"For instance, I want to memoize a way to define alerts using terraform. Even though I've done it I have no idea what those queries to an observability provider mean.\xa0"}),"\n",(0,i.jsx)(n.p,{children:"What should I do?"}),"\n",(0,i.jsx)(n.p,{children:"Not to fool people. I will figure out in order to explain it to the others. Otherwise the article will be one of the thousands on medium or linkedin."}),"\n",(0,i.jsx)(n.p,{children:"Eventually I have to push my skill up to give my audience valuable experience shared."}),"\n",(0,i.jsx)(n.p,{children:"In the same time I get structured my experience and making it better by reading more in order to write a little."}),"\n",(0,i.jsx)(n.h2,{id:"expressing-better",children:"Expressing better"}),"\n",(0,i.jsx)(n.p,{children:"And my personal reason."}),"\n",(0,i.jsx)(n.p,{children:"Im poor at structuring my speach. If you read it you know how hard it was to catch my ideas. But I fight against it and I believe the blog may make me write more often and amend the way I express myself."}),"\n",(0,i.jsx)(n.h2,{id:"you-are-ready-what-now",children:"You are ready. what now?"}),"\n",(0,i.jsx)(n.p,{children:"Ok, let's say you confirmed you have a reason to have a blog."}),"\n",(0,i.jsx)(n.p,{children:"A couple of hints I want to add."}),"\n",(0,i.jsx)(n.p,{children:"Platforms like medium blocks people from reading your content without subscription.\nAnd definitely it's not what I want."}),"\n",(0,i.jsx)(n.p,{children:"I can understand if you want to setup patreon to provide sub only data, but I don't consider such option.\xa0\nMoreover, the platforms get bigger revenue chunk of your ad and don't do more than google does."}),"\n",(0,i.jsxs)(n.p,{children:["I picked docusaurus because I have full control on codebase, fonts, styles, ads, comments, structuring. And I was lucky enough to find a template I wanted to reuse by ",(0,i.jsx)(n.a,{href:"https://takken.io/",children:"takken"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Or you can just clone this ",(0,i.jsx)(n.a,{href:"https://github.com/dennypenta/mynameis",children:"project"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},1232:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"big-json",title:"250mb json in a 40mb service limit",authors:["denis"],tags:["software"]},a=void 0,r={permalink:"/mynameis/blog/big-json",source:"@site/blog/02-250mbjson-in-50mb-limit/index.mdx",title:"250mb json in a 40mb service limit",description:"This article has been created to remind us of one simple thing: HTTP is a stream.",date:"2024-05-26T15:48:12.000Z",formattedDate:"May 26, 2024",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"}],readingTime:6.8,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"big-json",title:"250mb json in a 40mb service limit",authors:["denis"],tags:["software"]},unlisted:!1,prevItem:{title:"Backend Guy Ventures into Game Development",permalink:"/mynameis/blog/do-gamedev"},nextItem:{title:"Why this page exists",permalink:"/mynameis/blog/why-a-blog"}},l={authorsImageUrls:[void 0]},d=[{value:"The challenge: cut down the memory consumption as much as we can.",id:"the-challenge-cut-down-the-memory-consumption-as-much-as-we-can",level:3},{value:"3 Ways to do it",id:"3-ways-to-do-it",level:3},{value:"First, Brute Force solution.",id:"first-brute-force-solution",level:3},{value:"Second, decode object by object.",id:"second-decode-object-by-object",level:3},{value:"Third, the simplest: data compression.",id:"third-the-simplest-data-compression",level:3},{value:"Conclusion",id:"conclusion",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"This article has been created to remind us of one simple thing: HTTP is a stream."}),"\n",(0,i.jsx)(n.p,{children:"As a practical outcome we can learn how to reduce memory requirements for our services in a typical task: cache warming."}),"\n",(0,i.jsx)(n.p,{children:"Let's look at the challenge first."}),"\n",(0,i.jsx)(n.p,{children:"We have a service that must download the data and keep it in memory.\nThe issue is the JSON document we have to download is 10 times larger than the encoded data.\nTherefore we have to increase the memory limit 2-3 times to download it once.\nLater on, the service doesn't consume as much memory, so it's a start up cost."}),"\n",(0,i.jsx)(n.h3,{id:"the-challenge-cut-down-the-memory-consumption-as-much-as-we-can",children:"The challenge: cut down the memory consumption as much as we can."}),"\n",(0,i.jsx)(n.p,{children:"Let's get back to the basic of network communication."}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"We skip TLS termination for the sake of simplicity."})}),"\n",(0,i.jsxs)(n.p,{children:["There is a great book that explains it very well: ",(0,i.jsx)(n.a,{href:"https://hpbn.co/building-blocks-of-tcp/#slow-start",children:"https://hpbn.co/building-blocks-of-tcp/#slow-start"})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"img",src:t(8006).Z+"",width:"343",height:"171"})}),"\n",(0,i.jsx)(n.p,{children:"Just a litle picture to remind us how a connection starts: we do a handshake with the service."}),"\n",(0,i.jsx)(n.p,{children:"Then we can start exchanging data.\nTypical API responses are at most ~50kb."}),"\n",(0,i.jsx)(n.p,{children:"But what if you want to warm a cache? How much can it be?\nIt can be a lot, around tens of megabytes.\nIn my example, we take 250mb."}),"\n",(0,i.jsx)(n.p,{children:"How does the server send such data?"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"img",src:t(6678).Z+"",width:"283",height:"142"})}),"\n",(0,i.jsx)(n.p,{children:"Slowly, packet by packet."}),"\n",(0,i.jsx)(n.p,{children:"The server tries to understand your throughput. The protocol itself rarely provides an accurate value of a packet size, so by relying on the imperical latency, it tunes the packet size little by little.\nIt needs to send a lot of packets to transfer a really big response."}),"\n",(0,i.jsx)(n.h3,{id:"3-ways-to-do-it",children:"3 Ways to do it"}),"\n",(0,i.jsx)(n.p,{children:"Below we will consider 3 approaches to solve this task.\nThere is no such thing as the only right solution; all of them are fine as long as you understand the costs and risks well enough, and we are gonna cover them."}),"\n",(0,i.jsx)(n.h3,{id:"first-brute-force-solution",children:"First, Brute Force solution."}),"\n",(0,i.jsx)(n.admonition,{type:"warning",children:(0,i.jsx)(n.p,{children:"If you want to reproduce an example make sure to untar server/json.tar.gz; it must contain the f.json file since GitHub has a limit of up to 100mb for a file."})}),"\n",(0,i.jsx)(n.p,{children:"You can imagine how the simplest Go HTTP client can implement it or just look at the code."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/dennypenta/http-response-lab/blob/543510947c0b19dbc0097adf403ae5cd6954c1cc/client/main.go",children:"Link"})}),"\n",(0,i.jsx)(n.p,{children:"The implementation is straight forward: it sends a request, gets a response, reads, marhsals it into a defined structure, holds it in the memory and ready to serve it further."}),"\n",(0,i.jsx)(n.p,{children:"And here is the pprof output:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"Showing nodes accounting for 229.48MB, 100% of 229.48MB total\n      flat  flat%   sum%        cum   cum%\n  229.48MB   100%   100%   229.48MB   100%  io.ReadAll\n         0     0%   100%   229.48MB   100%  main.main\n         0     0%   100%   229.48MB   100%  runtime.main\n"})}),"\n",(0,i.jsx)(n.p,{children:"Yes, it's not real win, with huge memory consumption, but it works ok."}),"\n",(0,i.jsx)(n.p,{children:"We see all the memory consumed on reading the HTTP stream."}),"\n",(0,i.jsxs)(n.p,{children:['Or you might say, "What a noob, you must use ',(0,i.jsx)(n.code,{children:"json.Decoder"}),'" so as to let the decoder work with the HTTP pipe closer.']}),"\n",(0,i.jsxs)(n.p,{children:["And it's pretty much the same, in my example, even worse.\n",(0,i.jsx)(n.a,{href:"https://github.com/dennypenta/http-response-lab/blob/b6ee7fcfd69fdffad844eb6a3d324d2fe3040985/client/main.go",children:"Link"})," to code with Decoder"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"Showing nodes accounting for 384MB, 100% of 384MB total\n      flat  flat%   sum%        cum   cum%\n     384MB   100%   100%      384MB   100%  encoding/json.(*Decoder).refill\n         0     0%   100%      384MB   100%  encoding/json.(*Decoder).Decode\n         0     0%   100%      384MB   100%  encoding/json.(*Decoder).readValue\n         0     0%   100%      384MB   100%  main.main\n         0     0%   100%      384MB   100%  runtime.main\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To recall why let's dig a little into the json/encoding library ",(0,i.jsx)(n.a,{href:"https://cs.opensource.google/go/go/+/refs/tags/go1.22.3:src/encoding/json/stream.go;l=49",children:"implementation"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func (dec *Decoder) Decode(v any) error {\n\tif dec.err != nil {\n\t\treturn dec.err\n\t}\n\n\tif err := dec.tokenPrepareForDecode(); err != nil {\n\t\treturn err\n\t}\n\n\tif !dec.tokenValueAllowed() {\n\t\treturn &SyntaxError{msg: "not at beginning of value", Offset: dec.InputOffset()}\n\t}\n\n\t// Read whole value into buffer.\n\tn, err := dec.readValue()\n\tif err != nil {\n\t\treturn err\n\t}\n\tdec.d.init(dec.buf[dec.scanp : dec.scanp+n])\n\tdec.scanp += n\n\n\t// Don\'t save err from unmarshal into dec.err:\n\t// the connection is still usable since we read a complete JSON\n\t// object from it before the error happened.\n\terr = dec.d.unmarshal(v)\n\n\t// fixup token streaming state\n\tdec.tokenValueEnd()\n\n\treturn err\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["It does exactly the same, it calls ",(0,i.jsx)(n.code,{children:"dec.readValue()"})," first to read all the response and then ",(0,i.jsx)(n.code,{children:"dec.d.unmarshal"})," to parse it."]}),"\n",(0,i.jsxs)(n.p,{children:["And it's ok; the reason is very simple: ",(0,i.jsx)(n.strong,{children:"encoding/json doesn't know the nature of your data."})]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Libraries like ",(0,i.jsx)(n.a,{href:"https://github.com/json-iterator/go",children:"json-iter"})," or ",(0,i.jsx)(n.a,{href:"https://github.com/mailru/easyjson",children:"easyjson"})," offer zero improvements in memory consumption."]})}),"\n",(0,i.jsx)(n.h3,{id:"second-decode-object-by-object",children:"Second, decode object by object."}),"\n",(0,i.jsxs)(n.p,{children:["Go json library provides a method of the Decoder called ",(0,i.jsx)(n.a,{href:"https://pkg.go.dev/encoding/json#Decoder.Token",children:(0,i.jsx)(n.code,{children:"Token"})})]}),"\n",(0,i.jsx)(n.p,{children:"This approach, parsing manually token by token, can give us an option to manually parse the json.\nA token might be every symbol, such as as open bracket, quote, key, value, etc.\nBut I found this approach quite complex. Having a deeply nested JSON object makes it very confusing to understand the relation for a given token. An solution could be to hold every key and designated level, but the decision gets worse with duplicated keys on a couple of levels."}),"\n",(0,i.jsx)(n.p,{children:"That's why I prefer another approach."}),"\n",(0,i.jsxs)(n.p,{children:['There is a well-known problem on LeetCode called "',(0,i.jsx)(n.a,{href:"https://leetcode.com/problems/valid-parentheses/description/",children:"Valid Parentheses"}),'"']}),"\n",(0,i.jsx)(n.p,{children:"We can simply read the beginning of a given object and the end, understanding when the last bracket of the object comes."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://github.com/dennypenta/http-response-lab/blob/b5890cbb74282416b5adacc92de95f18f7ee766f/client/main.go#L110",children:"Link"})}),"\n",(0,i.jsx)(n.p,{children:"pprof gives the following output"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"(pprof) top 5\nShowing nodes accounting for 68.56MB, 100% of 68.56MB total\nShowing top 5 nodes out of 10\n      flat  flat%   sum%        cum   cum%\n   27.55MB 40.18% 40.18%    68.56MB   100%  main.decode\n      20MB 29.17% 69.35%       20MB 29.17%  encoding/json.(*decodeState).literalStore\n      20MB 29.17% 98.52%       20MB 29.17%  bufio.NewReaderSize (inline)\n    1.01MB  1.48%   100%     1.01MB  1.48%  bufio.(*Scanner).Text (inline)\n         0     0%   100%       20MB 29.17%  encoding/json.(*decodeState).object\n"})}),"\n",(0,i.jsx)(n.p,{children:"Usually, the output varies between 65-80mb."}),"\n",(0,i.jsxs)(n.p,{children:["Such adventages is achieved due to marshalling the json ",(0,i.jsx)(n.strong,{children:"and"})," reading the HTTP response at the same time."]}),"\n",(0,i.jsx)(n.p,{children:"Let's get back to the introduction. Such a huge response gives us a stream of HTTP chunks we read step by step until the FIN message comes.\nWe can't make the HTTP server split every object in the response for us (probably we can, but it brings even more complexity).\nInstead, every given chunk window we can ask, \"Does it contain a valid json object?\""}),"\n",(0,i.jsxs)(n.p,{children:["As soon as a valid object has come, we can marshal it and continue reading the response further ",(0,i.jsx)(n.strong,{children:"until the next valid JSON object comes"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"third-the-simplest-data-compression",children:"Third, the simplest: data compression."}),"\n",(0,i.jsx)(n.p,{children:"It was new to me to discover that the most efficient solution will nott be related to the response handling."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"We simply must transfer as little data as we can."})}),"\n",(0,i.jsx)(n.p,{children:"JSON is not the only way to represent the data.\nIt's easy and human-readable, but sometimes we have to trade it."}),"\n",(0,i.jsx)(n.p,{children:"There are plenty of formats we can apply:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Avro"}),"\n",(0,i.jsx)(n.li,{children:"Tthrift"}),"\n",(0,i.jsx)(n.li,{children:"MessagePack"}),"\n",(0,i.jsx)(n.li,{children:"Gob (Go only)"}),"\n",(0,i.jsx)(n.li,{children:"Protobuf"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"And most likely more I don't even know."}),"\n",(0,i.jsx)(n.p,{children:"I tried replacing decoding to MessagePack and gave very litle result (zero _(\u30c4)_/)."}),"\n",(0,i.jsx)(n.p,{children:"The best outcome showed Protobuf."}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"We still use HTTP/1.1; we don't use gRPC transport."})}),"\n",(0,i.jsx)(n.p,{children:"The output from pprof is even better with less effort to implement.\nIt may vary up to 50mb sometimes."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"(pprof) top5\nShowing nodes accounting for 30.79MB, 100% of 30.79MB total\n      flat  flat%   sum%        cum   cum%\n   30.79MB   100%   100%    30.79MB   100%  io.ReadAll\n         0     0%   100%    30.79MB   100%  main.decode\n         0     0%   100%    30.79MB   100%  main.main\n         0     0%   100%    30.79MB   100%  runtime.main\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Here is the solution: ",(0,i.jsx)(n.a,{href:"https://github.com/dennypenta/http-response-lab/blob/main/client/main.go#L14",children:"Link"})]}),"\n",(0,i.jsx)(n.p,{children:"What we can say about Gob?"}),"\n",(0,i.jsx)(n.p,{children:"It offers very specific decoding and is a Go-only implementation, but it doesn't provide any benefit, here is the pprof output"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"(pprof) top5\nShowing nodes accounting for 70.81MB, 100% of 70.81MB total\nShowing top 5 nodes out of 20\n      flat  flat%   sum%        cum   cum%\n   30.53MB 43.12% 43.12%    30.53MB 43.12%  internal/saferio.ReadData\n   28.28MB 39.94% 83.05%    28.28MB 39.94%  reflect.growslice\n      12MB 16.95%   100%       12MB 16.95%  encoding/gob.decString\n         0     0%   100%    70.81MB   100%  encoding/gob.(*Decoder).Decode\n         0     0%   100%    70.81MB   100%  encoding/gob.(*Decoder).DecodeValue\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Perhaps for someone, having schemaless implementation is valuable, so here is the solution ",(0,i.jsx)(n.a,{href:"https://github.com/dennypenta/http-response-lab/blob/main/client/main.go#L40",children:"link"})]}),"\n",(0,i.jsx)(n.h3,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(n.p,{children:"I found 2 interesting ideas to me during the investigation."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"The best, or one of them, solution might be the most obvious, so obvious to one is not to everyone."}),"\n",(0,i.jsx)(n.li,{children:"It's not hard to implement and dig into fundamentals; some may win from engineering a new bicycle."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},4721:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"do-gamedev",title:"Backend Guy Ventures into Game Development",authors:["denis"],tags:["software"]},a=void 0,r={permalink:"/mynameis/blog/do-gamedev",source:"@site/blog/03-do-gamedev/index.mdx",title:"Backend Guy Ventures into Game Development",description:"In order to be engaged one explores different areas and looks for unknown software area.",date:"2024-09-02T18:32:54.000Z",formattedDate:"September 2, 2024",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"}],readingTime:6.53,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"do-gamedev",title:"Backend Guy Ventures into Game Development",authors:["denis"],tags:["software"]},unlisted:!1,prevItem:{title:"PaaS devlog |#0",permalink:"/mynameis/blog/tq-devlog-0"},nextItem:{title:"250mb json in a 40mb service limit",permalink:"/mynameis/blog/big-json"}},l={authorsImageUrls:[void 0]},d=[{value:"Why Gamedev?",id:"why-gamedev",level:4},{value:"Choosing the Game Engine",id:"choosing-the-game-engine",level:4},{value:"Unreal Engine: A Mixed Bag of Power and Complexity",id:"unreal-engine-a-mixed-bag-of-power-and-complexity",level:4},{value:"Unity: The Industry Standard.",id:"unity-the-industry-standard",level:4},{value:"Godot: Unknown creature in the Sea.",id:"godot-unknown-creature-in-the-sea",level:4},{value:"I want to finish simpler.",id:"i-want-to-finish-simpler",level:5},{value:"Lessons",id:"lessons",level:3}];function c(e){const n={h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"In order to be engaged one explores different areas and looks for unknown software area."}),"\n",(0,i.jsx)(n.p,{children:"Here we look at the gamedev in 2024 from experience in server side software."}),"\n",(0,i.jsx)(n.p,{children:"In software development, it's common to explore new domains to stay engaged.\nWhether it's for a change of pace or to push personal boundaries, exploring the unknown can lead to fancy adventures in software.\nThis page will share my journey as a backend developer diving into the game development in 2024."}),"\n",(0,i.jsx)(n.h4,{id:"why-gamedev",children:"Why Gamedev?"}),"\n",(0,i.jsx)(n.p,{children:"99% of programmes came here to make a game.\nEither did I."}),"\n",(0,i.jsx)(n.p,{children:"From a young age, I was captivated by two genres: strategy games and action RPGs.\nMy first PC came preloaded with classics like Red Alert 2, Heroes of Might and Magic 3, and Diablo 2.\nThe simple yet addictive gameplay\u2014click, move, destroy, enjoy \u2014 cemented my love for these genres.\nOver the years, I\u2019ve played many iconic RTS games like Warcraft 3 and Starcraft 2 (and still do occasionally).\nBut I realized that Starcraft 2 and similar games leaned more towards real-time execution rather than strategic depth."}),"\n",(0,i.jsx)(n.p,{children:"So I decided to make my own game with the strategy and decision making take the center stage."}),"\n",(0,i.jsx)(n.h4,{id:"choosing-the-game-engine",children:"Choosing the Game Engine"}),"\n",(0,i.jsx)(n.p,{children:"There are numerous options out there\u2014Defold, RPG Maker, GameMaker, Construct, to name a few."}),"\n",(0,i.jsx)(n.p,{children:"But I focused on the big three that are free to start with, offer extensive flexibility, and have been tested by major projects: Unreal Engine, Unity, and Godot."}),"\n",(0,i.jsx)(n.h4,{id:"unreal-engine-a-mixed-bag-of-power-and-complexity",children:"Unreal Engine: A Mixed Bag of Power and Complexity"}),"\n",(0,i.jsx)(n.p,{children:"I chose to start with Unreal Engine. It has a large community, though not the largest. Everything Unity offers in its asset store, Unreal has an equivalent. The engine supports C++ for low-level programming and Blueprints (a visual scripting language) for level design, though you can use either approach."}),"\n",(0,i.jsx)(n.p,{children:"Installing the engine is a hassle. You need to first install the Epic Games Launcher and then download the 55GB engine itself, which can be a chore if your disk space is limited."}),"\n",(0,i.jsx)(n.p,{children:"After setting up a blank project, I was impressed by the vast flexibility Unreal offers. You get all the benefits of C++\u2014dynamic dependency injection, custom components, and more.. But it adds complexity."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Compiliation time. It exists. Not just exists like a couple blinks 5-10 seconds, it takes a lot of time to build a single class to start using it in the project."}),"\n",(0,i.jsx)(n.li,{children:"Code complexity. Write header files, manual memory management. Good package manager doesn't exist in 2024, now I understand why they love Rust so much."}),"\n",(0,i.jsx)(n.li,{children:"Poor mac support. No comments, even the interface of top bar menu is different, I was struggling to find editor settings according to the documentation, and every question is like that."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"I would recommend such engine for people who likes waiting, c++ and want to make a beatiful scenes with nice action.\nI also have to note that engine is open source and owned by a technical guy and people who actually make games. I would stop there if I liked waiting and c++."}),"\n",(0,i.jsx)(n.h4,{id:"unity-the-industry-standard",children:"Unity: The Industry Standard."}),"\n",(0,i.jsx)(n.p,{children:"Next up was Unity, the most popular game engine out there.\nUnity has a vast ecosystem, with advanced features like rendering, post-processing, and easy shader creation.\nIt\u2019s backed by a huge asset store, which should theoretically make development easier.\nC# - Im not a big fun, but it's compilable, therefore type safe, seems good."}),"\n",(0,i.jsx)(n.p,{children:"A basic abstraction is an object. An object has compenents to manage what is it, it might be a script to move it, a mesh to render a tree, a colission not to pass through the tree, sound to play as tree leafs on the wind and so on.\nSeems quite simple."}),"\n",(0,i.jsx)(n.p,{children:"But when I approached a real problem there are plenty of weird things."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Unity has three different render pipelines, which aren\u2019t compatible with each other. The oldest one is being deprecated, meaning half the assets in the store may soon be obsolete."}),"\n",(0,i.jsx)(n.li,{children:"Asset store is a garbage. I tried several camera controllers, and only one partially met my needs. I had to patch it to double its functionality, which felt like reinventing the wheel."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"We all remember the Unity pricing drama. It has a closed-source codebase, and now there\u2019s a tracker that counts installations to generate more revenue for shareholders.\nThis has led to a lot of half-baked features and outdated documentation, which can make the engine feel unstable."}),"\n",(0,i.jsx)(n.p,{children:"Unity is still a solid choice, but in 2024, it feels like the engine is in a weird transitional state.\nThe documentation isn\u2019t as up-to-date as it should be, and the engine itself seems to be in a half-finished state.\nI might revisit it in 2025 when Unity 6 is released."}),"\n",(0,i.jsx)(n.h4,{id:"godot-unknown-creature-in-the-sea",children:"Godot: Unknown creature in the Sea."}),"\n",(0,i.jsx)(n.p,{children:"Finally, I turned to Godot, an engine I initially underestimated.\nKnown for its strong 2D capabilities, Godot seemed lacking in 3D support.\nIts physics engine was also rumored to be subpar."}),"\n",(0,i.jsx)(n.p,{children:"So I start doing a 3D.\nFirst I found that asset library is poor, camera controller only for Godot 3 (previous release) and it makes no sense to use Godot 3 in 2024."}),"\n",(0,i.jsx)(n.p,{children:"What I actually see in progress.\n0. Godot\u2019s installation bundle is just 150MB. It has a negligible memory footprint and can run smoothly even on modest hardware. Coming from Unity, this was a breath of fresh air."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Godot\u2019s editor can be extended in a similar manner to Unity, allowing you to add new UI elements and dynamically instantiate new components."}),"\n",(0,i.jsx)(n.li,{children:"The asset library isn\u2019t a store but a repository where everything is distributed for free. Since Godot is open-source, I doubt any significant part of it will go paid, unlike Unity and Unreal, where quality assets often come with a price tag."}),"\n",(0,i.jsx)(n.li,{children:"Physics engine implementation can be replaced with jolt easy-peasy and works very well."}),"\n",(0,i.jsx)(n.li,{children:"The same abstractions, the same component building, but not an object has component, rather a scene (actually a node) has nodes (the others to implement actual behavior of the node)."}),"\n",(0,i.jsx)(n.li,{children:"Exporting is just a button click. I managed to build a project for windows in Mac, it's so good, haven't had such smooth exprerience."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"It was surprisingly easy to understand the basics, the nodes design, the event bus system, for a backend guy it's perfect to start making a real game."}),"\n",(0,i.jsx)(n.p,{children:"GDScript can fail in runtime, not the best, but you can use C# for the sake of compilte time failure."}),"\n",(0,i.jsx)(n.p,{children:"And I know, the community is smaller, it will be developed slower, true. But I care about me today, not the community."}),"\n",(0,i.jsx)(n.p,{children:"I initially planned to give Unity a fair shot, spending a week with both engines.\nBut after just two days with Godot, I was progressing so much faster that I decided it wasn\u2019t worth the time to continue with Unity.\nGodot\u2019s lower entry barrier and faster development pace made it the clear choice for me."}),"\n",(0,i.jsx)(n.h5,{id:"i-want-to-finish-simpler",children:"I want to finish simpler."}),"\n",(0,i.jsx)(n.p,{children:"In the end, the best engine is the one that aligns with your needs and preferences.\nRemember, Blender was once considered a niche tool while everyone used 3D Max, and now Blender is the industry standard.\nFirebase was just a \u201cbase,\u201d and today we have Supabase, Pocketbase and many others."}),"\n",(0,i.jsx)(n.p,{children:"The landscape of game development is always changing.\nWhat matters most is finding the tool that helps you bring your vision to life, not what the industry standard is.\nFor me, that tool is Godot."}),"\n",(0,i.jsx)(n.h3,{id:"lessons",children:"Lessons"}),"\n",(0,i.jsx)(n.p,{children:"Spoiler, no, I didn't finish a game, I learned the gamedev abstractions and played with the engines a bit and I enjoyed it.\nAnd it's fine, I had good time and wish everyone to find a toy you can spend some time on and make you engaged."})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8826:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"tq-devlog-0",title:"PaaS devlog |#0",authors:["denis"],tags:["paas"]},a=void 0,r={permalink:"/mynameis/blog/tq-devlog-0",source:"@site/blog/04-tq-devlog-0/index.md",title:"PaaS devlog |#0",description:"Devlog #0: logging, linter, Zitadel, codegen, e2e tests",date:"2024-09-02T20:12:28.000Z",formattedDate:"September 2, 2024",tags:[{label:"paas",permalink:"/mynameis/blog/tags/paas"}],readingTime:8.43,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"tq-devlog-0",title:"PaaS devlog |#0",authors:["denis"],tags:["paas"]},unlisted:!1,prevItem:{title:"Web API Design: A Simplified Approach",permalink:"/mynameis/blog/api-design"},nextItem:{title:"Backend Guy Ventures into Game Development",permalink:"/mynameis/blog/do-gamedev"}},l={authorsImageUrls:[void 0]},d=[{value:"Devlog #0: logging, linter, Zitadel, codegen, e2e tests",id:"devlog-0-logging-linter-zitadel-codegen-e2e-tests",level:2},{value:"The problem",id:"the-problem",level:3},{value:"The planing",id:"the-planing",level:3},{value:"The ugly thing",id:"the-ugly-thing",level:3},{value:"Infra preparation",id:"infra-preparation",level:2},{value:"Logging and recovery",id:"logging-and-recovery",level:3},{value:"Linter",id:"linter",level:3},{value:"AuthZ",id:"authz",level:3},{value:"Generate api client",id:"generate-api-client",level:3},{value:"Defining e2e tests",id:"defining-e2e-tests",level:3},{value:"Bye",id:"bye",level:4}];function c(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components},{Details:s}=n;return s||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"devlog-0-logging-linter-zitadel-codegen-e2e-tests",children:"Devlog #0: logging, linter, Zitadel, codegen, e2e tests"}),"\n",(0,i.jsx)(n.p,{children:"Today I want to share with your my first steps of creating new project.\nFor a long time I've wanted created something cool, really meaninful, and after all I step into my idea: Platform as a service."}),"\n",(0,i.jsx)(n.p,{children:"The main tech stack has beeen defined: Go for a main backend, perhaps JavaScript for cdk integration.\nAll the infra will be used from a well known cloud providers (not aws ofc, no clue who can understand how to user it).\nFirst iteration will not such words as a frontend, ui, design. Ofc I want to make it, but only future history can judge me."}),"\n",(0,i.jsx)(n.h3,{id:"the-problem",children:"The problem"}),"\n",(0,i.jsxs)(n.p,{children:["The technical problem exists, it's fun to figure out.\nBut no the main one. The biggest fight Im gonna accept is ",(0,i.jsx)(n.strong,{children:"procrastination"}),". Im such a person who pushes further all the tasks very often. I just have little to do with time discipline. That's what will stop me from the progress.\nSo the easiest way to move progress away - do whatever, but not the progress."]}),"\n",(0,i.jsx)(n.h3,{id:"the-planing",children:"The planing"}),"\n",(0,i.jsxs)(n.p,{children:["So I decided to plan everything and understand how big the actual project is gonna be.\nSo I start speaking with GPT in order to express my mind, kinda talking to a duck.\nInstead of asking what I should do I explained my plan and asked to ask ",(0,i.jsx)(n.strong,{children:"more questions"})," so it could help me to clarify the technical solution and the plan."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"img",src:t(8323).Z+"",width:"817",height:"1036"})}),"\n",(0,i.jsxs)(s,{children:[(0,i.jsx)("summary",{children:(0,i.jsx)(n.p,{children:"Here you can find a prompt I used"})}),(0,i.jsx)(n.p,{children:"I want to develop a platform like digitalocean app, vercel, render, fly.io, heroku, etc. My value is the following: I give observability with 0 code changes, and a localdev opportunity with connecting to a cloud environment, for instance a request comes from a frontend app on staging to my backend app locally so I could intercept it and make my laptop appear kinda in the cloud. It's a multitenant project. There are 2 paths: kubernetes and a custom architecture. To build a custom architecture the app must be on a few virtual machines, a load balancer on top including firewall. The challenge: ask me necessary questions so we could make a right decision. I have to highlight, we build a users' environment, not the product architecture I will create in order to reproduce the given environment, so we need to decide that would fit me and users better."})]}),"\n",(0,i.jsx)(n.p,{children:"Initially I thought I will do it providing a user set of virtual machines connected under VPC, putting a load balancer on top, back to 2000. I thought it will make it cheaper and some tools just easier to implement."}),"\n",(0,i.jsxs)(n.p,{children:["Chatting to GPT I realized - Kubernetes will provide it a way quicker, most of the stuff is just ready to go like network policies, load balancing, SSL, deployment/rollback, health monitoring, resources observability, Istio adoption. Istio is very useful for observability and local first development, it became a new word today - ",(0,i.jsx)(n.strong,{children:"remocal"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"When stepped into the planning I decided to make it even longer.\nI wanted to researched all the kanban boards, unresistable.\nI used to use Trello and it was ok, but using api in power-ups boundaries sucks. Not really somethign I need right now though."}),"\n",(0,i.jsx)(n.p,{children:"I tried Cluckup, it's a laggish joke, even worse than Jira to make you feel you are already enterprise.\nI tried Asana and saw 0 difference with Trello, I spent about 2 minutes to confirm it and exist."}),"\n",(0,i.jsx)(n.h3,{id:"the-ugly-thing",children:"The ugly thing"}),"\n",(0,i.jsx)(n.p,{children:"In the end I found Linear.\nTo be fair it looked ugly, the design is equal to supabase: fonts, buttons."}),"\n",(0,i.jsx)(n.p,{children:"A few minutes later I started catching.\nKeyboard first design - that's what I buy."}),"\n",(0,i.jsx)(n.p,{children:"So I read Linear Method, the framework they apply internally. It was hard to accept it, I think older I get more conservatibe I become, but I dig it anyway.\nThe basic element is an issue. It might have sub-issues. And they might have.\nThey can be collected in a project."}),"\n",(0,i.jsx)(n.p,{children:"There are bunch of other staff I don't use, but I will share it below."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cycle"})," - like a sprint, hate it."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Triage"})," - inbox, it's a boss feature in my opinion, you can aggregate communication channels in a single place, then an on-call person can carry them, create issues or remove."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Initiative"})," - collection of the projects, they can be presented as a time line or a strategy decision, or even a roadmap on a timeline."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"As a result I cooked quite a few cards (48 projects in a backlog \ud83d\ude31\ufe0f\ufe0f\ufe0f\ufe0f\ufe0f\ufe0f)."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"img",src:t(4753).Z+"",width:"1632",height:"1121"})}),"\n",(0,i.jsx)(n.h2,{id:"infra-preparation",children:"Infra preparation"}),"\n",(0,i.jsx)(n.h3,{id:"logging-and-recovery",children:"Logging and recovery"}),"\n",(0,i.jsx)(n.p,{children:"I implemented a simple logging solution combined with a recovery middleware.\nI find logging panic behaviors essential, and instead of separating these middlewares, I combined them for simplicity."}),"\n",(0,i.jsx)(n.p,{children:"There are several ways to handle logging in Go applications:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Inject a logger into every struct"}),"\n",(0,i.jsx)(n.li,{children:"Define a global (singleton) logger"}),"\n",(0,i.jsxs)(n.li,{children:["Inject a logger into ",(0,i.jsx)(n.code,{children:"context.Context"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"I prefer the last approach"})," because it offers the flexibility to:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Add request IDs to log messages, useful when logging in the data layer"}),"\n",(0,i.jsx)(n.li,{children:"Attach additional data fields to the logger for use in middleware, e.g. computed properties in a business layer"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The implementation is straightforward, and you can find the code ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/log/log.go#L72",children:"here"})]}),"\n",(0,i.jsxs)(n.p,{children:["A couple of ",(0,i.jsx)(n.em,{children:"caveats"})," I encountered:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"There\u2019s a timestamp formatting issue in the slog package. It sometimes fails to format correctly, so I added a simple fix:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"if a.Value.Kind() == slog.KindTime {\n  t := a.Value.Time()\n  a.Value = slog.StringValue(t.Format(time.RFC3339))\n}\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"I wanted to adjust the log level based on the HTTP response status: log warnings for client errors (4xx) and errors for server errors (5xx):"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"logFunc := logger.DebugContext\nif resp.status >= 500 {\n  logFunc = logger.ErrorContext\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Finally, I added panic recovery and logged the error:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'defer func() {\n  if recovered := recover(); recovered != nil {\n    logger.ErrorContext(\n      r.Context(), "recovered from panic",\n      ...\n      "recovered", recovered,\n      "stack", string(debug.Stack()),\n    )\n    resp.WriteHeader(http.StatusInternalServerError)\n    if _, err := resp.Write([]byte("internal server error")); err != nil {\n      logger.ErrorContext(r.Context(), "failed to write response", "error", err)\n    }\n  }\n}()\n'})}),"\n",(0,i.jsx)(n.p,{children:"It\u2019s crucial to override the HTTP status during recovery, which is why I had to implement my own response writer."}),"\n",(0,i.jsx)(n.h3,{id:"linter",children:"Linter"}),"\n",(0,i.jsx)(n.p,{children:"I kept my linter setup as simple as possible.\nI don\u2019t use a complex configuration\u2014just a single command added to the Makefile:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.59.1\n"})}),"\n",(0,i.jsx)(n.h3,{id:"authz",children:"AuthZ"}),"\n",(0,i.jsx)(n.p,{children:"My goal was to define the simplest authentication solution, one that could be extended later to support role-based access control (RBAC)."}),"\n",(0,i.jsxs)(n.p,{children:["I considered a few options, including ",(0,i.jsx)(n.strong,{children:"Ory"})," and ",(0,i.jsx)(n.strong,{children:"Keycloak"}),", but both felt like overkill for my needs\u2014too complex and cumbersome.\nI wanted something:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Easy to configure"}),"\n",(0,i.jsx)(n.li,{children:"A single binary to allow self-hosting"}),"\n",(0,i.jsx)(n.li,{children:"With a simple, clear open-source license (like Apache 2.0)"}),"\n",(0,i.jsx)(n.li,{children:"Dependent only on PostgreSQL"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["I initially looked at ",(0,i.jsx)(n.strong,{children:"Logto"}),", a fresh new solution that seemed simple and clean.\nHowever, it felt geared more toward frontend developers rather than backend engineers, and lacked some of the features I needed."]}),"\n",(0,i.jsxs)(n.p,{children:["That\u2019s when I found ",(0,i.jsx)(n.strong,{children:"Zitadel"}),".\nCreated by some of the folks behind Ory, ",(0,i.jsx)(n.strong,{children:"Zitadel"})," has strong security foundations.\nSince I\u2019m building only a backend API, I focused on authZ, using token introspection (i.e., validation), rather than issuing tokens."]}),"\n",(0,i.jsx)(n.p,{children:"It was straightforward to create a service account token for my e2e tests to check the authorization middleware."}),"\n",(0,i.jsx)(n.p,{children:"I also verified that configuring RBAC and identity brokering with providers like Google and GitHub wouldn\u2019t be an issue (i.e., \u201cSign in with Google\u201d)."}),"\n",(0,i.jsx)(n.h3,{id:"generate-api-client",children:"Generate api client"}),"\n",(0,i.jsxs)(n.p,{children:["As I explain in my API design ",(0,i.jsx)(n.a,{href:"https://dennypenta.github.io/mynameis/blog/api-design",children:"page"})," one of the benefits I want to achieve is easy API client generation for multiple languages.\nThe first language, naturally, is Go, as I need it for my e2e tests.\nSince the implementation will change frequently, I\u2019m skipping unit tests for now and focusing on e2e tests to ensure the app\u2019s overall stability."]}),"\n",(0,i.jsx)(n.p,{children:"The client generation involves:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Collecting ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/router.go#L124",children:"API definition"})," from the router (models, routes)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/gen/client.go#L35",children:"Building"})," the data from the definitions to use in the client generation."]}),"\n",(0,i.jsxs)(n.li,{children:["Feeding that data into a ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/gen/templates/client.tpl#L1",children:"template"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The result is a generated Go ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/client/client.go#L11",children:"client"}),". I can easily add other templates later, such as for TypeScript, and use them in my tests."]}),"\n",(0,i.jsx)(n.h3,{id:"defining-e2e-tests",children:"Defining e2e tests"}),"\n",(0,i.jsx)(n.p,{children:"With the generated client, I can now define the simplest setup for my e2e tests."}),"\n",(0,i.jsx)(n.p,{children:"First, I created a Docker image and a Docker Compose setup.\nThese are similar to a regular production environment but with a few additional tricks."}),"\n",(0,i.jsxs)(n.p,{children:["My ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/Dockerfile#L15",children:"Dockerfile"})," includes an extra ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/build/building/multi-stage/#stop-at-a-specific-build-stage",children:"target"})," to run a debugger in the tests:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'FROM builder AS dev\n\n# Install Delve (debugger)\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go install github.com/go-delve/delve/cmd/dlv@v1.23.0\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go build -gcflags=all="-N -l" -o server ./cmd/server\n\nCMD ["dlv", "--listen=:40000", "--continue", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "server"]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Next, I updated my ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/docker-compose.e2e.yaml#L19",children:"Docker Compose"})," file to expose the debugger port and allow clients to attach:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"server:\n  build:\n    context: .\n    dockerfile: Dockerfile\n    target: dev\n  ports:\n    - '8000:8000'\n    - '40000:40000'\n  security_opt:\n    - seccomp:unconfined\n  cap_add:\n    - SYS_PTRACE\n  env_file:\n    e2e.env\n  depends_on:\n    postgrese2e:\n      condition: service_healthy\n  restart: always\n"})}),"\n",(0,i.jsx)(n.p,{children:"I also created a dedicated PostgreSQL instance for e2e tests to keep it separate from my local development environment:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'  postgrese2e:\n    image: postgres:16.3\n    restart: always\n    environment:\n      POSTGRES_HOST_AUTH_METHOD: \'trust\'\n      POSTGRES_DB: tq\n    ports:\n      - "5432:5432"\n    tmpfs:\n      - /var/lib/postgresql/data\n    healthcheck:\n      test: ["CMD-SHELL", "pg_isready -U postgres -d tq"]\n      interval: 3s\n      timeout: 3s\n      retries: 10\n'})}),"\n",(0,i.jsx)(n.p,{children:"Finally, I defined a simple Makefile command to run the tests:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"start-e2e-test-env:\n\tdocker-compose -f docker-compose.e2e.yaml up -d --build\n\t@echo \"Checking e2e test environment is running...\"\n\tuntil $$(curl --output /dev/null --silent --fail http://localhost:8000/healthz); do printf '.'; sleep 1; done && echo \"Service Ready!\"\n\techo 'Service has been started'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"curl"})," loop waits for the service to be ready since the app depends on the database connection, and migrations need to be applied.\nThis kind of delay is common \u2014 you can imagine even more delays due to cache warming, downstream API fetching, etc."]}),"\n",(0,i.jsx)(n.h4,{id:"bye",children:"Bye"}),"\n",(0,i.jsx)(n.p,{children:"Thank you for reading, come here and see what's gonna be in the end."}),"\n",(0,i.jsxs)(n.p,{children:["Repository is here: ",(0,i.jsx)(n.a,{href:"http://github.com/treenq/treenq",children:"http://github.com/treenq/treenq"})]})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},2485:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"api-design",title:"Web API Design: A Simplified Approach",authors:["denis"],tags:["software"]},a=void 0,r={permalink:"/mynameis/blog/api-design",source:"@site/blog/05-api-design/index.mdx",title:"Web API Design: A Simplified Approach",description:"Note: This page won\u2019t teach you how to design an API from scratch, but it will give you insights into how I recently designed one while developing my PaaS.",date:"2024-09-19T20:45:05.000Z",formattedDate:"September 19, 2024",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"}],readingTime:6.06,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"api-design",title:"Web API Design: A Simplified Approach",authors:["denis"],tags:["software"]},unlisted:!1,prevItem:{title:"Unit test in observability",permalink:"/mynameis/blog/unit-test-observability"},nextItem:{title:"PaaS devlog |#0",permalink:"/mynameis/blog/tq-devlog-0"}},l={authorsImageUrls:[void 0]},d=[{value:"Preface",id:"preface",level:2},{value:"The gRPC Shift",id:"the-grpc-shift",level:2},{value:"Bringing gRPC Ideas to the Web",id:"bringing-grpc-ideas-to-the-web",level:2},{value:"My API Design Principles",id:"my-api-design-principles",level:2},{value:"What Does This Achieve?",id:"what-does-this-achieve",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Example Error Response",id:"example-error-response",level:3},{value:"Error Handling in API Handlers",id:"error-handling-in-api-handlers",level:3},{value:"Example from My Application",id:"example-from-my-application",level:3},{value:"Why Use a Custom Error Type?",id:"why-use-a-custom-error-type",level:2},{value:"Epiloge",id:"epiloge",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note"}),": This page won\u2019t teach you how to design an API from scratch, but it will give you insights into how I recently designed one while developing my ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq",children:"PaaS"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"preface",children:"Preface"}),"\n",(0,i.jsx)(n.p,{children:"Feel free to skip to the next section if you want to avoid the backstory."}),"\n",(0,i.jsx)(n.p,{children:"After working with various communication protocols (e.g., web form-data, REST, JSON-RPC 2.0), I\u2019ve realized that many of them aim to cover a wide range of use cases. This broad focus introduces a lot of complexity:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Network implementations require special handling, such as decoding domain-level errors into transport error codes and messages."}),"\n",(0,i.jsx)(n.li,{children:"Encoding and decoding messages require marshalling domain models into protocol-specific formats."}),"\n",(0,i.jsx)(n.li,{children:"Protocols like REST involve lengthy discussions about naming conventions and URL structures."}),"\n",(0,i.jsx)(n.li,{children:"Some protocols, like JSON-RPC, demand custom solutions, such as middleware for handling requests."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"These factors complicate implementations and slow down team agreements."}),"\n",(0,i.jsx)(n.h2,{id:"the-grpc-shift",children:"The gRPC Shift"}),"\n",(0,i.jsx)(n.p,{children:"When I started working with gRPC, it introduced some important improvements:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Models are generated automatically."}),"\n",(0,i.jsx)(n.li,{children:"Service interfaces are provided and generated."}),"\n",(0,i.jsx)(n.li,{children:"Clients are generated, allowing you to focus on just creating requests."}),"\n",(0,i.jsx)(n.li,{children:"Error codes are simplified, reducing them from hundreds to around 15 (which is still more than needed, but we\u2019ll get to that)."}),"\n",(0,i.jsxs)(n.li,{children:["The error format is predefined, so you don\u2019t have to design it\u2014just reuse ",(0,i.jsx)(n.a,{href:"https://cloud.google.com/apis/design/errors",children:"the model"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"And I liked. I don't know who didn't."}),"\n",(0,i.jsx)(n.p,{children:"I loved it. Most people who use gRPC feel the same.\nHowever, gRPC doesn\u2019t naturally align with web browsers due to its reliance on HTTP/2, often necessitating additional layers to adapt to HTTP/1.1.\nStill, browser compatibility remains a common requirement."}),"\n",(0,i.jsx)(n.h2,{id:"bringing-grpc-ideas-to-the-web",children:"Bringing gRPC Ideas to the Web"}),"\n",(0,i.jsxs)(n.p,{children:["This made me think: what can we adopt from gRPC for web APIs? The most obvious feature is ",(0,i.jsx)(n.strong,{children:"code generation"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Swagger attempts client generation but introduces its own challenges:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:'Swagger has too many plugins, requires specific formats, and its "standard" is fragmented. Many web renderers are incompatible with each other. For example, Apiary\u2019s requirements may contradict code generation.'}),"\n",(0,i.jsx)(n.li,{children:"Swagger focuses on defining documentation instead of the API itself, adding complexity."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The I discovered ",(0,i.jsx)(n.a,{href:"https://trpc.io/docs/quickstart",children:"tRPC"}),", which offered many things I\u2019d been hoping for\u2014network handling as a natural consequence of defining models.\nThe catch? It\u2019s limited to JavaScript."]}),"\n",(0,i.jsx)(n.p,{children:"So, I decided to design my own API approach."}),"\n",(0,i.jsx)(n.h2,{id:"my-api-design-principles",children:"My API Design Principles"}),"\n",(0,i.jsx)(n.p,{children:"Here are the guiding principles I followed:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"It must be built on top of HTTP to support the web."}),"\n",(0,i.jsxs)(n.li,{children:["No URL queries, forms, or arguments in the path\u2014these overcomplicate things. Most people don\u2019t even know that URL queries are essentially ",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Multimap",children:"multimaps"}),", which leads to more bugs."]}),"\n",(0,i.jsx)(n.li,{children:"Every API call uses only POST. The payload is always in the body, and for simplicity, in my case, it\u2019s JSON."}),"\n",(0,i.jsxs)(n.li,{children:["The procedure naming follows the same conventions we use in code. For instance, instead of REST\u2019s ",(0,i.jsx)(n.code,{children:"/users/{id}/wallet"}),", I use ",(0,i.jsx)(n.code,{children:"/getUserWallet"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"what-does-this-achieve",children:"What Does This Achieve?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"I only define the models I need \u2014 no extra complexity."}),"\n",(0,i.jsx)(n.li,{children:"Optionally, I can add descriptions to make the generated documentation more talkative."}),"\n",(0,i.jsx)(n.li,{children:"From the defined router, I can generate both the client code and the API specification (including Swagger)."}),"\n",(0,i.jsx)(n.li,{children:"The code generation process is simplified: a single - word URL, consistent HTTP method, and uniform marshalling strategy make everything easy to implement and maintain."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.p,{children:"Error handling is a crucial part of any API design, and the model needs to be flexible enough to cover a wide range of scenarios.\nBased on my experience, a simple yet effective error model looks like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type Error struct {\n  Code    string\n  Message string\n  Meta    map[string]any\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Code"}),": This holds a unique value that identifies the specific issue.\nIt helps narrow down the location of the problem in the code and quickly leads developers to the exact line or area where the error occurred. Additionally, it provides clear guidance to users about the expected behavior or how to resolve the issue."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Message"}),": The message field can serve a dual purpose:","\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"UserMessage"}),": This is a user-friendly message that can be translated into different languages on the server side. It's meant to be shown in the user interface to guide the user."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"DevMessage"}),": This contains a technical explanation intended for developers or logs. It explains what went wrong, why it happened, and what actions can be taken to resolve it.\nWhile you could use a single string for both, in complex applications with internationalization (i18n) needs, separating them into two distinct lines would help."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Meta"}),": This is a flexible map that can contain any additional context or metadata about the error. For example, if you're validating a form with multiple fields, the Meta map can list which fields failed validation and why."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"example-error-response",children:"Example Error Response"}),"\n",(0,i.jsx)(n.p,{children:"Here\u2019s an example of how this error model might be used in a real-world scenario. Suppose a user submits a tax form with several invalid fields. The API can return an error response like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'Error{\n  Code: "TAX_FORM_INVALID",\n  Meta: map[string]any{\n    "tax_class": "expected a number between 1 and 4",\n    "house_number": "must be a number",\n  }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"In this example:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.strong,{children:"Code"})," is ",(0,i.jsx)(n.code,{children:'"TAX_FORM_INVALID"'}),", which indicates a validation failure specific to the tax form."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.strong,{children:"Meta"})," map provides detailed feedback on specific fields (",(0,i.jsx)(n.code,{children:"tax_class"}),", ",(0,i.jsx)(n.code,{children:"house_number"}),") that need attention, making it easier for the user to correct their input."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"error-handling-in-api-handlers",children:"Error Handling in API Handlers"}),"\n",(0,i.jsx)(n.p,{children:"In my API, the handler interface is designed to consistently return errors using this model.\nThis ensures that all errors adhere to a common structure, simplifying error handling on both the client and server side."}),"\n",(0,i.jsx)(n.p,{children:"For instance, a typical API handler might look like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"GetProfile(ctx context.Context, _ struct{}) (GetProfileResponse, *Error)\n"})}),"\n",(0,i.jsx)(n.p,{children:"Here, instead of returning a plain error, the handler returns a pointer to the *Error type.\nThis approach ensures that any error returned strictly follows the predefined error format."}),"\n",(0,i.jsx)(n.h3,{id:"example-from-my-application",children:"Example from My Application"}),"\n",(0,i.jsx)(n.p,{children:"Here\u2019s a practical example of how I\u2019ve implemented this in my app:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'package domain\n\nimport (\n    "context"\n    "github.com/treenq/treenq/pkg/vel"\n)\n\ntype GetProfileResponse struct {\n    Email    string `json:"email"`\n    Username string `json:"username"`\n    Name     string `json:"name"`\n}\n\nfunc (h *Handler) GetProfile(ctx context.Context, _ struct{}) (GetProfileResponse, *vel.Error) {\n    profile := h.authProfiler.GetProfile(ctx)\n    return GetProfileResponse{\n        Email:    profile.Email,\n        Username: profile.Username,\n        Name:     profile.Name,\n    }, nil\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"In this code:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"GetProfile"})," function fetches the user profile and returns it as a ",(0,i.jsx)(n.code,{children:"GetProfileResponse"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The second return value is ",(0,i.jsx)(n.code,{children:"*Error"})," instead of a generic ",(0,i.jsx)(n.code,{children:"error"}),", making it clear that the function follows the structured error format."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"why-use-a-custom-error-type",children:"Why Use a Custom Error Type?"}),"\n",(0,i.jsxs)(n.p,{children:["By using a custom ",(0,i.jsx)(n.code,{children:"Error"})," type instead of the standard ",(0,i.jsx)(n.code,{children:"error"}),", we enforce consistency across the API.\nThe error itself still implements Go\u2019s built-in ",(0,i.jsx)(n.code,{children:"error"})," interface, allowing it to work seamlessly with existing Go error-handling patterns.\nHowever, the benefit is that every error now carries additional structured information, like the error code and metadata, making it easier to debug and handle errors programmatically."]}),"\n",(0,i.jsx)(n.h2,{id:"epiloge",children:"Epiloge"}),"\n",(0,i.jsx)(n.p,{children:'I ended up building a "framework" in Go on top of net/http that is able to generate clients for any language.'}),"\n",(0,i.jsxs)(n.p,{children:["You can check it out ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/main/pkg/vel/router.go",children:"here"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"I don\u2019t recommend using it as-is \u2014 it\u2019s better to copy and adapt it for your own needs."})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},3218:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"unit-test-observability",title:"Unit test in observability",authors:["denis"],tags:["software"]},a=void 0,r={permalink:"/mynameis/blog/unit-test-observability",source:"@site/blog/06-unit-test-observability/index.md",title:"Unit test in observability",description:"On this page, I want to cover the caveats I encountered while shaping my approach to unit testing in the context of observability.",date:"2024-10-06T21:43:35.000Z",formattedDate:"October 6, 2024",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"}],readingTime:4.535,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"unit-test-observability",title:"Unit test in observability",authors:["denis"],tags:["software"]},unlisted:!1,prevItem:{title:"Go Dockerfile",permalink:"/mynameis/blog/go-dockerfile"},nextItem:{title:"Web API Design: A Simplified Approach",permalink:"/mynameis/blog/api-design"}},l={authorsImageUrls:[void 0]},d=[{value:"Regular Unit Test",id:"regular-unit-test",level:2},{value:"Side Effects",id:"side-effects",level:2},{value:"Sustainability",id:"sustainability",level:2},{value:"Is It Worth It?",id:"is-it-worth-it",level:2},{value:"A Better Approach",id:"a-better-approach",level:2},{value:"Nop Logger",id:"nop-logger",level:4},{value:"Isolation",id:"isolation",level:4}];function c(e){const n={code:"code",em:"em",h2:"h2",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"On this page, I want to cover the caveats I encountered while shaping my approach to unit testing in the context of observability."}),"\n",(0,i.jsx)(n.p,{children:"It's important to clarify that I\u2019m not referring to testing logs or metrics delivery.\nInstead, I want to focus on testing modules that perform business logic but also include observability calls, like loggers or meters."}),"\n",(0,i.jsx)(n.h2,{id:"regular-unit-test",children:"Regular Unit Test"}),"\n",(0,i.jsx)(n.p,{children:"Let\u2019s start with a typical example of a unit test containing a logger call."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"func (s *service) Do(ctx context.Context, request model.Object) (model.Response, error) {\n\tres, err := s.repo.Do(ctx, request)\n\tif err != nil {\n\t\treturn res, err\n\t}\n\n\treturn res, nil\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"With a straightforward approach, you'd mock the repository and verify in a unit test that the mock was called with the expected parameters."}),"\n",(0,i.jsx)(n.p,{children:"This is the conventional way of handling things."}),"\n",(0,i.jsx)(n.h2,{id:"side-effects",children:"Side Effects"}),"\n",(0,i.jsx)(n.p,{children:"Now, let\u2019s complicate the example by adding a logger."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func (s *service) Do(ctx context.Context, request model.Object) (model.Response, error) {\n  err := s.notImportantRepo.Something(ctx, another.Model(request))\n  if err != nil {\n    s.log.Error("can\'t do something", "err", err.Error())\n  }\n\n\treturn nil\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Following the same approach, we can mock both dependencies. Here's how the mock preparation might look:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'notImportantRepoErr := errors.New("err")\nnotImportantRepo.On("Something", req).Return(notImportantRepoErr)\nlog.On("Error", mock.Anything, "err", notImportantRepoErr.Error())\n'})}),"\n",(0,i.jsx)(n.p,{children:"If we make the logger call more realistic, extracting all the values we need for emergency debugging, we end up with this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'s.log.Error("can\'t do something", "err", err.Error(), "ctx", logging.FromContext(ctx), "another", mapper.From(req))\n'})}),"\n",(0,i.jsx)(n.p,{children:"At this point, engineers often use mock.Anything for the logger parameters:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'log.On("Error", mock.Anything...)\n'})}),"\n",(0,i.jsx)(n.p,{children:"This leads to a couple of issues:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The logger call becomes a side effect that doesn\u2019t affect the result being tested."}),"\n",(0,i.jsx)(n.li,{children:"Nobody bothers to test what's actually logged."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"sustainability",children:"Sustainability"}),"\n",(0,i.jsx)(n.p,{children:"Real-world software isn\u2019t always as clean as in theory, raising a few important questions."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"1."})," Does this approach improve the ",(0,i.jsx)(n.strong,{children:"quality"})," of logging?"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:'In some ways, yes.\nAt least we confirm that a log message with the correct severity level was sent.\nHowever, ensuring that the necessary parameters are logged requires strict discipline, which isn\u2019t always feasible.\nWe can\u2019t "fix people."'}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"2."})," Does it ",(0,i.jsx)(n.strong,{children:"reduce PRs"})," focused solely on improving logging?"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Sadly, no.\nThere's no validation of the parameters being logged, their mapping, formatting, or even the actual log message."}),"\n",(0,i.jsx)(n.p,{children:'Often, only in production do we realize, "Oh, it\'s missing field X." After another debugging round, we might say, "Oh, it\'s missing field Z." This cycle continues.'}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"3."})," Does it help deliver more ",(0,i.jsx)(n.strong,{children:"observable software"}),"?"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This is tricky.\nWhile it might seem like a yes (if we answer question 1), the lack of validation means we\u2019re still prone to errors.\nThe absence of data model testing only slows down software delivery."}),"\n",(0,i.jsx)(n.p,{children:"Every time an engineer touches the function, they might copy a mock from a previous test.\nIf the function behaves differently, they\u2019ll see a failed unit test like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'assert: mock: I don\'t know what to return because the method call was unexpected.\n  Either do Mock.On("Error").Return(...) first, or remove the Error() call.\n  This method was unexpected:\n    Error(params)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Then, they\u2019ll blindly copy the previous mock statement, and the test will pass\u2014despite the logger parameters being completely different."}),"\n",(0,i.jsx)(n.h2,{id:"is-it-worth-it",children:"Is It Worth It?"}),"\n",(0,i.jsx)(n.p,{children:"Here\u2019s my evaluation:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Patching takes more time because of the added mock statements."}),"\n",(0,i.jsx)(n.li,{children:"More CI failures occur due to forgotten mocks."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"All these costs offer no real benefit.\nWe only confirm that the log was called.\nBut for all we know, we might have sent nil to the logger and won\u2019t realize it until an emergency."}),"\n",(0,i.jsx)(n.h2,{id:"a-better-approach",children:"A Better Approach"}),"\n",(0,i.jsx)(n.p,{children:"There are two paths to improve this situation:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Never allow loggers to accept mock.Anything."}),"\n",(0,i.jsx)(n.li,{children:"Don\u2019t test loggers in the business layer."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The first option is ideal but impractical unless you have years to experiment with uncertain payoffs."}),"\n",(0,i.jsx)(n.p,{children:"The second option is more radical but effective: don\u2019t mix observability tests with business logic.\nLet me explain in two steps."}),"\n",(0,i.jsx)(n.h4,{id:"nop-logger",children:"Nop Logger"}),"\n",(0,i.jsx)(n.p,{children:"Start by defining the logger mock as a no-op and remove it from the mocks preparation.\nYou can use one of the following loggers for unit tests:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"An empty value logger"}),"\n",(0,i.jsx)(n.li,{children:"A package-defined nop logger"}),"\n",(0,i.jsx)(n.li,{children:"A mock logger with no assertions"}),"\n",(0,i.jsx)(n.li,{children:"A logger that writes to io.Discard (no impact on unit test output)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Any of these options will ignore logger calls and simplify development."}),"\n",(0,i.jsxs)(n.p,{children:["You can apply the same approach to other observability components.\nFor example, ",(0,i.jsx)(n.em,{children:"OpenTelemetry"})," provides ",(0,i.jsx)(n.code,{children:'"go.opentelemetry.io/otel/metric/noop"'})," to create an empty counter or meter."]}),"\n",(0,i.jsx)(n.h4,{id:"isolation",children:"Isolation"}),"\n",(0,i.jsx)(n.p,{children:"Finally, I\u2019m not suggesting we skip logging tests entirely."}),"\n",(0,i.jsxs)(n.p,{children:["We should still test them, but in ",(0,i.jsx)(n.strong,{children:"isolation"})," rather than as a side effect.\nHere\u2019s how:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'\tfor _, tt := range []testCase{\n\t\t{\n\t\t\tname: "regular log",\n\t\t\thandler: http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n\t\t\t\tLoggerFromContext(r.Context()).ErrorContext(r.Context(), "test", "arg1", "text")\n\t\t\t\tw.WriteHeader(200)\n\t\t\t}),\n\t\t\texpectedLogFunc: func(t *testing.T, m map[string]string) {\n\t\t\t\tt.Helper()\n\t\t\t\tassert.Equal(t, "ERROR", m["level"])\n        ...\n\t\t\t},\n\t\t\texpectedStatus: 200,\n\t\t},\n\t} {\n\t\tt.Run(tt.name, func(t *testing.T) {\n\t\t\tbuf := bytes.NewBuffer(nil)\n\t\t\tl := NewLogger(buf, slog.LevelInfo)\n\t\t\tm := NewLoggingMiddleware(l)\n\t\t\th := m(tt.handler)\n\n\t\t\tw := httptest.NewRecorder()\n\t\t\th.ServeHTTP(w, httptest.NewRequest("POST", "/", nil))\n\n\t\t\tres := buf.String()\n\t\t\tjsonRes := make(map[string]string)\n\t\t\terr := json.Unmarshal([]byte(res), &jsonRes)\n\t\t\trequire.NoError(t, err)\n\n\t\t\ttt.expectedLogFunc(t, jsonRes)\n\n\t\t\tassert.Equal(t, tt.expectedStatus, w.Code)\n\t\t})\n\t}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Instead of writing to stderr/stdout, substitute the logger\u2019s writer with bytes.Buffer, allowing you to capture and validate the exact log message."}),"\n",(0,i.jsx)(n.p,{children:"This way, we\u2019re testing the logger implementation itself, not the side effect of a function that has little to no impact on the application's core functionality."})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},6218:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"go-dockerfile",title:"Go Dockerfile",authors:["denis"],tags:["software","go"]},a=void 0,r={permalink:"/mynameis/blog/go-dockerfile",source:"@site/blog/07-go-dockerfile/index.mdx",title:"Go Dockerfile",description:"The things I've collected to write my best Dockerfile. Appreciate any comments mentioning I could do it better and more optimal.",date:"2025-01-21T20:11:35.000Z",formattedDate:"January 21, 2025",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"},{label:"go",permalink:"/mynameis/blog/tags/go"}],readingTime:6.63,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"go-dockerfile",title:"Go Dockerfile",authors:["denis"],tags:["software","go"]},unlisted:!1,prevItem:{title:"gopls: how your IDE becomes better every day",permalink:"/mynameis/blog/gopls-08"},nextItem:{title:"Unit test in observability",permalink:"/mynameis/blog/unit-test-observability"}},l={authorsImageUrls:[void 0]},d=[{value:"Preface",id:"preface",level:2},{value:"Base image",id:"base-image",level:2},{value:"Dependencies",id:"dependencies",level:2},{value:"Targets",id:"targets",level:2},{value:"Build prod",id:"build-prod",level:2},{value:"Run prod",id:"run-prod",level:2},{value:"Target dependenciy graph",id:"target-dependenciy-graph",level:2},{value:"A few caveats on debugging remote DAP.",id:"a-few-caveats-on-debugging-remote-dap",level:2},{value:"Conclusion",id:"conclusion",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"The things I've collected to write my best Dockerfile. Appreciate any comments mentioning I could do it better and more optimal."}),"\n",(0,i.jsx)(n.h2,{id:"preface",children:"Preface"}),"\n",(0,i.jsx)(n.p,{children:"TLDR:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:'FROM golang:1.23.1-alpine AS builder\n\nWORKDIR /app\n\nENV CGO_ENABLED=0 \nENV GOOS=linux\n\nCOPY go.mod go.mod\nCOPY go.sum go.sum\nRUN --mount=type=cache,target=/go/pkg/mod/ go mod download -x\n\nCOPY . .\n\nFROM builder AS dev\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go install github.com/go-delve/delve/cmd/dlv@v1.23.0\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go build -gcflags=all="-N -l" -o server ./cmd/server\n\nCMD ["dlv", "--listen=:40000", "--continue", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "server"]\n\nFROM builder AS prod\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go build -ldflags "-s -w" -o server ./cmd/server\n\nFROM alpine:3.13\n\nRUN addgroup -g 1001 appgroup && adduser -D -G appgroup -u 1001 appuser\n\nWORKDIR /app\n\nUSER 1001\n\nCOPY --from=prod /app/server server\n\nCMD ["/app/server"]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Link: ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/98e6d8dd5f5756fe5df561913e10515784ef7163/Dockerfile",children:"https://github.com/treenq/treenq/blob/98e6d8dd5f5756fe5df561913e10515784ef7163/Dockerfile"})]}),"\n",(0,i.jsx)(n.p,{children:"Now let's breakdown what's happening here and why."}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{}),(0,i.jsxs)(n.p,{children:["I use colima and all the things described here work well. However, all the docs referenses will go to docker. I think they did a great job to push the industry standart. Also you have to turn on buildx to make these features work. It requires buildx installation and setting a feature flag ",(0,i.jsx)(n.code,{children:"DOCKER_BUILDKIT=1"}),"."]})]}),"\n",(0,i.jsx)(n.h2,{id:"base-image",children:"Base image"}),"\n",(0,i.jsx)(n.p,{children:"First, we need a base image in order to build the app. We want the base being less as possible, for that purpose I use alpine:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:"FROM golang:1.23.1-alpine AS builder\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You also can consider ",(0,i.jsx)(n.a,{href:"https://github.com/GoogleContainerTools/distroless",children:"distroless"}),", it's very suitable for interpreted languages like python/nodejs, but alpine works well for Go."]}),"\n",(0,i.jsx)(n.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,i.jsx)(n.p,{children:"The next step we prepare a surface to build the image, all the necessary dependencies we install there."}),"\n",(0,i.jsx)(n.p,{children:"If you need specific timezones, certificates, github private repo creds, the service modules, whatever, we do it right here."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:"COPY go.mod go.mod\nCOPY go.sum go.sum\nRUN --mount=type=cache,target=/go/pkg/mod/ go mod download -x\n"})}),"\n",(0,i.jsx)(n.p,{children:"We must copy only desegnated dependencies definition and right after download them.\nIf you don't know why and what is docker layers please refer to Docker basics and get back."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"-x"})," Flag is kinda adds verbosity showing what ",(0,i.jsx)(n.code,{children:"go mod download"})," executes."]}),"\n",(0,i.jsxs)(n.p,{children:["The interesting details here is ",(0,i.jsx)(n.code,{children:"--mount=type=cache"}),".\nYou can find more in the ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/reference/dockerfile/#run---mounttypecache",children:"reference"})]}),"\n",(0,i.jsxs)(n.p,{children:["If you update a dependency in your ",(0,i.jsx)(n.code,{children:"go.mod"})," and rebuild it, then this statement will not download all the packages from scratch, it creates a designated mount and hold them in one place."]}),"\n",(0,i.jsx)(n.p,{children:"Unfortunately, most of the CI systems create a new image for a new job and it doesn't work in CI, but helps a lot for local testing. For instance, I run e2e tests locally and it saves a couple of minutes every try."}),"\n",(0,i.jsx)(n.p,{children:"And only then we copy the rest of the codebase:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:"COPY . .\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{}),(0,i.jsx)(n.p,{children:"Don't forget to check your dockerignore to skip copying useless files."})]}),"\n",(0,i.jsx)(n.h2,{id:"targets",children:"Targets"}),"\n",(0,i.jsx)(n.p,{children:"You must have heard about multi-stage images.\nAnd you have built the dockerfiles with 2 stages, first to build a binary and the next to run it in a blank environment."}),"\n",(0,i.jsx)(n.p,{children:"But I will convince you to have 4 stages."}),"\n",(0,i.jsx)(n.p,{children:"Docker has an amazing feature: targets."}),"\n",(0,i.jsx)(n.p,{children:"The targets allow to run a specified stage of the image."}),"\n",(0,i.jsx)(n.p,{children:"Let's have a look how it plays out in case of e2e tests."}),"\n",(0,i.jsx)(n.p,{children:"We have a regular docker compose setup with a database or whatever dependencies you have to run your tests.\nIm a big fan of a debugger and a big hater of infinite print statements. Don't get me wrong, logging is an awesome tool, but not the forgotten prints in a production build."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:'FROM builder AS dev\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go install github.com/go-delve/delve/cmd/dlv@v1.23.0\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go build -gcflags=all="-N -l" -o server ./cmd/server\n\nCMD ["dlv", "--listen=:40000", "--continue", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "server"]\n'})}),"\n",(0,i.jsx)(n.p,{children:"On installing delve don't forget to specify cache mount, it has its own dependencies and it will help to speed the build up.\nMoreover, if you don't mount the cache it won't discover the installeed dependencies in a previous step."}),"\n",(0,i.jsxs)(n.p,{children:["The mount flag might look unclear, as an argument you only put a path ",(0,i.jsx)(n.em,{children:"where"})," to mount, you can't control the source of directory, it's managed docker buildkit."]}),"\n",(0,i.jsxs)(n.p,{children:["Then we build a binary with a couple important gcflags, where ",(0,i.jsx)(n.code,{children:"-l"})," disables inlining and ",(0,i.jsx)(n.code,{children:"-N"})," removes optimisations. It matters because otherwise debugger won't be able to show some variables or navigate into some functions.\nYou can read more ",(0,i.jsx)(n.a,{href:"https://pkg.go.dev/cmd/compile",children:"here"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"As the last statement we run dlv."}),"\n",(0,i.jsx)(n.p,{children:"And that's what we have in a docker compose:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"server:\n  build:\n    context: .\n    dockerfile: Dockerfile\n    target: dev\n  ports:\n    - '8000:8000'\n    - '40000:40000'\n  security_opt:\n    - seccomp:unconfined\n  cap_add:\n    - SYS_PTRACE\n"})}),"\n",(0,i.jsx)(n.p,{children:"Here we specify target field, clear and simple. You also can pass it as a cli argument to an image."}),"\n",(0,i.jsx)(n.p,{children:"Ports has 2 elements, a regular app HTTP port and a DAP (Debug Adapter Protocol) port that delve exposes."}),"\n",(0,i.jsxs)(n.p,{children:["Next we add ",(0,i.jsx)(n.code,{children:"secuty_opt"})," since the default Seccomp profile restricts the ",(0,i.jsx)(n.code,{children:"ptrace"})," system call."]}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{}),(0,i.jsxs)(n.p,{children:["Seccomp is a Linux kernel feature used to restrict the system calls that a process can make. By default, Docker applies a restrictive Seccomp profile to limit potentially dangerous system calls, improving container security. Read more ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/engine/security/seccomp/",children:"here"})," and ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/engine/containers/run/",children:"here"}),"."]})]}),"\n",(0,i.jsxs)(n.p,{children:["When you specify ",(0,i.jsx)(n.code,{children:"seccomp:unconfined"}),", it removes the Seccomp restrictions, allowing the container to make all system calls. This config allows running ",(0,i.jsx)(n.code,{children:"ptrace"})," syscall in the container, delve uses it to set breakpoints, observe memory, etc."]}),"\n",(0,i.jsxs)(n.p,{children:["But it's not enough. We have to not only remove a restriction, but explicitly give a permission, that's why we have ",(0,i.jsx)(n.code,{children:"cap_add"})," statement: to add a capability for that syscall."]}),"\n",(0,i.jsx)(n.h2,{id:"build-prod",children:"Build prod"}),"\n",(0,i.jsx)(n.p,{children:"The prod build is quite simple and well known:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:'FROM builder AS prod\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go build -ldflags "-s -w" -o server ./cmd/server\n'})}),"\n",(0,i.jsxs)(n.p,{children:["We still use mount cache, we just put different build flags, in this case ldflags to achieve exactly the opposite we did in order to build a debug target.\n",(0,i.jsx)(n.code,{children:"-s"})," and ",(0,i.jsx)(n.code,{children:"-w"})," stand for skipping debug info, read more ",(0,i.jsx)(n.a,{href:"https://pkg.go.dev/cmd/link",children:"here"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"run-prod",children:"Run prod"}),"\n",(0,i.jsx)(n.p,{children:"There is no lots of new things for you, I want to focus on a small important thing: a user."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-docker",children:"RUN addgroup -g 1001 appgroup && adduser -D -G appgroup -u 1001 appuser\n\nUSER 1001\n"})}),"\n",(0,i.jsx)(n.p,{children:"There is so many information around on this security topic and I keep seeing zero attention to a user inside the image."}),"\n",(0,i.jsxs)(n.p,{children:["Shortly speaking - less ability less chance to make a mistake or open a vulnerability. Docker has a good blog ",(0,i.jsx)(n.a,{href:"https://www.docker.com/blog/understanding-the-docker-user-instruction/",children:"post"})," to cover why it matters."]}),"\n",(0,i.jsx)(n.h2,{id:"target-dependenciy-graph",children:"Target dependenciy graph"}),"\n",(0,i.jsx)(n.p,{children:"Now about the main concern of so many stages."}),"\n",(0,i.jsx)(n.p,{children:"Why would I build all the stages for releasing my go app?"}),"\n",(0,i.jsxs)(n.p,{children:["You will not, if you turned on buildkit it will behave as a smarter and build only the necessary dependencies, it means it builds the dependency graph and builds only necessary part, so your production CI will never install delve to waste your time.\nThe ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/build/building/multi-stage/#differences-between-legacy-builder-and-buildkit",children:"documentation"})," explains it very well."]}),"\n",(0,i.jsx)(n.h2,{id:"a-few-caveats-on-debugging-remote-dap",children:"A few caveats on debugging remote DAP."}),"\n",(0,i.jsx)(n.p,{children:"If you start a debugging process as is you will find your breakpoints Rejected.\nIt happens because your DAP communicates breakpoints state with DAP server using the client paths, and your client IDE is located on your machine, while the Go binary was built inside an image, another host machine."}),"\n",(0,i.jsxs)(n.p,{children:["You can find the fix in the official ",(0,i.jsx)(n.a,{href:"https://github.com/go-delve/delve/blob/master/Documentation/cli/substitutepath.md",children:"doc"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["First, I would connect to dlv ",(0,i.jsx)(n.code,{children:"dlv connect localhost:40000"})," and test path substitution,\nfor instance ",(0,i.jsx)(n.code,{children:"config substitute-path /path/in/docker /local/path"})," where /path/in/docker is just your WORKDIR statement and /local/path is your local dir (input ",(0,i.jsx)(n.code,{children:"pwd"})," in the project folder).\nAfter that you can try ",(0,i.jsx)(n.code,{children:"list main.main"})," and make sure it lists you a main function without an error."]}),"\n",(0,i.jsx)(n.p,{children:"Eventually I have the following config to configure remote debugger:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n      "type": "go",\n      "name": "debug remote service",\n      "mode": "remote",\n      "request": "attach",\n      "port": 40000,\n      "substitutePath": [\n        {\n          "from": "${env:HOME}/projects/project-name",\n          "to": "/app"\n        },\n        {\n          "from": "${env:HOME}/go/pkg/mod/",\n          "to": "/go/pkg/mod/"\n        }\n      ]\n    }\n'})}),"\n",(0,i.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,i.jsx)(n.p,{children:"Sorry, have nothing to say. Appreciate if you leave things better than you found it."})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},5155:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"gopls-08",title:"gopls: how your IDE becomes better every day",authors:["denis"],tags:["software","go"]},a=void 0,r={permalink:"/mynameis/blog/gopls-08",source:"@site/blog/08-gopls/index.mdx",title:"gopls: how your IDE becomes better every day",description:"A few years ago we had 2 editors for Go: jetbrains plugin to IntelijIdea and YOURNAMEIT with a go plugin.",date:"2025-02-15T21:41:35.000Z",formattedDate:"February 15, 2025",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"},{label:"go",permalink:"/mynameis/blog/tags/go"}],readingTime:5.23,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"gopls-08",title:"gopls: how your IDE becomes better every day",authors:["denis"],tags:["software","go"]},unlisted:!1,prevItem:{title:"Project ideas I keep",permalink:"/mynameis/blog/ideas-09"},nextItem:{title:"Go Dockerfile",permalink:"/mynameis/blog/go-dockerfile"}},l={authorsImageUrls:[void 0]},d=[{value:"LSP",id:"lsp",level:3},{value:"LSP Protocol",id:"lsp-protocol",level:3},{value:"gopls under the hood",id:"gopls-under-the-hood",level:3},{value:"Capabilities",id:"capabilities",level:3},{value:"What about Goland",id:"what-about-goland",level:3},{value:"How to debug gopls",id:"how-to-debug-gopls",level:3},{value:"A few nice words in the end",id:"a-few-nice-words-in-the-end",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"A few years ago we had 2 editors for Go: jetbrains plugin to IntelijIdea and YOUR_NAME_IT with a go plugin.\nFirst brought tons of closed source components that eventually became Goland and bunch of open source components used by another editor Go plugin:"}),"\n",(0,i.jsx)(n.p,{children:"It worked for a while, but it has a lot of issues."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Number one, you install a plugin, it installs a tenish of the others, every version half of the tools are broken and that's very lame dance happened every release."}),"\n",(0,i.jsx)(n.li,{children:"The integration complexity, every editor did its own integration set, some used only part of them, some integrated them one by one."}),"\n",(0,i.jsx)(n.li,{children:'Performance, it\'s not obvious today, but every tool worked once per editor request, it means every click "Go to definition" it has index the code base, find the implementatons or the object locations navigate you.'}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"tools",src:t(4034).Z+"",width:"1562",height:"1274"})}),"\n",(0,i.jsx)(n.h3,{id:"lsp",children:"LSP"}),"\n",(0,i.jsx)(n.p,{children:"And Microsoft did a next step in creating IDE.\nThey decided it's important to decouple Javascript language support from the the editor.\nSo they created another component for autocompletion, code navigation, refactoring and diagnostic.\nThis component must run outside of editor in order to let many vscode instances to reuse the same indexing and cache.\nThe called it a language server and it made a new standard: LSP, Lanugage Server Protocol."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/",children:"https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"gopls",src:t(433).Z+"",width:"1054",height:"908"})}),"\n",(0,i.jsx)(n.p,{children:"It gives every language team to make a developer experience an editor independant delegating all the main editor capabilities to the LSP implementation."}),"\n",(0,i.jsx)(n.p,{children:"It changes 3 fundamental things in the software history:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Language team supports any LSP compatible editor, it gives more editors come to the market like Helix, Zed, NVIM, etc."}),"\n",(0,i.jsx)(n.li,{children:'We finally don\'t need to install a bunch of binaries to make the development experience just "fine"'}),"\n",(0,i.jsx)(n.li,{children:"And a bonus point, it gives a Go team to focus on supporting more complicated use cases like large repos support increasing performance for everyone, so it means everyone can make a dev experience better for everyone."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"lsp-protocol",children:"LSP Protocol"}),"\n",(0,i.jsx)(n.p,{children:"Let's have a look at the protocol breifly.\nIt has a client that drives all the necessary capabilities implemented on button clicks, hover, hotkeys, etc.\nImplementing an LSP client it calls a server to resolve some actions.\nFor instance clicking Go to definition it sends a request with a given editor position where the interface method is described."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  ...\n  "method": "textDocument/definition",\n  "textDocument": {"uri": "file://location/file.go"},\n  "position": {"line": 42, "character: 3"},\n  ...\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"And the server contains all the indexed codebase can return a list of locations so editor suggest them to a developer."}),"\n",(0,i.jsx)(n.h3,{id:"gopls-under-the-hood",children:"gopls under the hood"}),"\n",(0,i.jsx)(n.p,{children:"Globally gopls has Cache.\nOpening an editor it creates a new Session to connect to the server.\nOpening a new project in the editor it creates a new Workspace looking for a module, go.work or GOPATH directory.\nIt holds metadata to let gopls know where you actually want to navigate in the code.\nIt uses default build, it also means it ignores build flags if you use them."}),"\n",(0,i.jsxs)(n.admonition,{type:"info",children:[(0,i.jsx)(n.p,{children:"In case you wish to see better dev exprience:"}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"changes to one module to be reflected in another"}),"\n",(0,i.jsx)(n.li,{children:"optimize memory usage by reducing the number of builds it must track"}),"\n",(0,i.jsx)(n.li,{children:"give gopls information where do you work\nthen use go.work."}),"\n"]})]}),"\n",(0,i.jsx)(n.h3,{id:"capabilities",children:"Capabilities"}),"\n",(0,i.jsxs)(n.p,{children:["All the features list you can find ",(0,i.jsx)(n.a,{href:"https://github.com/golang/tools/blob/master/gopls/doc/features/README.md",children:"here"}),".\nBelow I shortly describe what you could find useful to perform gopls at 100%."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"General information and a doc string on hovering"}),"\n",(0,i.jsx)(n.li,{children:"Diagnostics: static analysys, compile errors"}),"\n",(0,i.jsx)(n.li,{children:"Completion: how vscode intellisense gives you suggestion or cmp/blink for nvim."}),"\n",(0,i.jsx)(n.li,{children:"Navigation: Go to definition, List references, List implementations, etc."}),"\n",(0,i.jsx)(n.li,{children:"Transformation: format, sort imports, and refactoring as rename, inline, extract, etc."}),"\n"]}),"\n",(0,i.jsx)("img",{src:t(6138).Z}),"\n",(0,i.jsx)(n.h3,{id:"what-about-goland",children:"What about Goland"}),"\n",(0,i.jsx)(n.p,{children:"Goland is the opposite, it provides its capabilities as a closed source software. Lately it supports LSP as well, but they rarely can be compared in the feature set."}),"\n",(0,i.jsx)(n.p,{children:"The main difference we all together can make gopls better, while we never can contribute to Goland."}),"\n",(0,i.jsx)(n.p,{children:'If you found an idea like "I miss this hostkey to make this thing" or "generate that piece" or "discover that place" you probably want to develop another editor plugin.\nIt happened it me either, but apparently it\'s not the best solution.\nIf it\'s purely related to a language you just need to contribute to gopls.'}),"\n",(0,i.jsx)(n.h3,{id:"how-to-debug-gopls",children:"How to debug gopls"}),"\n",(0,i.jsx)(n.p,{children:"Here I describe a practical guide to gopls contribution.\nI skip the issue discussion with your proposal, expected output, how you attach a visual picture and communicate nicely, gerrit user experience so on."}),"\n",(0,i.jsx)(n.p,{children:"All the examples are using vscode, I'm sure vim/emacs nerds have cracked it.\nWe don't use GoLand here because it has a lot of internal tooling for Go that may add misunderstanding whether it's gopls or GoLand magic."}),"\n",(0,i.jsxs)(n.p,{children:["First, let's configure a local debugging setup.\nInside the repo we add a debugging statement for vscode in order to run our forked version of gopls, in a folder ",(0,i.jsx)(n.code,{children:"tools/gopls/"})," we add:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "version": "0.2.0",\n  "configurations": [\n    {\n      "name": "Run Gopls",\n      "type": "go",\n      "request": "launch",\n      "mode": "auto",\n      "program": "./main.go",\n      "args": ["-port=9000"]\n    }\n  ]\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Now you can run your gopls."}),"\n",(0,i.jsx)(n.p,{children:"In another editor instance you add a workspace setting:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'"go.languageServerFlags": [\n  "-remote=localhost:9000"\n]\n'})}),"\n",(0,i.jsx)(n.p,{children:"So you know how to make a call from your editor to the server and found a place to debug."}),"\n",(0,i.jsx)(n.p,{children:"For example you want to add a quickfix, it's a Code Action to make a Transformation, like implementing an interface or generating a function, etc."}),"\n",(0,i.jsxs)(n.p,{children:["Now guess where to put a breakpoint and call a Code Action from a client, in vscode you need to push ",(0,i.jsx)(n.code,{children:"CMD + ."})," or find your hotkey in the ",(0,i.jsx)(n.a,{href:"https://code.visualstudio.com/docs/editor/refactoring#_code-actions-quick-fixes-and-refactorings",children:"doc"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"a-few-nice-words-in-the-end",children:"A few nice words in the end"}),"\n",(0,i.jsx)(n.p,{children:"What's really important Go team uses LSP compatible editors, so real dog fooding comes in the room, they experience what the build and introduce the features they miss.\nI know for sure Alan Donovan uses Emacs, at least he said so."}),"\n",(0,i.jsxs)(n.p,{children:["If you are still interested look his ",(0,i.jsx)(n.a,{href:"https://youtu.be/8EsaJC9cn4w",children:"speach"})," how they optimized Gopls last interation."]}),"\n",(0,i.jsx)(n.p,{children:"A really hope it raises awareness across the entire Go community and lights the interest to the tooling, more people contribute better experience everyone would have."})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},5306:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"ideas-09",title:"Project ideas I keep",authors:["denis"],tags:["software"]},a=void 0,r={permalink:"/mynameis/blog/ideas-09",source:"@site/blog/09-ideas/index.mdx",title:"Project ideas I keep",description:"What is it",date:"2025-05-14T13:20:35.000Z",formattedDate:"May 14, 2025",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"}],readingTime:5.535,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"ideas-09",title:"Project ideas I keep",authors:["denis"],tags:["software"]},unlisted:!1,prevItem:{title:"How Treenq builds workload images",permalink:"/mynameis/blog/container-in-container-09"},nextItem:{title:"gopls: how your IDE becomes better every day",permalink:"/mynameis/blog/gopls-08"}},l={authorsImageUrls:[void 0]},d=[{value:"What is it",id:"what-is-it",level:2},{value:"0: Failed grpc gui",id:"0-failed-grpc-gui",level:3},{value:"1: PaaS as code",id:"1-paas-as-code",level:3},{value:"2: Go framework that doesn&#39;t suck",id:"2-go-framework-that-doesnt-suck",level:3},{value:"3: Infra provision for Go that doesn&#39;t suck",id:"3-infra-provision-for-go-that-doesnt-suck",level:3},{value:"4: Write opensource Mongodb optimized for log storage or e-comm.",id:"4-write-opensource-mongodb-optimized-for-log-storage-or-e-comm",level:3},{value:"5: Auth for Go that doesn&#39;t suck.",id:"5-auth-for-go-that-doesnt-suck",level:3},{value:"6: Observability as Code.",id:"6-observability-as-code",level:3},{value:"7: Error replayer",id:"7-error-replayer",level:3},{value:"8: Postgres has tons of staff",id:"8-postgres-has-tons-of-staff",level:3}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"what-is-it",children:"What is it"}),"\n",(0,i.jsx)(n.p,{children:"I would recomment it for reading only if:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"You look for programming some technical, but out of ideas"}),"\n",(0,i.jsx)(n.li,{children:"You are tech indie hacker who might look for a person to discuss ideas, brainstorm or even build a team (with me if you didn't get it)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"On this page I want to document the projects ideas I keep in my head, some of them for a very long time, some since recently.\nThe document probably will be updated time to time, but the idea to me simply not to loose the track of what I have."}),"\n",(0,i.jsx)(n.p,{children:"I hope I can implement at least half of them by the end of my software career."}),"\n",(0,i.jsx)(n.h3,{id:"0-failed-grpc-gui",children:"0: Failed grpc gui"}),"\n",(0,i.jsx)(n.p,{children:"It's actually one I partially implemented, a grpc gui that gives a full scripting capability."}),"\n",(0,i.jsx)(n.p,{children:"I realized scripting itself doesn't give much value and gave up."}),"\n",(0,i.jsxs)(n.p,{children:["Failed repo is there btw: ",(0,i.jsx)(n.a,{href:"https://github.com/kalisto-application/kalisto",children:"https://github.com/kalisto-application/kalisto"})]}),"\n",(0,i.jsx)(n.h3,{id:"1-paas-as-code",children:"1: PaaS as code"}),"\n",(0,i.jsx)(n.p,{children:"That's my current thing. Idea is huge and the amount of features I want to do is huge.\nThe list is long."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"It creates an abstraction on top of k8s so any kid could deploy an app and keep playing with kube.\nAs a result it fits small teams and mid/large project could potentially consider it, that's why exactly kube, no VM or Nomad."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Telepresence or mirrord is integrated. It means you can run a service locally and never deal with config files and local docker compose setups.\nYou just run it against staging environment, zero config, it works."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Optionally: preview is integrated.\nFor some features a team may want to preview it, so create a temporary environment with a flexible deployment.\nThe feature is easy to do for stateles systems like frontend applications, but branching a database is a huge challenge.\nNeon makes it spossible for postgres today, planetscale for mysql, but there are plenty more storages we have."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Tilt.dev is integrated. It means you cal run locally ",(0,i.jsx)(n.code,{children:"docker build"})," and this image is immediately on staging.\nImagine how fast if feedback loop when you test changes with the team together right in the moment."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"2-go-framework-that-doesnt-suck",children:"2: Go framework that doesn't suck"}),"\n",(0,i.jsx)(n.p,{children:"Framework sounds huge.\nBut heaer me out, I don't want to build another route or faster router.\nOnce I looked at huma.rocks and it looked very solid at what it does."}),"\n",(0,i.jsx)(n.p,{children:"Idea:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"you don't write monkey code on marshalling and unmarshalling body, just start from a business layer"}),"\n",(0,i.jsx)(n.li,{children:"you don't write API client to communicate to your API, it just exists (code gen hello)"}),"\n",(0,i.jsx)(n.li,{children:"you don't describe openAPI for the service, it exists"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:'The last point is huge to me.\nInstead of writing openAPI and having lots of time lost on "why it doesn\'t fit spec" the API is ran by implementation first.\nYou see in the spec what you implemented, not what you promised.'}),"\n",(0,i.jsx)(n.p,{children:"As a cost it may limit how flexible is the API, but Im fine.\nI hate REST.\nI prefer building web APIs.\nAnd a web API is ok if it has only GET or POST apis and has every request argument body as a request body.\nIt's similar to json rpc, but simpler."}),"\n",(0,i.jsx)(n.p,{children:"I already started working on it in my PaaS project and test it in the battle, seems good so far.\nBut I will opensource it as soon as PaaS fails and will continue using this framework as long as it helps me moving faster for projects where I need Go."}),"\n",(0,i.jsx)(n.h3,{id:"3-infra-provision-for-go-that-doesnt-suck",children:"3: Infra provision for Go that doesn't suck"}),"\n",(0,i.jsxs)(n.p,{children:["Remember this part from PaaS ",(0,i.jsx)(n.code,{children:"db := tq.NewDB()"}),".\nI think it's real.\nTo make something similar to encore.dev, but not dependent on runtime.\nSounds to me as pulumi + sync with state (let's say S3).\nResult is the same, you don't have a config, you don't have secret management, explicit provision.\nThe only issue is managing the state and its secret, it might be a big security issue."]}),"\n",(0,i.jsx)(n.h3,{id:"4-write-opensource-mongodb-optimized-for-log-storage-or-e-comm",children:"4: Write opensource Mongodb optimized for log storage or e-comm."}),"\n",(0,i.jsx)(n.p,{children:"As of today Mongodb is not opensourced.\nThere is an attempt to replace it, very successful I would save, ferretdb.\nThey have good support from Microsoft and somebody else, but it's on top of postgres."}),"\n",(0,i.jsx)(n.p,{children:"Don't get me wrong, postgres is great.\nBut I think there are caveats of building it on top of existing db."}),"\n",(0,i.jsx)(n.p,{children:"What if write it in Zig?\nThe performance must be huge, in a very accurate memory management it's even better than Rust."}),"\n",(0,i.jsx)(n.h3,{id:"5-auth-for-go-that-doesnt-suck",children:"5: Auth for Go that doesn't suck."}),"\n",(0,i.jsx)(n.p,{children:"There are lots of auth projects around one can run as a separate service: Logto, keycloak, zitadel, supabase, there are too many of them.\nBut most of the time to make it simple and fast it's great to run an embedded package instead of configuring another service.\nThere are a couple librarie for go: goth and authboss.\nFirst is just oauth client, it's great to even look for a code and copy to the project.\nSecond seems huge to implement everything, but documentation sucks."}),"\n",(0,i.jsx)(n.p,{children:"But there is one very interesting project: Ory Kratos.\nIf anyone tells it's a security concern to run it in the same process - send them away.\nEven the kratos owners run it as embedded package in SaaS offering.\nWould be great to reinvent kratos as embedding first solution and make it well documented."}),"\n",(0,i.jsx)(n.p,{children:"There is a similar one for typescript - simple auth.\nThe only scaring thing - both projects are between 50-100k LoC."}),"\n",(0,i.jsx)(n.h3,{id:"6-observability-as-code",children:"6: Observability as Code."}),"\n",(0,i.jsx)(n.p,{children:'Similar to Infra as code we define observability in code. The thing is we already have routers in the app and know all the endpoints to make them possible. It must be cool just to map them, then a config like "10% error rate on any of the ourer and pls call me", give a couple api keys aod done.'}),"\n",(0,i.jsx)(n.h3,{id:"7-error-replayer",children:"7: Error replayer"}),"\n",(0,i.jsx)(n.p,{children:"Projects like cypres allow generating e2e tests by clicking UI elements, it tracks events, generates code so you could run the same scenario constantly.\nWhat if we could track all the API calls on backend then generate code?\nSounds cool, I can click staging and expect it will be reproducable.\nAlso, I can copy this code to make a manual scenario without expecting same result, just test something that takes many clicking."}),"\n",(0,i.jsx)(n.h3,{id:"8-postgres-has-tons-of-staff",children:"8: Postgres has tons of staff"}),"\n",(0,i.jsx)(n.p,{children:"There are tons of basic features every postgres need:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"web UI"}),"\n",(0,i.jsx)(n.li,{children:"RBAC and service accounts"}),"\n",(0,i.jsx)(n.li,{children:"audit log"}),"\n",(0,i.jsx)(n.li,{children:"CDC and events emitting"}),"\n",(0,i.jsx)(n.li,{children:'multitenant support in order to skip building queries like "where tenant=$1"'}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},1708:(e,n,t)=>{"use strict";t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>d});var i=t(5893),o=t(1151);const s={slug:"container-in-container-09",title:"How Treenq builds workload images",authors:["denis"],tags:["software","paas"]},a=void 0,r={permalink:"/mynameis/blog/container-in-container-09",source:"@site/blog/10-container-in-container/index.mdx",title:"How Treenq builds workload images",description:"Build a container inside a rootless conatiner",date:"2025-06-01T21:59:56.000Z",formattedDate:"June 1, 2025",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"},{label:"paas",permalink:"/mynameis/blog/tags/paas"}],readingTime:8.055,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"container-in-container-09",title:"How Treenq builds workload images",authors:["denis"],tags:["software","paas"]},unlisted:!1,nextItem:{title:"Project ideas I keep",permalink:"/mynameis/blog/ideas-09"}},l={authorsImageUrls:[void 0]},d=[{value:"Build a container inside a rootless conatiner",id:"build-a-container-inside-a-rootless-conatiner",level:2},{value:"Grug: docker in docker",id:"grug-docker-in-docker",level:3},{value:"Kaniko: k8s native builder",id:"kaniko-k8s-native-builder",level:3},{value:"Buildah: isolated package",id:"buildah-isolated-package",level:3},{value:"BuildKit: overlooked option",id:"buildkit-overlooked-option",level:3}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"build-a-container-inside-a-rootless-conatiner",children:"Build a container inside a rootless conatiner"}),"\n",(0,i.jsxs)(n.p,{children:["A PaaS has a very dev friendly use case: when a user just conneects a repository we must build the image from a Dockerfile in the repo.\nWe assume at the beginning a team doesn't have a CI pipeline and wants to share a quick demo to the customers.\nThere are many ways to do it. Let's look at all of them and at the design we chosed for ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq",children:"Treenq"})]}),"\n",(0,i.jsx)(n.h3,{id:"grug-docker-in-docker",children:"Grug: docker in docker"}),"\n",(0,i.jsx)(n.p,{children:"As a straight forward approach we can forward docker host to a container and build it.\nIt has quite a lot of problems:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"dind requirees running in privileged mode: it opens a rabbit hole to a host machine"}),"\n",(0,i.jsx)(n.li,{children:"moreover, it doesn't seem an option to make it rootless"}),"\n",(0,i.jsx)(n.li,{children:"docker daemon is running, it's not free for resources"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Even to get started the user case it didn't seem convinient, it requires configuration to make it possible, so I decided to move to more secure options."}),"\n",(0,i.jsx)(n.h3,{id:"kaniko-k8s-native-builder",children:"Kaniko: k8s native builder"}),"\n",(0,i.jsx)(n.p,{children:"Kaniko is created to solve this problem.\nIt allows setting up an environemnt for a cluster where the workload is built near it's runners, perhaps on different nodes in order to avoid any resource fight.\nThe idea is it spans a new container that builds an image, the container feels great in unprivileged environment and doesn't require a docker daemon."}),"\n",(0,i.jsx)(n.p,{children:"Technically it doesn't create a new namespace, instead it unpacks an image layer and does chroot."}),"\n",(0,i.jsxs)(n.p,{children:["You can even span your registry right in this cluster, like a regular one or ",(0,i.jsx)(n.a,{href:"https://github.com/goharbor/harbor",children:"Harbor"})," and the builds flow is completely isolated from the planet.\nIt like like ",(0,i.jsx)(n.strong,{children:"kaniko -> registry -> k8s workload node"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"In terms of security Kaniko is the winner.\nIt does require root to run, but the abstraction is well done to keep it away."}),"\n",(0,i.jsx)(n.p,{children:"Looks fancy, but has a couple restrictions:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"it buidls containers only inside a Kubernetes cluster, it works in k8s, k3s (which we use for e2e tests) and perhaps some more."}),"\n",(0,i.jsx)(n.li,{children:"it has no more capabilities, if I need to inspect an image."}),"\n",(0,i.jsx)(n.li,{children:"it's not able to build windows images"}),"\n",(0,i.jsx)(n.li,{children:"build time performance is slightly lower"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["For instance, I want to rollback, I want it real quick, so before launching a build job I want to look if the image is in the registry.\nFor that purpose I must use skopeo or another tool to talk to a registry.\nNot really a big deal.\nPerhaps, one day Treenq will need ",(0,i.jsx)(n.a,{href:"https://github.com/containers/skopeo",children:"Skopeo"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Looking back it looks a good option and most likely I would say it's worth trying it.\nBut I thought it's very important to have a capability to run builds outside of a cluster, may be even on a isoalted VM, which is not really smart requirement I guess.\nAlso, the complexity to set it up didn't look easy enough, I have to span a k8s resource, make a ServiceAccount for it and many more to start building + adding inspection API near by."}),"\n",(0,i.jsx)(n.p,{children:"On top of that, recently, Kaniko stepped down right into arhive."}),"\n",(0,i.jsx)(n.h3,{id:"buildah-isolated-package",children:"Buildah: isolated package"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/containers/podman",children:"Podman"}),", a Docker alternative, has a way cleaner opensource relation and how they structure the packages and repositories.\nPodman has a designated module, ",(0,i.jsx)(n.a,{href:"https://github.com/containers/buildah",children:"Buildah"}),", which is used exactly for building images.\nIt requires no priovileges, root, daemon, nothing (technically speaking, but there is a price for it)."]}),"\n",(0,i.jsx)(n.p,{children:"It doesn't require a daemon to run.\nPackage is written in Go, therefore I can embed it right into the service instead of adding a syscall."}),"\n",(0,i.jsx)(n.p,{children:"DISCLAIMER: I understand I use undocumented API of the package and it can hurt it. If it happens I can freeze the version, and then either the project fulfills the graveyard or it migrates to buildkit."}),"\n",(0,i.jsxs)(n.p,{children:["First step is to understand how to run buidlah in a container.\nThere is an official ",(0,i.jsx)(n.a,{href:"https://hub.docker.com/r/buildah/buildah",children:"image"})," based on Fedora, but I want my app run at least in Ubuntu.\nBetter in alpine/scratch ofc, but it doesn't seem viable."]}),"\n",(0,i.jsxs)(n.p,{children:["There are a some guides on ",(0,i.jsx)(n.a,{href:"https://developers.redhat.com/blog/2019/08/14/best-practices-for-running-buildah-in-a-container",children:"how to run buildah in a container"})," and ",(0,i.jsx)(n.a,{href:"https://opensource.com/article/19/3/tips-tricks-rootless-buildah",children:"in privileged environment"}),", so I can slowly transform this information to prepare Ubuntu image.\nHere is what I got ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/main/Dockerfile",children:"eventually"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Ok, we can build, next step I want to build a small image from Go application."}),"\n",(0,i.jsxs)(n.p,{children:["There is a ",(0,i.jsx)(n.a,{href:"https://github.com/containers/buildah/blob/main/docs/tutorials/04-include-in-your-build-tool.md",children:"guilde"})," showing how programmatically execute dockerfile steps (run, copy, etc.), but it's not what we need.\nWe simply need to run ",(0,i.jsx)(n.code,{children:"buildah build"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"At this point I have to dig the source code to understand what's happening.\nJumping right inside the build command in the source code we find there is a storage resource is required to start and we can execute the build"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"\tbuildStoreOptions, _ := storage.DefaultStoreOptions()\n\tbuildStore, _ := storage.GetStore(buildStoreOptions)\n"})}),"\n",(0,i.jsx)(n.p,{children:"And next step we can start build:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"\tid, _, err := imagebuildah.BuildDockerfiles(ctx, buildStore, define.BuildOptions{\n\t\tContextDirectory: args.Path,\n\t\tRegistry:         a.registry,\n\t\tOutput:           args.Name,\n\t\tOut:              out,\n\t\tErr:              errOut,\n\t\tReportWriter:     reportOut,\n\t\tIgnoreFile:     dockerignorePath,\n\t\tAdditionalTags: []string{image.FullPath()},\n\t}, args.Dockerfile)\n"})}),"\n",(0,i.jsx)(n.p,{children:"To push the image we need to get a reference to this image in our store and prepare system context: registry authentication, tls flags, certs."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'\tstoreRef, _ := alltransports.ParseImageName("docker://" + image.FullPath())\n\tsystemContext, := &types.SystemContext{\n\t\tDockerCertPath:              a.registryCertDir,\n\t\tDockerInsecureSkipTLSVerify: types.NewOptionalBool(!a.registryTLSVerify),\n\t\tDockerAuthConfig:            &types.DockerAuthConfig{\n\t\t\tIdentityToken: a.registryToken,\n\t\t},\n\t} \n\t_, _, err = buildah.Push(ctx, id, storeRef, buildah.PushOptions{\n\t\tStore:         a.store,\n\t\tSystemContext: systemContext,\n\t})\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Full version of this module is ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go",children:"here"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"One important detail: first lines of your main function must be:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"\tif buildah.InitReexec() {\n\t\treturn\n\t}\n\tunshare.MaybeReexecUsingUserNamespace(false)\n"})}),"\n",(0,i.jsx)(n.p,{children:"It matters to act Buildah as root without being real rool.\nIt locks the OS thread, prepares uid/gid mapping and reexec as a new user in a new namespace.\nSo, softly speaking, it's not ideal to run this code inside the application code."}),"\n",(0,i.jsx)(n.p,{children:"The best design would be to have the application code isolated from pool of builders. Builders can receive the build tasks and still execute it inside a Go app in order to being able to extend he capabilities.\nThis design allows me to extend options to build images: In a similar manner I can embed buildpacks to build simpler apps without a Dockerfile."}),"\n",(0,i.jsx)(n.p,{children:"Buildah, unfortunately, also has a few caveats and it's a little behined of docker."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["For instance buildah can't inject variables/secrets ",(0,i.jsx)(n.a,{href:"https://github.com/containers/buildah/issues/5892",children:"on RUN command"})," while docker can."]}),"\n",(0,i.jsxs)(n.li,{children:["Or it can't detect ",(0,i.jsx)(n.a,{href:"https://github.com/containers/buildah/issues/5408",children:"variables in images"})]}),"\n",(0,i.jsx)(n.li,{children:"Also, runniong it unprivileged is quite tricky and it requires specific arguments for container and specific build of the image itself.\nThe domain is huge to learn, different backends, storages drivers and so on."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["From this ",(0,i.jsx)(n.a,{href:"https://github.com/containers/buildah/issues/2554",children:"issue"})," I learned vfs storage driver copies the entire sublayer on every layer.\nSo it's better to use overlayfs, it requires /dev/fuse to run in non privileged container."]}),"\n",(0,i.jsxs)(n.p,{children:["As a bonus, it might be cool to put it inside alpine, but not sure it's viable at all.\nPutting a cgo app itself requires some ",(0,i.jsx)(n.a,{href:"https://baicai.xlog.app/docker_golang_alpine_cgo_build?locale=en",children:"dance"})," for it."]}),"\n",(0,i.jsx)(n.h3,{id:"buildkit-overlooked-option",children:"BuildKit: overlooked option"}),"\n",(0,i.jsx)(n.p,{children:"What if docker could get rid of priviileged mode?"}),"\n",(0,i.jsx)(n.p,{children:"Buildx (BuildKit) is a module of docker (or moby?) that's responsible specifically for building iamges."}),"\n",(0,i.jsx)(n.p,{children:"BuildKit still has a daemon and it requires a privileged mode either."}),"\n",(0,i.jsxs)(n.p,{children:["However, we can run fake root using ",(0,i.jsx)(n.a,{href:"https://github.com/rootless-containers/rootlesskit/",children:"RootlessKit"}),".\nWe can build our flow in the following way:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"run a daemon"}),"\n",(0,i.jsx)(n.li,{children:"run buildctl to start build"}),"\n",(0,i.jsx)(n.li,{children:"when we are done we close the daemon"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"RootlessKit requires turning off apparmor and seccomp, because the default profile doesn't allow spawning new namespaces.\nAlso, add a few linux capabilities like SETUID, SETGUID and fake root users removing the option no-new-privileges."}),"\n",(0,i.jsx)(n.p,{children:"It seems quite secure, but has a few constraints:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"requires support explicit uid and gid which is not fine and might be annoyign"}),"\n",(0,i.jsx)(n.li,{children:"requires supporting a designated pool of build machines, which is actually makes sence in terms of designing a PaaS, but makes it a way complicated to start"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"In case of buildah it required me to run the build in the same application.\nIn order to scale it well I have to build network transport and mount volumes between them, which makes it quite complicated to setup."}),"\n",(0,i.jsx)(n.p,{children:"Buildkit provides its capabilities out of the box. It makes its API a bit  harder to learn, since it's not documented well and perhaps not supposed to be used like that."}),"\n",(0,i.jsx)(n.p,{children:"Buildkit brings to main modules to the table:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"buildkitd - a daemon to serve the builds, it may expose a unix socker to tcp connection"}),"\n",(0,i.jsx)(n.li,{children:"buildctl - the actual buildkit client"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Now it requires to to setup additional container buildkitd and write a client part inside my Go service.\nAs a benefit I get rid of building images and buildkit dependencies."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'  buildkit:\n    image: moby/buildkit:v0.23.0\n    privileged: true\n    container_name: buildkit\n    ports:\n      - "1234:1234"\n    volumes:\n      - ./buildkit/entrypoint.sh:/entrypoint.sh\n      - ./buildkit/buildkitd.toml:/etc/buildkit/buildkitd.toml\n      - ./registry/certs:/certs\n      - ./buildkit/certs:/buildkit\n    entrypoint: ["/entrypoint.sh"]\n    healthcheck:\n      test: ["CMD-SHELL", "buildctl --addr tcp://localhost:1234 debug workers"]\n      interval: 5s\n      timeout: 30s\n      retries: 3\n    extra_hosts:\n      - "localhost:host-gateway"\n'})}),"\n",(0,i.jsx)(n.p,{children:"entrypoint specifies the arguments to run, it overrides the default address to tcp.\nbuildkitd mostly contains registry and service access and its TLS to test and support self signed certs flow.\nBuildkit not only builds images, but also pushes them, therefore it requires access to the registry. Since my service has acces to the local registry as to localhost I want my buildkit access it on localhost too, therefore I define extra_hosts there.\nWithout the extra_hosts config registry will be available on registry host as define in the rest of the docker-compose.yaml."}),"\n",(0,i.jsxs)(n.p,{children:["Full example is here: ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go",children:"https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go"})]}),"\n",(0,i.jsx)(n.p,{children:"docker-compose is in the root of the repo."}),"\n",(0,i.jsxs)(n.p,{children:["Final design of the platform is the following:\n",(0,i.jsx)(n.img,{alt:"img",src:t(409).Z+"",width:"1938",height:"1279"})]}),"\n",(0,i.jsx)(n.p,{children:"Happy to answer your questions below in the comments"})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},3808:(e,n,t)=>{"use strict";t.r(n),t.d(n,{default:()=>g});const i={heroBanner:"heroBanner_qdFl",buttons:"buttons_AeoN",container:"container_bfhl",leftColumn:"leftColumn_v6oH",rightColumn:"rightColumn_HGp3",image:"image_bggV",heading:"heading_IFrj",socialLinks:"socialLinks_AWWq",tShapeSection:"tShapeSection_kY6f",tShapeDiagram:"tShapeDiagram_FBBT",tLabels:"tLabels_zGxv",tBroad:"tBroad_vPjQ",tDeep:"tDeep_Srk3",projectsSection:"projectsSection_kzy3",projectsGrid:"projectsGrid_rlw0",projectRow:"projectRow_AAMg",projectInfo:"projectInfo_HNeh",projectArrow:"projectArrow_dGBj",linksTable:"linksTable_DVyf",linkRow:"linkRow_zjpl",linkIcon:"linkIcon_Bj7K",linkText:"linkText__TDV",linkArrow:"linkArrow_zfmv"};t(7294);var o=t(2593),s=t(5154),a=t(6495),r=t(6800),l=t(9960),d=t(5893);r.kL.register(r.uw,r.f$,r.ZL,r.Dx,r.u,r.De);const c=["gopls: how your IDE becomes better every day","Go Dockerfile","250mb json in a 40mb service limit","How Treenq builds workload images"],h=(()=>{const e=t(2934),n=e.keys().map((n=>{const t=e(n),{metadata:i}=t,{title:o,description:s,permalink:a,date:r,frontMatter:l}=i,d=t.truncated;return console.log(o),{title:o,description:s||l.description,permalink:a,date:new Date(r).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),truncatedContent:d}}));return n.sort(((e,n)=>new Date(n.date).getTime()-new Date(e.date).getTime())),n.filter((e=>c.includes(e.title)))})(),u=[{name:"Treenq",link:"http://treenq.com",description:"Opensource PaaS on Kubernetes: deploy, preview, enjoy"},{name:"Kalisto",link:"http://github.com/kalisto-Application/kalisto",description:"GRPC GUI with scripting sandbox: test grpc service using Javascript in a ready to go setup"}],p=[{icon:(0,d.jsx)(s.yRW,{size:24}),text:"CV",url:"https://rxresu.me/candyboobers/main"},{icon:(0,d.jsx)(s.fWC,{size:24}),text:"Twitter",url:"https://twitter.com/candyboobers"},{icon:(0,d.jsx)(s.hJX,{size:24}),text:"GitHub",url:"https://github.com/dennypenta"},{icon:(0,d.jsx)(s.BUd,{size:24}),text:"LinkedIn",url:"https://www.linkedin.com/in/denis-dvornikov-33399812b/"}],m=()=>{const e=[{name:"Go",depth:80},{name:"Kubernetes",depth:70},{name:"AWS/GCP",depth:60},{name:"Python",depth:60},{name:"Nodejs",depth:60},{name:"Grafana",depth:50},{name:"Terraform",depth:50},{name:"React/SolidJS",depth:30},{name:"OIDC",depth:30}],n={labels:e.map((e=>e.name)),datasets:[{label:"Skill Depth",data:e.map((e=>e.depth)),backgroundColor:"#886CBC",borderRadius:8,borderSkipped:!1,maxBarThickness:32}]};return(0,d.jsx)("div",{style:{width:"100%",minWidth:340,maxWidth:600},children:(0,d.jsx)(a.$Q,{data:n,options:{indexAxis:"y",responsive:!0,plugins:{legend:{display:!1},title:{display:!1},tooltip:{callbacks:{label:e=>`${e.parsed.x}`}}},scales:{x:{ticks:{color:"#eae0d5",font:{size:14}},grid:{color:"rgba(136,108,188,0.15)"}},y:{ticks:{color:"#eae0d5",font:{size:14}},grid:{color:"rgba(136,108,188,0.10)"}}}},height:360})})},g=()=>(0,d.jsx)(o.Z,{title:"About me",description:"About me",children:(0,d.jsxs)("div",{className:i.container,children:[(0,d.jsxs)("div",{className:i.leftColumn,children:[(0,d.jsx)("img",{className:i.image,src:t(6349).Z,alt:"Denis"}),(0,d.jsx)("h1",{className:i.heading,children:"Hey, I'm Denis!"}),(0,d.jsx)("p",{children:"On this website I share what I find cool."}),(0,d.jsx)("div",{className:i.linksTable,children:p.map(((e,n)=>(0,d.jsxs)("a",{href:e.url,className:i.linkRow,target:"_blank",rel:"noopener noreferrer",children:[(0,d.jsx)("span",{className:i.linkIcon,children:e.icon}),(0,d.jsx)("span",{className:i.linkText,children:e.text}),(0,d.jsx)("span",{className:i.linkArrow,children:(0,d.jsx)(s.CkN,{size:16})})]},n)))}),(0,d.jsxs)("section",{className:i.tShapeSection,children:[(0,d.jsx)("h2",{children:"My Skills"}),(0,d.jsx)("div",{className:i.tShapeDiagram,children:(0,d.jsx)(m,{})})]})]}),(0,d.jsxs)("div",{className:i.rightColumn,children:[(0,d.jsxs)("section",{className:i.projectsSection,children:[(0,d.jsx)("h2",{children:"Projects"}),(0,d.jsx)("div",{className:i.projectsGrid,children:u.map(((e,n)=>(0,d.jsxs)("a",{href:e.link,className:i.projectRow,target:"_blank",rel:"noopener noreferrer",children:[(0,d.jsxs)("div",{className:i.projectInfo,children:[(0,d.jsx)("h3",{children:e.name}),(0,d.jsx)("p",{children:e.description})]}),(0,d.jsx)("span",{className:i.projectArrow,children:(0,d.jsx)(s.CkN,{size:18})})]},n)))})]}),(0,d.jsxs)("section",{className:i.blogSection,children:[(0,d.jsx)("h2",{children:"Latest Blog Posts"}),(0,d.jsx)("div",{className:i.blogPostsList,children:h.map(((e,n)=>(0,d.jsxs)(l.Z,{to:e.permalink,className:i.blogPostPreview,children:[(0,d.jsx)("h3",{children:e.title}),(0,d.jsx)("p",{className:i.blogPostDate,children:e.date}),e.truncatedContent&&(0,d.jsx)("div",{className:i.blogPostSummary,dangerouslySetInnerHTML:{__html:e.truncatedContent}})]},n)))})]})]})]})})},6138:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/goplsdemo-f2b7502d7c1386c4efaf0e44c287e86a.gif"},6349:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/1-35115a00562199f3e4dd31f264720053.jpg"},6678:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/congestion-d6e58562593cc5752c5bc8b39ab87735.svg"},8006:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/syn-b9d07c0830813f49866fd02e5f6dcacb.svg"},4753:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/few-a8829c782e27ba5f7f88f18ced787cf4.png"},8323:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/gpt-b6084e0c9c75c7a74f335fb999dde350.png"},433:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/gopls-16a8ddec9a07138982e1e6d3a9952935.png"},4034:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/tools-97d2c88ea8f2d7e405543e5b641d0e2c.png"},409:(e,n,t)=>{"use strict";t.d(n,{Z:()=>i});const i=t.p+"assets/images/design-2f0fa17a45b1b84f1404c7ee75031b27.svg"}}]);