"use strict";(self.webpackChunkmynameis=self.webpackChunkmynameis||[]).push([[644],{8826:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var i=t(5893),a=t(1151);const r={slug:"tq-devlog-0",title:"PaaS devlog |#0",authors:["denis"],tags:["paas"]},o=void 0,s={permalink:"/mynameis/blog/tq-devlog-0",source:"@site/blog/04-tq-devlog-0/index.md",title:"PaaS devlog |#0",description:"Devlog #0: logging, linter, Zitadel, codegen, e2e tests",date:"2024-09-02T20:12:28.000Z",formattedDate:"September 2, 2024",tags:[{label:"paas",permalink:"/mynameis/blog/tags/paas"}],readingTime:8.43,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"tq-devlog-0",title:"PaaS devlog |#0",authors:["denis"],tags:["paas"]},unlisted:!1,prevItem:{title:"Web API Design: A Simplified Approach",permalink:"/mynameis/blog/api-design"},nextItem:{title:"Backend Guy Ventures into Game Development",permalink:"/mynameis/blog/do-gamedev"}},l={authorsImageUrls:[void 0]},d=[{value:"Devlog #0: logging, linter, Zitadel, codegen, e2e tests",id:"devlog-0-logging-linter-zitadel-codegen-e2e-tests",level:2},{value:"The problem",id:"the-problem",level:3},{value:"The planing",id:"the-planing",level:3},{value:"The ugly thing",id:"the-ugly-thing",level:3},{value:"Infra preparation",id:"infra-preparation",level:2},{value:"Logging and recovery",id:"logging-and-recovery",level:3},{value:"Linter",id:"linter",level:3},{value:"AuthZ",id:"authz",level:3},{value:"Generate api client",id:"generate-api-client",level:3},{value:"Defining e2e tests",id:"defining-e2e-tests",level:3},{value:"Bye",id:"bye",level:4}];function c(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"devlog-0-logging-linter-zitadel-codegen-e2e-tests",children:"Devlog #0: logging, linter, Zitadel, codegen, e2e tests"}),"\n",(0,i.jsx)(n.p,{children:"Today I want to share with your my first steps of creating new project.\nFor a long time I've wanted created something cool, really meaninful, and after all I step into my idea: Platform as a service."}),"\n",(0,i.jsx)(n.p,{children:"The main tech stack has beeen defined: Go for a main backend, perhaps JavaScript for cdk integration.\nAll the infra will be used from a well known cloud providers (not aws ofc, no clue who can understand how to user it).\nFirst iteration will not such words as a frontend, ui, design. Ofc I want to make it, but only future history can judge me."}),"\n",(0,i.jsx)(n.h3,{id:"the-problem",children:"The problem"}),"\n",(0,i.jsxs)(n.p,{children:["The technical problem exists, it's fun to figure out.\nBut no the main one. The biggest fight Im gonna accept is ",(0,i.jsx)(n.strong,{children:"procrastination"}),". Im such a person who pushes further all the tasks very often. I just have little to do with time discipline. That's what will stop me from the progress.\nSo the easiest way to move progress away - do whatever, but not the progress."]}),"\n",(0,i.jsx)(n.h3,{id:"the-planing",children:"The planing"}),"\n",(0,i.jsxs)(n.p,{children:["So I decided to plan everything and understand how big the actual project is gonna be.\nSo I start speaking with GPT in order to express my mind, kinda talking to a duck.\nInstead of asking what I should do I explained my plan and asked to ask ",(0,i.jsx)(n.strong,{children:"more questions"})," so it could help me to clarify the technical solution and the plan."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"img",src:t(8323).Z+"",width:"817",height:"1036"})}),"\n",(0,i.jsxs)(r,{children:[(0,i.jsx)("summary",{children:(0,i.jsx)(n.p,{children:"Here you can find a prompt I used"})}),(0,i.jsx)(n.p,{children:"I want to develop a platform like digitalocean app, vercel, render, fly.io, heroku, etc. My value is the following: I give observability with 0 code changes, and a localdev opportunity with connecting to a cloud environment, for instance a request comes from a frontend app on staging to my backend app locally so I could intercept it and make my laptop appear kinda in the cloud. It's a multitenant project. There are 2 paths: kubernetes and a custom architecture. To build a custom architecture the app must be on a few virtual machines, a load balancer on top including firewall. The challenge: ask me necessary questions so we could make a right decision. I have to highlight, we build a users' environment, not the product architecture I will create in order to reproduce the given environment, so we need to decide that would fit me and users better."})]}),"\n",(0,i.jsx)(n.p,{children:"Initially I thought I will do it providing a user set of virtual machines connected under VPC, putting a load balancer on top, back to 2000. I thought it will make it cheaper and some tools just easier to implement."}),"\n",(0,i.jsxs)(n.p,{children:["Chatting to GPT I realized - Kubernetes will provide it a way quicker, most of the stuff is just ready to go like network policies, load balancing, SSL, deployment/rollback, health monitoring, resources observability, Istio adoption. Istio is very useful for observability and local first development, it became a new word today - ",(0,i.jsx)(n.strong,{children:"remocal"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"When stepped into the planning I decided to make it even longer.\nI wanted to researched all the kanban boards, unresistable.\nI used to use Trello and it was ok, but using api in power-ups boundaries sucks. Not really somethign I need right now though."}),"\n",(0,i.jsx)(n.p,{children:"I tried Cluckup, it's a laggish joke, even worse than Jira to make you feel you are already enterprise.\nI tried Asana and saw 0 difference with Trello, I spent about 2 minutes to confirm it and exist."}),"\n",(0,i.jsx)(n.h3,{id:"the-ugly-thing",children:"The ugly thing"}),"\n",(0,i.jsx)(n.p,{children:"In the end I found Linear.\nTo be fair it looked ugly, the design is equal to supabase: fonts, buttons."}),"\n",(0,i.jsx)(n.p,{children:"A few minutes later I started catching.\nKeyboard first design - that's what I buy."}),"\n",(0,i.jsx)(n.p,{children:"So I read Linear Method, the framework they apply internally. It was hard to accept it, I think older I get more conservatibe I become, but I dig it anyway.\nThe basic element is an issue. It might have sub-issues. And they might have.\nThey can be collected in a project."}),"\n",(0,i.jsx)(n.p,{children:"There are bunch of other staff I don't use, but I will share it below."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cycle"})," - like a sprint, hate it."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Triage"})," - inbox, it's a boss feature in my opinion, you can aggregate communication channels in a single place, then an on-call person can carry them, create issues or remove."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Initiative"})," - collection of the projects, they can be presented as a time line or a strategy decision, or even a roadmap on a timeline."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"As a result I cooked quite a few cards (48 projects in a backlog \ud83d\ude31\ufe0f\ufe0f\ufe0f\ufe0f\ufe0f\ufe0f)."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"img",src:t(4753).Z+"",width:"1632",height:"1121"})}),"\n",(0,i.jsx)(n.h2,{id:"infra-preparation",children:"Infra preparation"}),"\n",(0,i.jsx)(n.h3,{id:"logging-and-recovery",children:"Logging and recovery"}),"\n",(0,i.jsx)(n.p,{children:"I implemented a simple logging solution combined with a recovery middleware.\nI find logging panic behaviors essential, and instead of separating these middlewares, I combined them for simplicity."}),"\n",(0,i.jsx)(n.p,{children:"There are several ways to handle logging in Go applications:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Inject a logger into every struct"}),"\n",(0,i.jsx)(n.li,{children:"Define a global (singleton) logger"}),"\n",(0,i.jsxs)(n.li,{children:["Inject a logger into ",(0,i.jsx)(n.code,{children:"context.Context"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"I prefer the last approach"})," because it offers the flexibility to:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Add request IDs to log messages, useful when logging in the data layer"}),"\n",(0,i.jsx)(n.li,{children:"Attach additional data fields to the logger for use in middleware, e.g. computed properties in a business layer"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The implementation is straightforward, and you can find the code ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/log/log.go#L72",children:"here"})]}),"\n",(0,i.jsxs)(n.p,{children:["A couple of ",(0,i.jsx)(n.em,{children:"caveats"})," I encountered:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"There\u2019s a timestamp formatting issue in the slog package. It sometimes fails to format correctly, so I added a simple fix:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"if a.Value.Kind() == slog.KindTime {\n  t := a.Value.Time()\n  a.Value = slog.StringValue(t.Format(time.RFC3339))\n}\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"I wanted to adjust the log level based on the HTTP response status: log warnings for client errors (4xx) and errors for server errors (5xx):"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"logFunc := logger.DebugContext\nif resp.status >= 500 {\n  logFunc = logger.ErrorContext\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Finally, I added panic recovery and logged the error:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'defer func() {\n  if recovered := recover(); recovered != nil {\n    logger.ErrorContext(\n      r.Context(), "recovered from panic",\n      ...\n      "recovered", recovered,\n      "stack", string(debug.Stack()),\n    )\n    resp.WriteHeader(http.StatusInternalServerError)\n    if _, err := resp.Write([]byte("internal server error")); err != nil {\n      logger.ErrorContext(r.Context(), "failed to write response", "error", err)\n    }\n  }\n}()\n'})}),"\n",(0,i.jsx)(n.p,{children:"It\u2019s crucial to override the HTTP status during recovery, which is why I had to implement my own response writer."}),"\n",(0,i.jsx)(n.h3,{id:"linter",children:"Linter"}),"\n",(0,i.jsx)(n.p,{children:"I kept my linter setup as simple as possible.\nI don\u2019t use a complex configuration\u2014just a single command added to the Makefile:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.59.1\n"})}),"\n",(0,i.jsx)(n.h3,{id:"authz",children:"AuthZ"}),"\n",(0,i.jsx)(n.p,{children:"My goal was to define the simplest authentication solution, one that could be extended later to support role-based access control (RBAC)."}),"\n",(0,i.jsxs)(n.p,{children:["I considered a few options, including ",(0,i.jsx)(n.strong,{children:"Ory"})," and ",(0,i.jsx)(n.strong,{children:"Keycloak"}),", but both felt like overkill for my needs\u2014too complex and cumbersome.\nI wanted something:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Easy to configure"}),"\n",(0,i.jsx)(n.li,{children:"A single binary to allow self-hosting"}),"\n",(0,i.jsx)(n.li,{children:"With a simple, clear open-source license (like Apache 2.0)"}),"\n",(0,i.jsx)(n.li,{children:"Dependent only on PostgreSQL"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["I initially looked at ",(0,i.jsx)(n.strong,{children:"Logto"}),", a fresh new solution that seemed simple and clean.\nHowever, it felt geared more toward frontend developers rather than backend engineers, and lacked some of the features I needed."]}),"\n",(0,i.jsxs)(n.p,{children:["That\u2019s when I found ",(0,i.jsx)(n.strong,{children:"Zitadel"}),".\nCreated by some of the folks behind Ory, ",(0,i.jsx)(n.strong,{children:"Zitadel"})," has strong security foundations.\nSince I\u2019m building only a backend API, I focused on authZ, using token introspection (i.e., validation), rather than issuing tokens."]}),"\n",(0,i.jsx)(n.p,{children:"It was straightforward to create a service account token for my e2e tests to check the authorization middleware."}),"\n",(0,i.jsx)(n.p,{children:"I also verified that configuring RBAC and identity brokering with providers like Google and GitHub wouldn\u2019t be an issue (i.e., \u201cSign in with Google\u201d)."}),"\n",(0,i.jsx)(n.h3,{id:"generate-api-client",children:"Generate api client"}),"\n",(0,i.jsxs)(n.p,{children:["As I explain in my API design ",(0,i.jsx)(n.a,{href:"https://dennypenta.github.io/mynameis/blog/api-design",children:"page"})," one of the benefits I want to achieve is easy API client generation for multiple languages.\nThe first language, naturally, is Go, as I need it for my e2e tests.\nSince the implementation will change frequently, I\u2019m skipping unit tests for now and focusing on e2e tests to ensure the app\u2019s overall stability."]}),"\n",(0,i.jsx)(n.p,{children:"The client generation involves:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Collecting ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/router.go#L124",children:"API definition"})," from the router (models, routes)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/gen/client.go#L35",children:"Building"})," the data from the definitions to use in the client generation."]}),"\n",(0,i.jsxs)(n.li,{children:["Feeding that data into a ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/gen/templates/client.tpl#L1",children:"template"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The result is a generated Go ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/client/client.go#L11",children:"client"}),". I can easily add other templates later, such as for TypeScript, and use them in my tests."]}),"\n",(0,i.jsx)(n.h3,{id:"defining-e2e-tests",children:"Defining e2e tests"}),"\n",(0,i.jsx)(n.p,{children:"With the generated client, I can now define the simplest setup for my e2e tests."}),"\n",(0,i.jsx)(n.p,{children:"First, I created a Docker image and a Docker Compose setup.\nThese are similar to a regular production environment but with a few additional tricks."}),"\n",(0,i.jsxs)(n.p,{children:["My ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/Dockerfile#L15",children:"Dockerfile"})," includes an extra ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/build/building/multi-stage/#stop-at-a-specific-build-stage",children:"target"})," to run a debugger in the tests:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'FROM builder AS dev\n\n# Install Delve (debugger)\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go install github.com/go-delve/delve/cmd/dlv@v1.23.0\n\nRUN --mount=type=cache,target=/go/pkg/mod/ --mount=type=cache,target="/root/.cache/go-build" go build -gcflags=all="-N -l" -o server ./cmd/server\n\nCMD ["dlv", "--listen=:40000", "--continue", "--headless=true", "--api-version=2", "--accept-multiclient", "exec", "server"]\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Next, I updated my ",(0,i.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/docker-compose.e2e.yaml#L19",children:"Docker Compose"})," file to expose the debugger port and allow clients to attach:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"server:\n  build:\n    context: .\n    dockerfile: Dockerfile\n    target: dev\n  ports:\n    - '8000:8000'\n    - '40000:40000'\n  security_opt:\n    - seccomp:unconfined\n  cap_add:\n    - SYS_PTRACE\n  env_file:\n    e2e.env\n  depends_on:\n    postgrese2e:\n      condition: service_healthy\n  restart: always\n"})}),"\n",(0,i.jsx)(n.p,{children:"I also created a dedicated PostgreSQL instance for e2e tests to keep it separate from my local development environment:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'  postgrese2e:\n    image: postgres:16.3\n    restart: always\n    environment:\n      POSTGRES_HOST_AUTH_METHOD: \'trust\'\n      POSTGRES_DB: tq\n    ports:\n      - "5432:5432"\n    tmpfs:\n      - /var/lib/postgresql/data\n    healthcheck:\n      test: ["CMD-SHELL", "pg_isready -U postgres -d tq"]\n      interval: 3s\n      timeout: 3s\n      retries: 10\n'})}),"\n",(0,i.jsx)(n.p,{children:"Finally, I defined a simple Makefile command to run the tests:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"start-e2e-test-env:\n\tdocker-compose -f docker-compose.e2e.yaml up -d --build\n\t@echo \"Checking e2e test environment is running...\"\n\tuntil $$(curl --output /dev/null --silent --fail http://localhost:8000/healthz); do printf '.'; sleep 1; done && echo \"Service Ready!\"\n\techo 'Service has been started'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"curl"})," loop waits for the service to be ready since the app depends on the database connection, and migrations need to be applied.\nThis kind of delay is common \u2014 you can imagine even more delays due to cache warming, downstream API fetching, etc."]}),"\n",(0,i.jsx)(n.h4,{id:"bye",children:"Bye"}),"\n",(0,i.jsx)(n.p,{children:"Thank you for reading, come here and see what's gonna be in the end."}),"\n",(0,i.jsxs)(n.p,{children:["Repository is here: ",(0,i.jsx)(n.a,{href:"http://github.com/treenq/treenq",children:"http://github.com/treenq/treenq"})]})]})}function h(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},4753:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/few-a8829c782e27ba5f7f88f18ced787cf4.png"},8323:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/gpt-b6084e0c9c75c7a74f335fb999dde350.png"},1151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>o});var i=t(7294);const a={},r=i.createContext(a);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);