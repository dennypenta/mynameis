"use strict";(self.webpackChunkmynameis=self.webpackChunkmynameis||[]).push([[490],{2485:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>d});var r=i(5893),t=i(1151);const s={slug:"api-design",title:"Web API Design: A Simplified Approach",authors:["denis"],tags:["software"]},o=void 0,a={permalink:"/mynameis/blog/api-design",source:"@site/blog/05-api-design/index.mdx",title:"Web API Design: A Simplified Approach",description:"Note: This page won\u2019t teach you how to design an API from scratch, but it will give you insights into how I recently designed one while developing my PaaS.",date:"2024-09-19T20:45:05.000Z",formattedDate:"September 19, 2024",tags:[{label:"software",permalink:"/mynameis/blog/tags/software"}],readingTime:6.06,hasTruncateMarker:!0,authors:[{name:"Denis",title:"Software Experience Dude",key:"denis"}],frontMatter:{slug:"api-design",title:"Web API Design: A Simplified Approach",authors:["denis"],tags:["software"]},unlisted:!1,prevItem:{title:"Unit test in observability",permalink:"/mynameis/blog/unit-test-observability"},nextItem:{title:"PaaS devlog |#0",permalink:"/mynameis/blog/tq-devlog-0"}},l={authorsImageUrls:[void 0]},d=[{value:"Preface",id:"preface",level:2},{value:"The gRPC Shift",id:"the-grpc-shift",level:2},{value:"Bringing gRPC Ideas to the Web",id:"bringing-grpc-ideas-to-the-web",level:2},{value:"My API Design Principles",id:"my-api-design-principles",level:2},{value:"What Does This Achieve?",id:"what-does-this-achieve",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Example Error Response",id:"example-error-response",level:3},{value:"Error Handling in API Handlers",id:"error-handling-in-api-handlers",level:3},{value:"Example from My Application",id:"example-from-my-application",level:3},{value:"Why Use a Custom Error Type?",id:"why-use-a-custom-error-type",level:2},{value:"Epiloge",id:"epiloge",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note"}),": This page won\u2019t teach you how to design an API from scratch, but it will give you insights into how I recently designed one while developing my ",(0,r.jsx)(n.a,{href:"https://github.com/treenq/treenq",children:"PaaS"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"preface",children:"Preface"}),"\n",(0,r.jsx)(n.p,{children:"Feel free to skip to the next section if you want to avoid the backstory."}),"\n",(0,r.jsx)(n.p,{children:"After working with various communication protocols (e.g., web form-data, REST, JSON-RPC 2.0), I\u2019ve realized that many of them aim to cover a wide range of use cases. This broad focus introduces a lot of complexity:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Network implementations require special handling, such as decoding domain-level errors into transport error codes and messages."}),"\n",(0,r.jsx)(n.li,{children:"Encoding and decoding messages require marshalling domain models into protocol-specific formats."}),"\n",(0,r.jsx)(n.li,{children:"Protocols like REST involve lengthy discussions about naming conventions and URL structures."}),"\n",(0,r.jsx)(n.li,{children:"Some protocols, like JSON-RPC, demand custom solutions, such as middleware for handling requests."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"These factors complicate implementations and slow down team agreements."}),"\n",(0,r.jsx)(n.h2,{id:"the-grpc-shift",children:"The gRPC Shift"}),"\n",(0,r.jsx)(n.p,{children:"When I started working with gRPC, it introduced some important improvements:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Models are generated automatically."}),"\n",(0,r.jsx)(n.li,{children:"Service interfaces are provided and generated."}),"\n",(0,r.jsx)(n.li,{children:"Clients are generated, allowing you to focus on just creating requests."}),"\n",(0,r.jsx)(n.li,{children:"Error codes are simplified, reducing them from hundreds to around 15 (which is still more than needed, but we\u2019ll get to that)."}),"\n",(0,r.jsxs)(n.li,{children:["The error format is predefined, so you don\u2019t have to design it\u2014just reuse ",(0,r.jsx)(n.a,{href:"https://cloud.google.com/apis/design/errors",children:"the model"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"And I liked. I don't know who didn't."}),"\n",(0,r.jsx)(n.p,{children:"I loved it. Most people who use gRPC feel the same.\nHowever, gRPC doesn\u2019t naturally align with web browsers due to its reliance on HTTP/2, often necessitating additional layers to adapt to HTTP/1.1.\nStill, browser compatibility remains a common requirement."}),"\n",(0,r.jsx)(n.h2,{id:"bringing-grpc-ideas-to-the-web",children:"Bringing gRPC Ideas to the Web"}),"\n",(0,r.jsxs)(n.p,{children:["This made me think: what can we adopt from gRPC for web APIs? The most obvious feature is ",(0,r.jsx)(n.strong,{children:"code generation"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Swagger attempts client generation but introduces its own challenges:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:'Swagger has too many plugins, requires specific formats, and its "standard" is fragmented. Many web renderers are incompatible with each other. For example, Apiary\u2019s requirements may contradict code generation.'}),"\n",(0,r.jsx)(n.li,{children:"Swagger focuses on defining documentation instead of the API itself, adding complexity."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["The I discovered ",(0,r.jsx)(n.a,{href:"https://trpc.io/docs/quickstart",children:"tRPC"}),", which offered many things I\u2019d been hoping for\u2014network handling as a natural consequence of defining models.\nThe catch? It\u2019s limited to JavaScript."]}),"\n",(0,r.jsx)(n.p,{children:"So, I decided to design my own API approach."}),"\n",(0,r.jsx)(n.h2,{id:"my-api-design-principles",children:"My API Design Principles"}),"\n",(0,r.jsx)(n.p,{children:"Here are the guiding principles I followed:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"It must be built on top of HTTP to support the web."}),"\n",(0,r.jsxs)(n.li,{children:["No URL queries, forms, or arguments in the path\u2014these overcomplicate things. Most people don\u2019t even know that URL queries are essentially ",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Multimap",children:"multimaps"}),", which leads to more bugs."]}),"\n",(0,r.jsx)(n.li,{children:"Every API call uses only POST. The payload is always in the body, and for simplicity, in my case, it\u2019s JSON."}),"\n",(0,r.jsxs)(n.li,{children:["The procedure naming follows the same conventions we use in code. For instance, instead of REST\u2019s ",(0,r.jsx)(n.code,{children:"/users/{id}/wallet"}),", I use ",(0,r.jsx)(n.code,{children:"/getUserWallet"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"what-does-this-achieve",children:"What Does This Achieve?"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"I only define the models I need \u2014 no extra complexity."}),"\n",(0,r.jsx)(n.li,{children:"Optionally, I can add descriptions to make the generated documentation more talkative."}),"\n",(0,r.jsx)(n.li,{children:"From the defined router, I can generate both the client code and the API specification (including Swagger)."}),"\n",(0,r.jsx)(n.li,{children:"The code generation process is simplified: a single - word URL, consistent HTTP method, and uniform marshalling strategy make everything easy to implement and maintain."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsx)(n.p,{children:"Error handling is a crucial part of any API design, and the model needs to be flexible enough to cover a wide range of scenarios.\nBased on my experience, a simple yet effective error model looks like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"type Error struct {\n  Code    string\n  Message string\n  Meta    map[string]any\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Code"}),": This holds a unique value that identifies the specific issue.\nIt helps narrow down the location of the problem in the code and quickly leads developers to the exact line or area where the error occurred. Additionally, it provides clear guidance to users about the expected behavior or how to resolve the issue."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Message"}),": The message field can serve a dual purpose:","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"UserMessage"}),": This is a user-friendly message that can be translated into different languages on the server side. It's meant to be shown in the user interface to guide the user."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"DevMessage"}),": This contains a technical explanation intended for developers or logs. It explains what went wrong, why it happened, and what actions can be taken to resolve it.\nWhile you could use a single string for both, in complex applications with internationalization (i18n) needs, separating them into two distinct lines would help."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Meta"}),": This is a flexible map that can contain any additional context or metadata about the error. For example, if you're validating a form with multiple fields, the Meta map can list which fields failed validation and why."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"example-error-response",children:"Example Error Response"}),"\n",(0,r.jsx)(n.p,{children:"Here\u2019s an example of how this error model might be used in a real-world scenario. Suppose a user submits a tax form with several invalid fields. The API can return an error response like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'Error{\n  Code: "TAX_FORM_INVALID",\n  Meta: map[string]any{\n    "tax_class": "expected a number between 1 and 4",\n    "house_number": "must be a number",\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"In this example:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.strong,{children:"Code"})," is ",(0,r.jsx)(n.code,{children:'"TAX_FORM_INVALID"'}),", which indicates a validation failure specific to the tax form."]}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.strong,{children:"Meta"})," map provides detailed feedback on specific fields (",(0,r.jsx)(n.code,{children:"tax_class"}),", ",(0,r.jsx)(n.code,{children:"house_number"}),") that need attention, making it easier for the user to correct their input."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"error-handling-in-api-handlers",children:"Error Handling in API Handlers"}),"\n",(0,r.jsx)(n.p,{children:"In my API, the handler interface is designed to consistently return errors using this model.\nThis ensures that all errors adhere to a common structure, simplifying error handling on both the client and server side."}),"\n",(0,r.jsx)(n.p,{children:"For instance, a typical API handler might look like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"GetProfile(ctx context.Context, _ struct{}) (GetProfileResponse, *Error)\n"})}),"\n",(0,r.jsx)(n.p,{children:"Here, instead of returning a plain error, the handler returns a pointer to the *Error type.\nThis approach ensures that any error returned strictly follows the predefined error format."}),"\n",(0,r.jsx)(n.h3,{id:"example-from-my-application",children:"Example from My Application"}),"\n",(0,r.jsx)(n.p,{children:"Here\u2019s a practical example of how I\u2019ve implemented this in my app:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'package domain\n\nimport (\n    "context"\n    "github.com/treenq/treenq/pkg/vel"\n)\n\ntype GetProfileResponse struct {\n    Email    string `json:"email"`\n    Username string `json:"username"`\n    Name     string `json:"name"`\n}\n\nfunc (h *Handler) GetProfile(ctx context.Context, _ struct{}) (GetProfileResponse, *vel.Error) {\n    profile := h.authProfiler.GetProfile(ctx)\n    return GetProfileResponse{\n        Email:    profile.Email,\n        Username: profile.Username,\n        Name:     profile.Name,\n    }, nil\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"In this code:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"GetProfile"})," function fetches the user profile and returns it as a ",(0,r.jsx)(n.code,{children:"GetProfileResponse"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["The second return value is ",(0,r.jsx)(n.code,{children:"*Error"})," instead of a generic ",(0,r.jsx)(n.code,{children:"error"}),", making it clear that the function follows the structured error format."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"why-use-a-custom-error-type",children:"Why Use a Custom Error Type?"}),"\n",(0,r.jsxs)(n.p,{children:["By using a custom ",(0,r.jsx)(n.code,{children:"Error"})," type instead of the standard ",(0,r.jsx)(n.code,{children:"error"}),", we enforce consistency across the API.\nThe error itself still implements Go\u2019s built-in ",(0,r.jsx)(n.code,{children:"error"})," interface, allowing it to work seamlessly with existing Go error-handling patterns.\nHowever, the benefit is that every error now carries additional structured information, like the error code and metadata, making it easier to debug and handle errors programmatically."]}),"\n",(0,r.jsx)(n.h2,{id:"epiloge",children:"Epiloge"}),"\n",(0,r.jsx)(n.p,{children:'I ended up building a "framework" in Go on top of net/http that is able to generate clients for any language.'}),"\n",(0,r.jsxs)(n.p,{children:["You can check it out ",(0,r.jsx)(n.a,{href:"https://github.com/treenq/treenq/blob/main/pkg/vel/router.go",children:"here"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"I don\u2019t recommend using it as-is \u2014 it\u2019s better to copy and adapt it for your own needs."})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},1151:(e,n,i)=>{i.d(n,{Z:()=>a,a:()=>o});var r=i(7294);const t={},s=r.createContext(t);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);