<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">How Treenq builds workload images | Denny&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://dennypenta.github.io/mynameis/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://dennypenta.github.io/mynameis/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://dennypenta.github.io/mynameis/blog/container-in-container-09"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="How Treenq builds workload images | Denny&#x27;s blog"><meta data-rh="true" name="description" content="Build a container inside a rootless conatiner"><meta data-rh="true" property="og:description" content="Build a container inside a rootless conatiner"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-06-01T21:59:56.000Z"><meta data-rh="true" property="article:tag" content="software,paas"><link data-rh="true" rel="icon" href="/mynameis/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://dennypenta.github.io/mynameis/blog/container-in-container-09"><link data-rh="true" rel="alternate" href="https://dennypenta.github.io/mynameis/blog/container-in-container-09" hreflang="en"><link data-rh="true" rel="alternate" href="https://dennypenta.github.io/mynameis/blog/container-in-container-09" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/mynameis/blog/rss.xml" title="Denny&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mynameis/blog/atom.xml" title="Denny&#39;s blog Atom Feed"><link rel="stylesheet" href="/mynameis/assets/css/styles.255ed7f8.css">
<script src="/mynameis/assets/js/runtime~main.26cb761a.js" defer="defer"></script>
<script src="/mynameis/assets/js/main.e52686ee.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mynameis/"><b class="navbar__title text--truncate">hi! Im Denis</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/mynameis/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/web-sucks">Web in 2026 is a tragedy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/tq-devlog-1">PaaS devlog |#1</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/mynameis/blog/container-in-container-09">How Treenq builds workload images</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/gopls-08">gopls: how your IDE becomes better every day</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/go-dockerfile">Go Dockerfile</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Build a container inside a rootless conatiner"><header><h1 class="title_f1Hy" itemprop="headline">How Treenq builds workload images</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-06-01T21:59:56.000Z" itemprop="datePublished">June 1, 2025</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Denis</span></div><small class="avatar__subtitle" itemprop="description">Software Experience Dude</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-a-container-inside-a-rootless-conatiner">Build a container inside a rootless conatiner<a href="#build-a-container-inside-a-rootless-conatiner" class="hash-link" aria-label="Direct link to Build a container inside a rootless conatiner" title="Direct link to Build a container inside a rootless conatiner">​</a></h2>
<p>A PaaS has a very dev friendly use case: when a user just conneects a repository we must build the image from a Dockerfile in the repo.
We assume at the beginning a team doesn&#x27;t have a CI pipeline and wants to share a quick demo to the customers.
There are many ways to do it. Let&#x27;s look at all of them and at the design we chosed for <a href="https://github.com/treenq/treenq" target="_blank" rel="noopener noreferrer">Treenq</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grug-docker-in-docker">Grug: docker in docker<a href="#grug-docker-in-docker" class="hash-link" aria-label="Direct link to Grug: docker in docker" title="Direct link to Grug: docker in docker">​</a></h3>
<p>As a straight forward approach we can forward docker host to a container and build it.
It has quite a lot of problems:</p>
<ul>
<li>dind requirees running in privileged mode: it opens a rabbit hole to a host machine</li>
<li>moreover, it doesn&#x27;t seem an option to make it rootless</li>
<li>docker daemon is running, it&#x27;s not free for resources</li>
</ul>
<p>Even to get started the user case it didn&#x27;t seem convinient, it requires configuration to make it possible, so I decided to move to more secure options.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kaniko-k8s-native-builder">Kaniko: k8s native builder<a href="#kaniko-k8s-native-builder" class="hash-link" aria-label="Direct link to Kaniko: k8s native builder" title="Direct link to Kaniko: k8s native builder">​</a></h3>
<p>Kaniko is created to solve this problem.
It allows setting up an environemnt for a cluster where the workload is built near it&#x27;s runners, perhaps on different nodes in order to avoid any resource fight.
The idea is it spans a new container that builds an image, the container feels great in unprivileged environment and doesn&#x27;t require a docker daemon.</p>
<p>Technically it doesn&#x27;t create a new namespace, instead it unpacks an image layer and does chroot.</p>
<p>You can even span your registry right in this cluster, like a regular one or <a href="https://github.com/goharbor/harbor" target="_blank" rel="noopener noreferrer">Harbor</a> and the builds flow is completely isolated from the planet.
It like like <strong>kaniko -&gt; registry -&gt; k8s workload node</strong>.</p>
<p>In terms of security Kaniko is the winner.
It does require root to run, but the abstraction is well done to keep it away.</p>
<p>Looks fancy, but has a couple restrictions:</p>
<ul>
<li>it buidls containers only inside a Kubernetes cluster, it works in k8s, k3s (which we use for e2e tests) and perhaps some more.</li>
<li>it has no more capabilities, if I need to inspect an image.</li>
<li>it&#x27;s not able to build windows images</li>
<li>build time performance is slightly lower</li>
</ul>
<p>For instance, I want to rollback, I want it real quick, so before launching a build job I want to look if the image is in the registry.
For that purpose I must use skopeo or another tool to talk to a registry.
Not really a big deal.
Perhaps, one day Treenq will need <a href="https://github.com/containers/skopeo" target="_blank" rel="noopener noreferrer">Skopeo</a>.</p>
<p>Looking back it looks a good option and most likely I would say it&#x27;s worth trying it.
But I thought it&#x27;s very important to have a capability to run builds outside of a cluster, may be even on a isoalted VM, which is not really smart requirement I guess.
Also, the complexity to set it up didn&#x27;t look easy enough, I have to span a k8s resource, make a ServiceAccount for it and many more to start building + adding inspection API near by.</p>
<p>On top of that, recently, Kaniko stepped down right into arhive.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="buildah-isolated-package">Buildah: isolated package<a href="#buildah-isolated-package" class="hash-link" aria-label="Direct link to Buildah: isolated package" title="Direct link to Buildah: isolated package">​</a></h3>
<p><a href="https://github.com/containers/podman" target="_blank" rel="noopener noreferrer">Podman</a>, a Docker alternative, has a way cleaner opensource relation and how they structure the packages and repositories.
Podman has a designated module, <a href="https://github.com/containers/buildah" target="_blank" rel="noopener noreferrer">Buildah</a>, which is used exactly for building images.
It requires no priovileges, root, daemon, nothing (technically speaking, but there is a price for it).</p>
<p>It doesn&#x27;t require a daemon to run.
Package is written in Go, therefore I can embed it right into the service instead of adding a syscall.</p>
<p>DISCLAIMER: I understand I use undocumented API of the package and it can hurt it. If it happens I can freeze the version, and then either the project fulfills the graveyard or it migrates to buildkit.</p>
<p>First step is to understand how to run buidlah in a container.
There is an official <a href="https://hub.docker.com/r/buildah/buildah" target="_blank" rel="noopener noreferrer">image</a> based on Fedora, but I want my app run at least in Ubuntu.
Better in alpine/scratch ofc, but it doesn&#x27;t seem viable.</p>
<p>There are a some guides on <a href="https://developers.redhat.com/blog/2019/08/14/best-practices-for-running-buildah-in-a-container" target="_blank" rel="noopener noreferrer">how to run buildah in a container</a> and <a href="https://opensource.com/article/19/3/tips-tricks-rootless-buildah" target="_blank" rel="noopener noreferrer">in privileged environment</a>, so I can slowly transform this information to prepare Ubuntu image.
Here is what I got <a href="https://github.com/treenq/treenq/blob/main/Dockerfile" target="_blank" rel="noopener noreferrer">eventually</a>.</p>
<p>Ok, we can build, next step I want to build a small image from Go application.</p>
<p>There is a <a href="https://github.com/containers/buildah/blob/main/docs/tutorials/04-include-in-your-build-tool.md" target="_blank" rel="noopener noreferrer">guilde</a> showing how programmatically execute dockerfile steps (run, copy, etc.), but it&#x27;s not what we need.
We simply need to run <code>buildah build</code>.</p>
<p>At this point I have to dig the source code to understand what&#x27;s happening.
Jumping right inside the build command in the source code we find there is a storage resource is required to start and we can execute the build</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	buildStoreOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">DefaultStoreOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	buildStore</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetStore</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">buildStoreOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And next step we can start build:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> imagebuildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">BuildDockerfiles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> buildStore</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> define</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">BuildOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		ContextDirectory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">         a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Output</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">           args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">              out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">              errOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		ReportWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     reportOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		IgnoreFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     dockerignorePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		AdditionalTags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">FullPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Dockerfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To push the image we need to get a reference to this image in our store and prepare system context: registry authentication, tls flags, certs.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	storeRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> alltransports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ParseImageName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;docker://&quot;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">FullPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	systemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SystemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		DockerCertPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">              a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registryCertDir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		DockerInsecureSkipTLSVerify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewOptionalBool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registryTLSVerify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		DockerAuthConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">            </span><span class="token operator">&amp;</span><span class="token plain">types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DockerAuthConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			IdentityToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registryToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">=</span><span class="token plain"> buildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> storeRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> buildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">PushOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Store</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">         a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		SystemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> systemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Full version of this module is <a href="https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>One important detail: first lines of your main function must be:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> buildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">InitReexec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	unshare</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">MaybeReexecUsingUserNamespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It matters to act Buildah as root without being real rool.
It locks the OS thread, prepares uid/gid mapping and reexec as a new user in a new namespace.
So, softly speaking, it&#x27;s not ideal to run this code inside the application code.</p>
<p>The best design would be to have the application code isolated from pool of builders. Builders can receive the build tasks and still execute it inside a Go app in order to being able to extend he capabilities.
This design allows me to extend options to build images: In a similar manner I can embed buildpacks to build simpler apps without a Dockerfile.</p>
<p>Buildah, unfortunately, also has a few caveats and it&#x27;s a little behined of docker.</p>
<ul>
<li>For instance buildah can&#x27;t inject variables/secrets <a href="https://github.com/containers/buildah/issues/5892" target="_blank" rel="noopener noreferrer">on RUN command</a> while docker can.</li>
<li>Or it can&#x27;t detect <a href="https://github.com/containers/buildah/issues/5408" target="_blank" rel="noopener noreferrer">variables in images</a></li>
<li>Also, runniong it unprivileged is quite tricky and it requires specific arguments for container and specific build of the image itself.
The domain is huge to learn, different backends, storages drivers and so on.</li>
</ul>
<p>From this <a href="https://github.com/containers/buildah/issues/2554" target="_blank" rel="noopener noreferrer">issue</a> I learned vfs storage driver copies the entire sublayer on every layer.
So it&#x27;s better to use overlayfs, it requires /dev/fuse to run in non privileged container.</p>
<p>As a bonus, it might be cool to put it inside alpine, but not sure it&#x27;s viable at all.
Putting a cgo app itself requires some <a href="https://baicai.xlog.app/docker_golang_alpine_cgo_build?locale=en" target="_blank" rel="noopener noreferrer">dance</a> for it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="buildkit-overlooked-option">BuildKit: overlooked option<a href="#buildkit-overlooked-option" class="hash-link" aria-label="Direct link to BuildKit: overlooked option" title="Direct link to BuildKit: overlooked option">​</a></h3>
<p>What if docker could get rid of priviileged mode?</p>
<p>Buildx (BuildKit) is a module of docker (or moby?) that&#x27;s responsible specifically for building iamges.</p>
<p>BuildKit still has a daemon and it requires a privileged mode either.</p>
<p>However, we can run fake root using <a href="https://github.com/rootless-containers/rootlesskit/" target="_blank" rel="noopener noreferrer">RootlessKit</a>.
We can build our flow in the following way:</p>
<ul>
<li>run a daemon</li>
<li>run buildctl to start build</li>
<li>when we are done we close the daemon</li>
</ul>
<p>RootlessKit requires turning off apparmor and seccomp, because the default profile doesn&#x27;t allow spawning new namespaces.
Also, add a few linux capabilities like SETUID, SETGUID and fake root users removing the option no-new-privileges.</p>
<p>It seems quite secure, but has a few constraints:</p>
<ul>
<li>requires support explicit uid and gid which is not fine and might be annoyign</li>
<li>requires supporting a designated pool of build machines, which is actually makes sence in terms of designing a PaaS, but makes it a way complicated to start</li>
</ul>
<p>In case of buildah it required me to run the build in the same application.
In order to scale it well I have to build network transport and mount volumes between them, which makes it quite complicated to setup.</p>
<p>Buildkit provides its capabilities out of the box. It makes its API a bit  harder to learn, since it&#x27;s not documented well and perhaps not supposed to be used like that.</p>
<p>Buildkit brings to main modules to the table:</p>
<ul>
<li>buildkitd - a daemon to serve the builds, it may expose a unix socker to tcp connection</li>
<li>buildctl - the actual buildkit client</li>
</ul>
<p>Now it requires to to setup additional container buildkitd and write a client part inside my Go service.
As a benefit I get rid of building images and buildkit dependencies.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">buildkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> moby/buildkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v0.23.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">privileged</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> buildkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1234:1234&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./buildkit/entrypoint.sh</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/entrypoint.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./buildkit/buildkitd.toml</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/etc/buildkit/buildkitd.toml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./registry/certs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/certs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./buildkit/certs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/buildkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">entrypoint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/entrypoint.sh&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">healthcheck</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;CMD-SHELL&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;buildctl --addr tcp://localhost:1234 debug workers&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">interval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 5s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 30s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">retries</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">extra_hosts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;localhost:host-gateway&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>entrypoint specifies the arguments to run, it overrides the default address to tcp.
buildkitd mostly contains registry and service access and its TLS to test and support self signed certs flow.
Buildkit not only builds images, but also pushes them, therefore it requires access to the registry. Since my service has acces to the local registry as to localhost I want my buildkit access it on localhost too, therefore I define extra_hosts there.
Without the extra_hosts config registry will be available on registry host as define in the rest of the docker-compose.yaml.</p>
<p>Full example is here: <a href="https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go" target="_blank" rel="noopener noreferrer">https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go</a></p>
<p>docker-compose is in the root of the repo.</p>
<p>Final design of the platform is the following:
<img loading="lazy" alt="img" src="/mynameis/assets/images/design-2f0fa17a45b1b84f1404c7ee75031b27.svg" width="1938" height="1279" class="img_ev3q"></p>
<p>Happy to answer your questions below in the comments</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mynameis/blog/tags/software">software</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mynameis/blog/tags/paas">paas</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/mynameis/blog/tq-devlog-1"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">PaaS devlog |#1</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/mynameis/blog/gopls-08"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">gopls: how your IDE becomes better every day</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#build-a-container-inside-a-rootless-conatiner" class="table-of-contents__link toc-highlight">Build a container inside a rootless conatiner</a><ul><li><a href="#grug-docker-in-docker" class="table-of-contents__link toc-highlight">Grug: docker in docker</a></li><li><a href="#kaniko-k8s-native-builder" class="table-of-contents__link toc-highlight">Kaniko: k8s native builder</a></li><li><a href="#buildah-isolated-package" class="table-of-contents__link toc-highlight">Buildah: isolated package</a></li><li><a href="#buildkit-overlooked-option" class="table-of-contents__link toc-highlight">BuildKit: overlooked option</a></li></ul></li></ul></div></div></div></div></div></div>
</body>
</html>