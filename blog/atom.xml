<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://dennypenta.github.io/mynameis/blog</id>
    <title>Denny's blog Blog</title>
    <updated>2026-01-06T22:22:27.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://dennypenta.github.io/mynameis/blog"/>
    <subtitle>Denny's blog Blog</subtitle>
    <icon>https://dennypenta.github.io/mynameis/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Web in 2026 is a tragedy]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/web-sucks</id>
        <link href="https://dennypenta.github.io/mynameis/blog/web-sucks"/>
        <updated>2026-01-06T22:22:27.000Z</updated>
        <summary type="html"><![CDATA[Context]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="https://dennypenta.github.io/mynameis/blog/web-sucks#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2>
<p>I do software for 10 years.
At the beginning I did pure web: django, backbone, jquery, gulp, react, you know.</p>
<p>Since then the rest of my career I did mostly Go backends: some data processing from elastic to postgres, from kafka to mongo, kubernetes integrations, terraform providers, javascript sandboxes and just simple RESTful APIs.
I have a few friends from web, mobile dev and I tried developing a desktop app, so to me it feels easy to imagine what to expect developing a declarative UI.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-do-i-want-to-see-in-a-development-flow">What do I want to see in a development flow?<a href="https://dennypenta.github.io/mynameis/blog/web-sucks#what-do-i-want-to-see-in-a-development-flow" class="hash-link" aria-label="Direct link to What do I want to see in a development flow?" title="Direct link to What do I want to see in a development flow?">​</a></h3>
<ol>
<li>Declarative UI. I don't mind seeing XML like things in desktop or mobile, so I anticipate having old fashion HTML with a few tricks is ok.</li>
<li>Strict schema. In a designated API service ideally we have OpenAPI. But we do web, right? I see 2 options:<!-- -->
<ul>
<li>we have the schema first and generate code for both a client with options to inject interceptors, for instance to inject an auth token from the cookies (pls don't use local store for auth tokens). Protobuf provides this kind of experience, I can't get why it's not deeply in the culture to have same standard with OpenAPI, or Swagger if you will</li>
<li>or we have a server that defines client's available methods to call and its data model</li>
</ul>
</li>
<li>Predictability. We all need debug the apps sooner or later. And if you are for a while in the industry you want to go deeper to the function definition to read its source in order to understand the problem. It makes reading documentation a bit easier and learning process smoother. "No magic" term is fine for me.</li>
<li>Clear separation of concerns. Back then in django/rails/etc. We had a view layer and we knew it's the only layer might be exposed to the user. I wouldn't say it was easy to understand how to expose sensitive data to the client, but it was simple.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="so-how-was-it-10-years-ago">So how was it 10 years ago?<a href="https://dennypenta.github.io/mynameis/blog/web-sucks#so-how-was-it-10-years-ago" class="hash-link" aria-label="Direct link to So how was it 10 years ago?" title="Direct link to So how was it 10 years ago?">​</a></h3>
<p>Suboptimal.
People were looking for decent approaches to build web.</p>
<p>Since then we have amazing changes in web:</p>
<ol>
<li>tailwind: it's not only about dev experience, but a huge jump to reduce client bundle size dramatically. It's even more beneficial for dummies like me, having such a simple tool to produce efficient UIs, it feels amazing.</li>
<li>Tons of headless UI libraries and shadcn, it gave every small team the ability to establish its design system in 20 minutes, huge step forward.</li>
<li>Vite is a standard for building apps. It has so many smart moves in there increasing quality for anyone who steps into it, while webpack made manually come up with things to minimize the bundle.</li>
<li>React and friends. For anyone touching it it's clear - it makes sense. Having HTML right in the view layer shows you the markup of the component and its state. After things like dojo and backbone - ofc it's a way better.</li>
<li>Astro. Not well adopted yet, but static content also jumped forward. Behind vite config it hides dead simply but efficient idea - islands. Im pretty sure it gotta change SSR and SSG forever.</li>
</ol>
<p>Well, lots of positive things, let's build an app after a long break.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="picking-ui">Picking UI<a href="https://dennypenta.github.io/mynameis/blog/web-sucks#picking-ui" class="hash-link" aria-label="Direct link to Picking UI" title="Direct link to Picking UI">​</a></h2>
<p>React. Well, it's changed a lot.
I don't want to be an old farter who complains on changes, but there are tons of features people rarely use.
Ok, it's a matter of taste.
But it made the bundle size jumping ridiculously high, it's not ok.
Treeshaking you tell me? Doesn't seem it helps much, it's still the most bloated UI library.
We thought progressive internet quality and speed around the globe, but we make software worse to make the progress diminishing.</p>
<p>Vue has a bunch of magic where a "property" is not case sensitive may break the entire app, seems odd to me.</p>
<p>The only 2 real alive alternatives are Svelte and Solid.
Svelte is clearly taking a track to become the modern rails and Im not very fond of it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="giving-it-api">Giving it API<a href="https://dennypenta.github.io/mynameis/blog/web-sucks#giving-it-api" class="hash-link" aria-label="Direct link to Giving it API" title="Direct link to Giving it API">​</a></h2>
<p>There are many options today:</p>
<ul>
<li>Write a regular api service, generate OpenAPI, generate models, etc.</li>
<li>Use trpc/orpc like and generate API from that. To me it feels correct, we have a strict schema communication, breaking on one side we have a type error on the other. Then generating a schema from the implementation we document what we implemented instead of promising what we plan to implement. This approach eliminates overpromising and that's a big deal. We can see its evolution in svelte remote functions and similar attempts in next/nuxt/solid ecosystems.</li>
</ul>
<p>Adding Next JS to React apparently make it even larger in bundle size, so not every meta framework is a good choice.
But not having a meta framework makes SSR a way harder.</p>
<p>There are alternatives to solve SSR with traditional backends like inertia.js, but having different languages don't give so much joy of immediate data types sync between server and client apps. After touching trpc/orpc it feels wrong.
If I need a niche purpose backends like Go for integration with networking services chances I need SSR close to 0, so I can generate openapi from it and then client models with 0 worries.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-all-together">Building all together<a href="https://dennypenta.github.io/mynameis/blog/web-sucks#building-all-together" class="hash-link" aria-label="Direct link to Building all together" title="Direct link to Building all together">​</a></h2>
<p>What do we have left if I want:</p>
<ul>
<li>small bundle size</li>
<li>decent performance</li>
<li>well defined unified API layer</li>
<li>no magic solution</li>
<li>SSR</li>
</ul>
<p>I have nothing.</p>
<p>Traditional backends + inertial.js may save us, but introduce tons of others complexities, so in the best world we look the answer in the meta frameworks.</p>
<p>React is no go with a raw bundle size of ~100kb today, adding any UI library makes it at 150, adding a bit of code makes it 300+ in the best case.</p>
<p>Vue might be very close, but having case insensitive attributes drive me nuts. things like <code>v-for="item in items"</code> undebuggable. how do I know the items there is what I meant? no way, only to run the app and take a look or pray my team writes the tests. A single typo may destroy a page.</p>
<p>Svelte is promising in quality: small bundle size, great performance.
But so much magic frustrates me.
Like in rails there is no logic, everything is declarations of the concepts.
I have to learn the framework instead of software fundamentals to understand $state, +page is not just a file name and a remote function is the actual API call depending on the execution context (server or client).
It doesn't give "simple" solution, but gifts the "simplicity" with the price of an abstraction layer worse than ever before.
And all of it with the mixed context where is the server where is the client makes it even worse.</p>
<p>Solid has all the UI benefits of React, all the performance benefits of svelte.
But doesn't have any adoption. Its UI libraries are months passed since the last commit.
Solid itself and Solid Start have 3 weeks gap since the last commit.
Im more than confident it's simply due to lack of financial support and the need of having a commercial job for the maintainers.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://dennypenta.github.io/mynameis/blog/web-sucks#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Closer to finish I find this 30 minutes writing as a pure nagging about sveltekit having too much magic and solid not enough adoption. Although most of the people don't share same feeling.</p>
<p>It's surprisingly (no, it's not) sad to me people had better learning frameworks than software itself.</p>
<p>People don't like simplicity and it frustrates me as very few people look for it.</p>
<p>Accept the rules, take whatever worse we have I guess and keep going if you need web.
I would be happy to see Solid having independent financing and larger community engaging.</p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="software" term="software"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[PaaS devlog |#1]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/tq-devlog-1</id>
        <link href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1"/>
        <updated>2026-01-01T18:27:10.000Z</updated>
        <summary type="html"><![CDATA[Devlog #1: github apps, docker builder, cdk8s]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="devlog-1-github-apps-docker-builder-cdk8s">Devlog #1: github apps, docker builder, cdk8s<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#devlog-1-github-apps-docker-builder-cdk8s" class="hash-link" aria-label="Direct link to Devlog #1: github apps, docker builder, cdk8s" title="Direct link to Devlog #1: github apps, docker builder, cdk8s">​</a></h2>
<p>Today I want to share with you my next steps of creating PaaS from scratch.
On this page I will cover how I implement a basic deployment flow.</p>
<p>The service has the first api call. It's a github webhook, when a merge to main/master comes I spin a container from it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="github-apps">Github apps<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#github-apps" class="hash-link" aria-label="Direct link to Github apps" title="Direct link to Github apps">​</a></h3>
<p>In order to listen users' repository changes it's not necessary to use oauth anymore.
I can create a <a href="https://docs.github.com/en/apps/overview" target="_blank" rel="noopener noreferrer">github app</a>, kinda register an app and let my users to install it.
This app will let me listen the events the users accepted.</p>
<p>To make the github webhook secure they provide sha in the headers so I implemented a <a href="https://github.com/treenq/treenq/blob/main/pkg/crypto/signature.go" target="_blank" rel="noopener noreferrer">verifier</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="app-definition">App definition<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#app-definition" class="hash-link" aria-label="Direct link to App definition" title="Direct link to App definition">​</a></h3>
<p>Usually users configure an app using a yaml or click buttons.
We don't consider terraform for now, it's also viable, but we want a quick solution.</p>
<p>I do plan implement a yaml, but now I want to focus on definition as code. I believe it's gonna give me more flexibility and give the users faster access to the app resources such as a database credentials.</p>
<p>So I expected a <code>tq</code> module in a go app like this:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> tq</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	tqsdk </span><span class="token string" style="color:rgb(255, 121, 198)">"github.com/treenq/treenq/pkg/sdk"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">tqsdk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Space</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> tqsdk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Space</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"treenq-poc"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Region</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"fra1"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tqsdk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			DockerfilePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Dockerfile"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			SizeSlug</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">       </span><span class="token string" style="color:rgb(255, 121, 198)">"basic-xxs"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">           </span><span class="token string" style="color:rgb(255, 121, 198)">"treenq-poc-service"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			HttpPort</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">       </span><span class="token number">8000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			InstanceCount</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Eventually I want to come up with an idea how a user can map this model to the resources, but now I just want to retrieve the config a user defined such a Dockerfile path and the http port to expose.</p>
<p>So I did a builder package to generate a temporary folder, places this config in there, calls that <code>Build</code> func and reads the given config as a json output.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="build-an-image">Build an image<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#build-an-image" class="hash-link" aria-label="Direct link to Build an image" title="Direct link to Build an image">​</a></h3>
<p>I found an official repo for <a href="https://github.com/docker/buildx" target="_blank" rel="noopener noreferrer">buildx</a>, it's in Go so I can embed it.
But it looks quite a big challenge to solve, it's even scary to imagine the investigation to start using buildx, I would need to:</p>
<ul>
<li>run buildx command locally with a buildx debugger</li>
<li>catch the exact function that builds an image</li>
<li>understand all the dependencies and the way to build it</li>
<li>put it into my service and make it work</li>
</ul>
<p>So now Im fine just call <code>docker build</code> from CLI.
I definitely want to get back to buildx, but no clue when.</p>
<p>After tagging the image I need to push it, so I added registry to my docker compose.
It couldn't be simpler:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">2.8.3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"5000:5000"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy">Deploy<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#deploy" class="hash-link" aria-label="Direct link to Deploy" title="Direct link to Deploy">​</a></h3>
<p>Now I can deploy the image. This part is tricky. I couldn't really understand what Im gonna do here.</p>
<p>So I found <a href="https://cdk8s.io/" target="_blank" rel="noopener noreferrer">cdk8s</a>.
Initially I defined a testing definition.
Seems work, even can return me a yaml output.
Unfortunately, it brings node runtime under the hood, but it pays off now.</p>
<p>So Im taking the <code>tq</code> app definition I showed earlier and create a k8s <a href="https://github.com/treenq/treenq/blob/6919be57726109ff3f37ce484db3d2457b4cb01e/src/services/cdk/kube.go#L38" target="_blank" rel="noopener noreferrer">definition</a> from it.
I do a quite simple deployment, a service and an ingress, and return the generated yaml.</p>
<p>Now I have to apply this yaml to the cluster.</p>
<p><strong>Cluster?</strong></p>
<p>Ok, I have to install a cluster.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="local-kube">Local kube<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#local-kube" class="hash-link" aria-label="Direct link to Local kube" title="Direct link to Local kube">​</a></h3>
<p>There are plenty of options to choose, but I start caring about the resources I use.
My app started with postrgres, then registry, now it has a kube. The main issue I might be able to run a cluster in CI for integration tests, so I want to make my kube instance as small as possible.</p>
<p>I found out k3s is the smallest distrubtion. Even though it doesn't follow all the standards, strangers in the internet convinced me I shouldn't ever understand the difference.</p>
<p>So I found an interesting <a href="https://sachua.github.io/post/Lightweight%20Kubernetes%20Using%20Docker%20Compose.html" target="_blank" rel="noopener noreferrer">guide</a> how to start a cluster locally and it worked well.</p>
<p>In the progress I needed to add some kubelet <a href="https://github.com/treenq/treenq/blob/6919be57726109ff3f37ce484db3d2457b4cb01e/docker-compose.yaml#L28" target="_blank" rel="noopener noreferrer">arguments</a> and the flight is done.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-1">Deploy<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#deploy-1" class="hash-link" aria-label="Direct link to Deploy" title="Direct link to Deploy">​</a></h3>
<p>I wish I could use CLI and call <code>kubectl apply</code>, but it's not gonna workout.
The goal to support a huge amount of clusters, so I accept kubeconfig dynamically as an argument.</p>
<p>The examples to make it I found only using regular rest api that kube provides.
But I don't need it, but definitions I have are in yaml.</p>
<p>So I found some dynamic client to create resources unsafely.
Since I expected to not now what resources I create/update it what I need.
Yes, still unsafe, but Im here.</p>
<p>Eventually I combine apimachinery and go client together to split the yaml definition by objects, unmarshal them and try creating or updating an object one by one.</p>
<p>Later on I want to understand better what I need to create or update, but I would need to implement infra diffs for it, it's not gonna happen soon.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="test">Test<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-1#test" class="hash-link" aria-label="Direct link to Test" title="Direct link to Test">​</a></h3>
<p>On the testing step I discover my cluster can't pull an image since registry is not a TLS server.
It's solved proving a registry config to my cluster.
So I add another <a href="https://github.com/treenq/treenq/blob/6919be57726109ff3f37ce484db3d2457b4cb01e/docker-compose.yaml#L49" target="_blank" rel="noopener noreferrer">volume</a> to my cluster to add the registries config</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">mirrors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">"registry:5000"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">endpoint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"http://registry:5000"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">configs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">"registry:5000"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">tls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">insecure_skip_verify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="paas" term="paas"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[How Treenq builds workload images]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/container-in-container-09</id>
        <link href="https://dennypenta.github.io/mynameis/blog/container-in-container-09"/>
        <updated>2025-06-01T21:59:56.000Z</updated>
        <summary type="html"><![CDATA[Build a container inside a rootless conatiner]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-a-container-inside-a-rootless-conatiner">Build a container inside a rootless conatiner<a href="https://dennypenta.github.io/mynameis/blog/container-in-container-09#build-a-container-inside-a-rootless-conatiner" class="hash-link" aria-label="Direct link to Build a container inside a rootless conatiner" title="Direct link to Build a container inside a rootless conatiner">​</a></h2>
<p>A PaaS has a very dev friendly use case: when a user just conneects a repository we must build the image from a Dockerfile in the repo.
We assume at the beginning a team doesn't have a CI pipeline and wants to share a quick demo to the customers.
There are many ways to do it. Let's look at all of them and at the design we chosed for <a href="https://github.com/treenq/treenq" target="_blank" rel="noopener noreferrer">Treenq</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grug-docker-in-docker">Grug: docker in docker<a href="https://dennypenta.github.io/mynameis/blog/container-in-container-09#grug-docker-in-docker" class="hash-link" aria-label="Direct link to Grug: docker in docker" title="Direct link to Grug: docker in docker">​</a></h3>
<p>As a straight forward approach we can forward docker host to a container and build it.
It has quite a lot of problems:</p>
<ul>
<li>dind requirees running in privileged mode: it opens a rabbit hole to a host machine</li>
<li>moreover, it doesn't seem an option to make it rootless</li>
<li>docker daemon is running, it's not free for resources</li>
</ul>
<p>Even to get started the user case it didn't seem convinient, it requires configuration to make it possible, so I decided to move to more secure options.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kaniko-k8s-native-builder">Kaniko: k8s native builder<a href="https://dennypenta.github.io/mynameis/blog/container-in-container-09#kaniko-k8s-native-builder" class="hash-link" aria-label="Direct link to Kaniko: k8s native builder" title="Direct link to Kaniko: k8s native builder">​</a></h3>
<p>Kaniko is created to solve this problem.
It allows setting up an environemnt for a cluster where the workload is built near it's runners, perhaps on different nodes in order to avoid any resource fight.
The idea is it spans a new container that builds an image, the container feels great in unprivileged environment and doesn't require a docker daemon.</p>
<p>Technically it doesn't create a new namespace, instead it unpacks an image layer and does chroot.</p>
<p>You can even span your registry right in this cluster, like a regular one or <a href="https://github.com/goharbor/harbor" target="_blank" rel="noopener noreferrer">Harbor</a> and the builds flow is completely isolated from the planet.
It like like <strong>kaniko -&gt; registry -&gt; k8s workload node</strong>.</p>
<p>In terms of security Kaniko is the winner.
It does require root to run, but the abstraction is well done to keep it away.</p>
<p>Looks fancy, but has a couple restrictions:</p>
<ul>
<li>it buidls containers only inside a Kubernetes cluster, it works in k8s, k3s (which we use for e2e tests) and perhaps some more.</li>
<li>it has no more capabilities, if I need to inspect an image.</li>
<li>it's not able to build windows images</li>
<li>build time performance is slightly lower</li>
</ul>
<p>For instance, I want to rollback, I want it real quick, so before launching a build job I want to look if the image is in the registry.
For that purpose I must use skopeo or another tool to talk to a registry.
Not really a big deal.
Perhaps, one day Treenq will need <a href="https://github.com/containers/skopeo" target="_blank" rel="noopener noreferrer">Skopeo</a>.</p>
<p>Looking back it looks a good option and most likely I would say it's worth trying it.
But I thought it's very important to have a capability to run builds outside of a cluster, may be even on a isoalted VM, which is not really smart requirement I guess.
Also, the complexity to set it up didn't look easy enough, I have to span a k8s resource, make a ServiceAccount for it and many more to start building + adding inspection API near by.</p>
<p>On top of that, recently, Kaniko stepped down right into arhive.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="buildah-isolated-package">Buildah: isolated package<a href="https://dennypenta.github.io/mynameis/blog/container-in-container-09#buildah-isolated-package" class="hash-link" aria-label="Direct link to Buildah: isolated package" title="Direct link to Buildah: isolated package">​</a></h3>
<p><a href="https://github.com/containers/podman" target="_blank" rel="noopener noreferrer">Podman</a>, a Docker alternative, has a way cleaner opensource relation and how they structure the packages and repositories.
Podman has a designated module, <a href="https://github.com/containers/buildah" target="_blank" rel="noopener noreferrer">Buildah</a>, which is used exactly for building images.
It requires no priovileges, root, daemon, nothing (technically speaking, but there is a price for it).</p>
<p>It doesn't require a daemon to run.
Package is written in Go, therefore I can embed it right into the service instead of adding a syscall.</p>
<p>DISCLAIMER: I understand I use undocumented API of the package and it can hurt it. If it happens I can freeze the version, and then either the project fulfills the graveyard or it migrates to buildkit.</p>
<p>First step is to understand how to run buidlah in a container.
There is an official <a href="https://hub.docker.com/r/buildah/buildah" target="_blank" rel="noopener noreferrer">image</a> based on Fedora, but I want my app run at least in Ubuntu.
Better in alpine/scratch ofc, but it doesn't seem viable.</p>
<p>There are a some guides on <a href="https://developers.redhat.com/blog/2019/08/14/best-practices-for-running-buildah-in-a-container" target="_blank" rel="noopener noreferrer">how to run buildah in a container</a> and <a href="https://opensource.com/article/19/3/tips-tricks-rootless-buildah" target="_blank" rel="noopener noreferrer">in privileged environment</a>, so I can slowly transform this information to prepare Ubuntu image.
Here is what I got <a href="https://github.com/treenq/treenq/blob/main/Dockerfile" target="_blank" rel="noopener noreferrer">eventually</a>.</p>
<p>Ok, we can build, next step I want to build a small image from Go application.</p>
<p>There is a <a href="https://github.com/containers/buildah/blob/main/docs/tutorials/04-include-in-your-build-tool.md" target="_blank" rel="noopener noreferrer">guilde</a> showing how programmatically execute dockerfile steps (run, copy, etc.), but it's not what we need.
We simply need to run <code>buildah build</code>.</p>
<p>At this point I have to dig the source code to understand what's happening.
Jumping right inside the build command in the source code we find there is a storage resource is required to start and we can execute the build</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	buildStoreOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">DefaultStoreOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	buildStore</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> storage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetStore</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">buildStoreOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And next step we can start build:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> imagebuildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">BuildDockerfiles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> buildStore</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> define</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">BuildOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		ContextDirectory</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">         a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Output</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">           args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">              out</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">              errOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		ReportWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     reportOut</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		IgnoreFile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     dockerignorePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		AdditionalTags</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">FullPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Dockerfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To push the image we need to get a reference to this image in our store and prepare system context: registry authentication, tls flags, certs.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	storeRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> alltransports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ParseImageName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"docker://"</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">FullPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	systemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">SystemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		DockerCertPath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">              a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registryCertDir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		DockerInsecureSkipTLSVerify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewOptionalBool</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registryTLSVerify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		DockerAuthConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">            </span><span class="token operator">&amp;</span><span class="token plain">types</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DockerAuthConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			IdentityToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">registryToken</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">=</span><span class="token plain"> buildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> storeRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> buildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">PushOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		Store</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">         a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">store</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		SystemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> systemContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Full version of this module is <a href="https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>One important detail: first lines of your main function must be:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> buildah</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">InitReexec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	unshare</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">MaybeReexecUsingUserNamespace</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It matters to act Buildah as root without being real rool.
It locks the OS thread, prepares uid/gid mapping and reexec as a new user in a new namespace.
So, softly speaking, it's not ideal to run this code inside the application code.</p>
<p>The best design would be to have the application code isolated from pool of builders. Builders can receive the build tasks and still execute it inside a Go app in order to being able to extend he capabilities.
This design allows me to extend options to build images: In a similar manner I can embed buildpacks to build simpler apps without a Dockerfile.</p>
<p>Buildah, unfortunately, also has a few caveats and it's a little behined of docker.</p>
<ul>
<li>For instance buildah can't inject variables/secrets <a href="https://github.com/containers/buildah/issues/5892" target="_blank" rel="noopener noreferrer">on RUN command</a> while docker can.</li>
<li>Or it can't detect <a href="https://github.com/containers/buildah/issues/5408" target="_blank" rel="noopener noreferrer">variables in images</a></li>
<li>Also, runniong it unprivileged is quite tricky and it requires specific arguments for container and specific build of the image itself.
The domain is huge to learn, different backends, storages drivers and so on.</li>
</ul>
<p>From this <a href="https://github.com/containers/buildah/issues/2554" target="_blank" rel="noopener noreferrer">issue</a> I learned vfs storage driver copies the entire sublayer on every layer.
So it's better to use overlayfs, it requires /dev/fuse to run in non privileged container.</p>
<p>As a bonus, it might be cool to put it inside alpine, but not sure it's viable at all.
Putting a cgo app itself requires some <a href="https://baicai.xlog.app/docker_golang_alpine_cgo_build?locale=en" target="_blank" rel="noopener noreferrer">dance</a> for it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="buildkit-overlooked-option">BuildKit: overlooked option<a href="https://dennypenta.github.io/mynameis/blog/container-in-container-09#buildkit-overlooked-option" class="hash-link" aria-label="Direct link to BuildKit: overlooked option" title="Direct link to BuildKit: overlooked option">​</a></h3>
<p>What if docker could get rid of priviileged mode?</p>
<p>Buildx (BuildKit) is a module of docker (or moby?) that's responsible specifically for building iamges.</p>
<p>BuildKit still has a daemon and it requires a privileged mode either.</p>
<p>However, we can run fake root using <a href="https://github.com/rootless-containers/rootlesskit/" target="_blank" rel="noopener noreferrer">RootlessKit</a>.
We can build our flow in the following way:</p>
<ul>
<li>run a daemon</li>
<li>run buildctl to start build</li>
<li>when we are done we close the daemon</li>
</ul>
<p>RootlessKit requires turning off apparmor and seccomp, because the default profile doesn't allow spawning new namespaces.
Also, add a few linux capabilities like SETUID, SETGUID and fake root users removing the option no-new-privileges.</p>
<p>It seems quite secure, but has a few constraints:</p>
<ul>
<li>requires support explicit uid and gid which is not fine and might be annoyign</li>
<li>requires supporting a designated pool of build machines, which is actually makes sence in terms of designing a PaaS, but makes it a way complicated to start</li>
</ul>
<p>In case of buildah it required me to run the build in the same application.
In order to scale it well I have to build network transport and mount volumes between them, which makes it quite complicated to setup.</p>
<p>Buildkit provides its capabilities out of the box. It makes its API a bit  harder to learn, since it's not documented well and perhaps not supposed to be used like that.</p>
<p>Buildkit brings to main modules to the table:</p>
<ul>
<li>buildkitd - a daemon to serve the builds, it may expose a unix socker to tcp connection</li>
<li>buildctl - the actual buildkit client</li>
</ul>
<p>Now it requires to to setup additional container buildkitd and write a client part inside my Go service.
As a benefit I get rid of building images and buildkit dependencies.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">buildkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> moby/buildkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v0.23.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">privileged</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> buildkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1234:1234"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./buildkit/entrypoint.sh</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/entrypoint.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./buildkit/buildkitd.toml</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/etc/buildkit/buildkitd.toml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./registry/certs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/certs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./buildkit/certs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/buildkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">entrypoint</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"/entrypoint.sh"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">healthcheck</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"CMD-SHELL"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"buildctl --addr tcp://localhost:1234 debug workers"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">interval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 5s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 30s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">retries</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">extra_hosts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"localhost:host-gateway"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>entrypoint specifies the arguments to run, it overrides the default address to tcp.
buildkitd mostly contains registry and service access and its TLS to test and support self signed certs flow.
Buildkit not only builds images, but also pushes them, therefore it requires access to the registry. Since my service has acces to the local registry as to localhost I want my buildkit access it on localhost too, therefore I define extra_hosts there.
Without the extra_hosts config registry will be available on registry host as define in the rest of the docker-compose.yaml.</p>
<p>Full example is here: <a href="https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go" target="_blank" rel="noopener noreferrer">https://github.com/treenq/treenq/blob/main/src/repo/artifacts/docker.go</a></p>
<p>docker-compose is in the root of the repo.</p>
<p>Final design of the platform is the following:
<img loading="lazy" alt="img" src="https://dennypenta.github.io/mynameis/assets/images/design-2f0fa17a45b1b84f1404c7ee75031b27.svg" width="1938" height="1279" class="img_ev3q"></p>
<p>Happy to answer your questions below in the comments</p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="software" term="software"/>
        <category label="paas" term="paas"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[gopls: how your IDE becomes better every day]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/gopls-08</id>
        <link href="https://dennypenta.github.io/mynameis/blog/gopls-08"/>
        <updated>2025-02-15T21:41:35.000Z</updated>
        <summary type="html"><![CDATA[A few years ago we had 2 editors for Go: jetbrains plugin to IntelijIdea and YOURNAMEIT with a go plugin.]]></summary>
        <content type="html"><![CDATA[<p>A few years ago we had 2 editors for Go: jetbrains plugin to IntelijIdea and YOUR_NAME_IT with a go plugin.
First brought tons of closed source components that eventually became Goland and bunch of open source components used by another editor Go plugin:</p>
<p>It worked for a while, but it has a lot of issues.</p>
<ol>
<li>Number one, you install a plugin, it installs a tenish of the others, every version half of the tools are broken and that's very lame dance happened every release.</li>
<li>The integration complexity, every editor did its own integration set, some used only part of them, some integrated them one by one.</li>
<li>Performance, it's not obvious today, but every tool worked once per editor request, it means every click "Go to definition" it has index the code base, find the implementatons or the object locations navigate you.</li>
</ol>
<p><img loading="lazy" alt="tools" src="https://dennypenta.github.io/mynameis/assets/images/tools-97d2c88ea8f2d7e405543e5b641d0e2c.png" width="1562" height="1274" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lsp">LSP<a href="https://dennypenta.github.io/mynameis/blog/gopls-08#lsp" class="hash-link" aria-label="Direct link to LSP" title="Direct link to LSP">​</a></h3>
<p>And Microsoft did a next step in creating IDE.
They decided it's important to decouple Javascript language support from the the editor.
So they created another component for autocompletion, code navigation, refactoring and diagnostic.
This component must run outside of editor in order to let many vscode instances to reuse the same indexing and cache.
The called it a language server and it made a new standard: LSP, Lanugage Server Protocol.</p>
<p><a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/" target="_blank" rel="noopener noreferrer">https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/</a></p>
<p><img loading="lazy" alt="gopls" src="https://dennypenta.github.io/mynameis/assets/images/gopls-16a8ddec9a07138982e1e6d3a9952935.png" width="1054" height="908" class="img_ev3q"></p>
<p>It gives every language team to make a developer experience an editor independant delegating all the main editor capabilities to the LSP implementation.</p>
<p>It changes 3 fundamental things in the software history:</p>
<ul>
<li>Language team supports any LSP compatible editor, it gives more editors come to the market like Helix, Zed, NVIM, etc.</li>
<li>We finally don't need to install a bunch of binaries to make the development experience just "fine"</li>
<li>And a bonus point, it gives a Go team to focus on supporting more complicated use cases like large repos support increasing performance for everyone, so it means everyone can make a dev experience better for everyone.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lsp-protocol">LSP Protocol<a href="https://dennypenta.github.io/mynameis/blog/gopls-08#lsp-protocol" class="hash-link" aria-label="Direct link to LSP Protocol" title="Direct link to LSP Protocol">​</a></h3>
<p>Let's have a look at the protocol breifly.
It has a client that drives all the necessary capabilities implemented on button clicks, hover, hotkeys, etc.
Implementing an LSP client it calls a server to resolve some actions.
For instance clicking Go to definition it sends a request with a given editor position where the interface method is described.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "method": "textDocument/definition",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "textDocument": {"uri": "file://location/file.go"},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "position": {"line": 42, "character: 3"},</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And the server contains all the indexed codebase can return a list of locations so editor suggest them to a developer.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gopls-under-the-hood">gopls under the hood<a href="https://dennypenta.github.io/mynameis/blog/gopls-08#gopls-under-the-hood" class="hash-link" aria-label="Direct link to gopls under the hood" title="Direct link to gopls under the hood">​</a></h3>
<p>Globally gopls has Cache.
Opening an editor it creates a new Session to connect to the server.
Opening a new project in the editor it creates a new Workspace looking for a module, go.work or GOPATH directory.
It holds metadata to let gopls know where you actually want to navigate in the code.
It uses default build, it also means it ignores build flags if you use them.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>In case you wish to see better dev exprience:</p><ul>
<li>changes to one module to be reflected in another</li>
<li>optimize memory usage by reducing the number of builds it must track</li>
<li>give gopls information where do you work
then use go.work.</li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="capabilities">Capabilities<a href="https://dennypenta.github.io/mynameis/blog/gopls-08#capabilities" class="hash-link" aria-label="Direct link to Capabilities" title="Direct link to Capabilities">​</a></h3>
<p>All the features list you can find <a href="https://github.com/golang/tools/blob/master/gopls/doc/features/README.md" target="_blank" rel="noopener noreferrer">here</a>.
Below I shortly describe what you could find useful to perform gopls at 100%.</p>
<ul>
<li>General information and a doc string on hovering</li>
<li>Diagnostics: static analysys, compile errors</li>
<li>Completion: how vscode intellisense gives you suggestion or cmp/blink for nvim.</li>
<li>Navigation: Go to definition, List references, List implementations, etc.</li>
<li>Transformation: format, sort imports, and refactoring as rename, inline, extract, etc.</li>
</ul>
<img src="https://dennypenta.github.io/mynameis/assets/images/goplsdemo-f2b7502d7c1386c4efaf0e44c287e86a.gif">
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-about-goland">What about Goland<a href="https://dennypenta.github.io/mynameis/blog/gopls-08#what-about-goland" class="hash-link" aria-label="Direct link to What about Goland" title="Direct link to What about Goland">​</a></h3>
<p>Goland is the opposite, it provides its capabilities as a closed source software. Lately it supports LSP as well, but they rarely can be compared in the feature set.</p>
<p>The main difference we all together can make gopls better, while we never can contribute to Goland.</p>
<p>If you found an idea like "I miss this hostkey to make this thing" or "generate that piece" or "discover that place" you probably want to develop another editor plugin.
It happened it me either, but apparently it's not the best solution.
If it's purely related to a language you just need to contribute to gopls.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-debug-gopls">How to debug gopls<a href="https://dennypenta.github.io/mynameis/blog/gopls-08#how-to-debug-gopls" class="hash-link" aria-label="Direct link to How to debug gopls" title="Direct link to How to debug gopls">​</a></h3>
<p>Here I describe a practical guide to gopls contribution.
I skip the issue discussion with your proposal, expected output, how you attach a visual picture and communicate nicely, gerrit user experience so on.</p>
<p>All the examples are using vscode, I'm sure vim/emacs nerds have cracked it.
We don't use GoLand here because it has a lot of internal tooling for Go that may add misunderstanding whether it's gopls or GoLand magic.</p>
<p>First, let's configure a local debugging setup.
Inside the repo we add a debugging statement for vscode in order to run our forked version of gopls, in a folder <code>tools/gopls/</code> we add:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "version": "0.2.0",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "configurations": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "name": "Run Gopls",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "type": "go",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "request": "launch",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "mode": "auto",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "program": "./main.go",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "args": ["-port=9000"]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now you can run your gopls.</p>
<p>In another editor instance you add a workspace setting:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">"go.languageServerFlags": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "-remote=localhost:9000"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So you know how to make a call from your editor to the server and found a place to debug.</p>
<p>For example you want to add a quickfix, it's a Code Action to make a Transformation, like implementing an interface or generating a function, etc.</p>
<p>Now guess where to put a breakpoint and call a Code Action from a client, in vscode you need to push <code>CMD + .</code> or find your hotkey in the <a href="https://code.visualstudio.com/docs/editor/refactoring#_code-actions-quick-fixes-and-refactorings" target="_blank" rel="noopener noreferrer">doc</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-few-nice-words-in-the-end">A few nice words in the end<a href="https://dennypenta.github.io/mynameis/blog/gopls-08#a-few-nice-words-in-the-end" class="hash-link" aria-label="Direct link to A few nice words in the end" title="Direct link to A few nice words in the end">​</a></h3>
<p>What's really important Go team uses LSP compatible editors, so real dog fooding comes in the room, they experience what the build and introduce the features they miss.
I know for sure Alan Donovan uses Emacs, at least he said so.</p>
<p>If you are still interested look his <a href="https://youtu.be/8EsaJC9cn4w" target="_blank" rel="noopener noreferrer">speach</a> how they optimized Gopls last interation.</p>
<p>A really hope it raises awareness across the entire Go community and lights the interest to the tooling, more people contribute better experience everyone would have.</p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="software" term="software"/>
        <category label="go" term="go"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Go Dockerfile]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/go-dockerfile</id>
        <link href="https://dennypenta.github.io/mynameis/blog/go-dockerfile"/>
        <updated>2025-01-21T20:11:35.000Z</updated>
        <summary type="html"><![CDATA[The things I've collected to write my best Dockerfile. Appreciate any comments mentioning I could do it better and more optimal.]]></summary>
        <content type="html"><![CDATA[<p>The things I've collected to write my best Dockerfile. Appreciate any comments mentioning I could do it better and more optimal.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preface">Preface<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#preface" class="hash-link" aria-label="Direct link to Preface" title="Direct link to Preface">​</a></h2>
<p>TLDR:</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token instruction"> golang:1.23.1-alpine </span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token instruction"> builder</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">WORKDIR</span><span class="token instruction"> /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">ENV</span><span class="token instruction"> CGO_ENABLED=0 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">ENV</span><span class="token instruction"> GOOS=linux</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">COPY</span><span class="token instruction"> go.mod go.mod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">COPY</span><span class="token instruction"> go.sum go.sum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction"> go mod download -x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">COPY</span><span class="token instruction"> . .</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token instruction"> builder </span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token instruction"> dev</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction options"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token instruction"> go install github.com/go-delve/delve/cmd/dlv@v1.23.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction options"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token instruction"> go build -gcflags=all=</span><span class="token instruction string" style="color:rgb(255, 121, 198)">"-N -l"</span><span class="token instruction"> -o server ./cmd/server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">CMD</span><span class="token instruction"> [</span><span class="token instruction string" style="color:rgb(255, 121, 198)">"dlv"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--listen=:40000"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--continue"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--headless=true"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--api-version=2"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--accept-multiclient"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"exec"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"server"</span><span class="token instruction">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token instruction"> builder </span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token instruction"> prod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction options"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token instruction"> go build -ldflags </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"-s -w"</span><span class="token instruction"> -o server ./cmd/server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token instruction"> alpine:3.13</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> addgroup -g 1001 appgroup &amp;&amp; adduser -D -G appgroup -u 1001 appuser</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">WORKDIR</span><span class="token instruction"> /app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">USER</span><span class="token instruction"> 1001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">COPY</span><span class="token instruction"> </span><span class="token instruction options property">--from</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">prod</span><span class="token instruction"> /app/server server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">CMD</span><span class="token instruction"> [</span><span class="token instruction string" style="color:rgb(255, 121, 198)">"/app/server"</span><span class="token instruction">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Link: <a href="https://github.com/treenq/treenq/blob/98e6d8dd5f5756fe5df561913e10515784ef7163/Dockerfile" target="_blank" rel="noopener noreferrer">https://github.com/treenq/treenq/blob/98e6d8dd5f5756fe5df561913e10515784ef7163/Dockerfile</a></p>
<p>Now let's breakdown what's happening here and why.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>I use colima and all the things described here work well. However, all the docs referenses will go to docker. I think they did a great job to push the industry standart. Also you have to turn on buildx to make these features work. It requires buildx installation and setting a feature flag <code>DOCKER_BUILDKIT=1</code>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="base-image">Base image<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#base-image" class="hash-link" aria-label="Direct link to Base image" title="Direct link to Base image">​</a></h2>
<p>First, we need a base image in order to build the app. We want the base being less as possible, for that purpose I use alpine:</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token instruction"> golang:1.23.1-alpine </span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token instruction"> builder</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You also can consider <a href="https://github.com/GoogleContainerTools/distroless" target="_blank" rel="noopener noreferrer">distroless</a>, it's very suitable for interpreted languages like python/nodejs, but alpine works well for Go.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dependencies">Dependencies<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#dependencies" class="hash-link" aria-label="Direct link to Dependencies" title="Direct link to Dependencies">​</a></h2>
<p>The next step we prepare a surface to build the image, all the necessary dependencies we install there.</p>
<p>If you need specific timezones, certificates, github private repo creds, the service modules, whatever, we do it right here.</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">COPY</span><span class="token instruction"> go.mod go.mod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">COPY</span><span class="token instruction"> go.sum go.sum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction"> go mod download -x</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We must copy only desegnated dependencies definition and right after download them.
If you don't know why and what is docker layers please refer to Docker basics and get back.</p>
<p><code>-x</code> Flag is kinda adds verbosity showing what <code>go mod download</code> executes.</p>
<p>The interesting details here is <code>--mount=type=cache</code>.
You can find more in the <a href="https://docs.docker.com/reference/dockerfile/#run---mounttypecache" target="_blank" rel="noopener noreferrer">reference</a></p>
<p>If you update a dependency in your <code>go.mod</code> and rebuild it, then this statement will not download all the packages from scratch, it creates a designated mount and hold them in one place.</p>
<p>Unfortunately, most of the CI systems create a new image for a new job and it doesn't work in CI, but helps a lot for local testing. For instance, I run e2e tests locally and it saves a couple of minutes every try.</p>
<p>And only then we copy the rest of the codebase:</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">COPY</span><span class="token instruction"> . .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Don't forget to check your dockerignore to skip copying useless files.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="targets">Targets<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#targets" class="hash-link" aria-label="Direct link to Targets" title="Direct link to Targets">​</a></h2>
<p>You must have heard about multi-stage images.
And you have built the dockerfiles with 2 stages, first to build a binary and the next to run it in a blank environment.</p>
<p>But I will convince you to have 4 stages.</p>
<p>Docker has an amazing feature: targets.</p>
<p>The targets allow to run a specified stage of the image.</p>
<p>Let's have a look how it plays out in case of e2e tests.</p>
<p>We have a regular docker compose setup with a database or whatever dependencies you have to run your tests.
Im a big fan of a debugger and a big hater of infinite print statements. Don't get me wrong, logging is an awesome tool, but not the forgotten prints in a production build.</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token instruction"> builder </span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token instruction"> dev</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction options"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token instruction"> go install github.com/go-delve/delve/cmd/dlv@v1.23.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction options"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token instruction"> go build -gcflags=all=</span><span class="token instruction string" style="color:rgb(255, 121, 198)">"-N -l"</span><span class="token instruction"> -o server ./cmd/server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">CMD</span><span class="token instruction"> [</span><span class="token instruction string" style="color:rgb(255, 121, 198)">"dlv"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--listen=:40000"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--continue"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--headless=true"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--api-version=2"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"--accept-multiclient"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"exec"</span><span class="token instruction">, </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"server"</span><span class="token instruction">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On installing delve don't forget to specify cache mount, it has its own dependencies and it will help to speed the build up.
Moreover, if you don't mount the cache it won't discover the installeed dependencies in a previous step.</p>
<p>The mount flag might look unclear, as an argument you only put a path <em>where</em> to mount, you can't control the source of directory, it's managed docker buildkit.</p>
<p>Then we build a binary with a couple important gcflags, where <code>-l</code> disables inlining and <code>-N</code> removes optimisations. It matters because otherwise debugger won't be able to show some variables or navigate into some functions.
You can read more <a href="https://pkg.go.dev/cmd/compile" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>As the last statement we run dlv.</p>
<p>And that's what we have in a docker compose:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">target</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'8000:8000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'40000:40000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">security_opt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> seccomp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">unconfined</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">cap_add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> SYS_PTRACE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here we specify target field, clear and simple. You also can pass it as a cli argument to an image.</p>
<p>Ports has 2 elements, a regular app HTTP port and a DAP (Debug Adapter Protocol) port that delve exposes.</p>
<p>Next we add <code>secuty_opt</code> since the default Seccomp profile restricts the <code>ptrace</code> system call.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Seccomp is a Linux kernel feature used to restrict the system calls that a process can make. By default, Docker applies a restrictive Seccomp profile to limit potentially dangerous system calls, improving container security. Read more <a href="https://docs.docker.com/engine/security/seccomp/" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://docs.docker.com/engine/containers/run/" target="_blank" rel="noopener noreferrer">here</a>.</p></div></div>
<p>When you specify <code>seccomp:unconfined</code>, it removes the Seccomp restrictions, allowing the container to make all system calls. This config allows running <code>ptrace</code> syscall in the container, delve uses it to set breakpoints, observe memory, etc.</p>
<p>But it's not enough. We have to not only remove a restriction, but explicitly give a permission, that's why we have <code>cap_add</code> statement: to add a capability for that syscall.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="build-prod">Build prod<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#build-prod" class="hash-link" aria-label="Direct link to Build prod" title="Direct link to Build prod">​</a></h2>
<p>The prod build is quite simple and well known:</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token instruction"> builder </span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">AS</span><span class="token instruction"> prod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=/go/pkg/mod/</span><span class="token instruction options"> </span><span class="token instruction options property">--mount</span><span class="token instruction options punctuation" style="color:rgb(248, 248, 242)">=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">type=cache,target=</span><span class="token instruction options string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token instruction"> go build -ldflags </span><span class="token instruction string" style="color:rgb(255, 121, 198)">"-s -w"</span><span class="token instruction"> -o server ./cmd/server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We still use mount cache, we just put different build flags, in this case ldflags to achieve exactly the opposite we did in order to build a debug target.
<code>-s</code> and <code>-w</code> stand for skipping debug info, read more <a href="https://pkg.go.dev/cmd/link" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="run-prod">Run prod<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#run-prod" class="hash-link" aria-label="Direct link to Run prod" title="Direct link to Run prod">​</a></h2>
<p>There is no lots of new things for you, I want to focus on a small important thing: a user.</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">RUN</span><span class="token instruction"> addgroup -g 1001 appgroup &amp;&amp; adduser -D -G appgroup -u 1001 appuser</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token instruction keyword" style="color:rgb(189, 147, 249);font-style:italic">USER</span><span class="token instruction"> 1001</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There is so many information around on this security topic and I keep seeing zero attention to a user inside the image.</p>
<p>Shortly speaking - less ability less chance to make a mistake or open a vulnerability. Docker has a good blog <a href="https://www.docker.com/blog/understanding-the-docker-user-instruction/" target="_blank" rel="noopener noreferrer">post</a> to cover why it matters.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="target-dependenciy-graph">Target dependenciy graph<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#target-dependenciy-graph" class="hash-link" aria-label="Direct link to Target dependenciy graph" title="Direct link to Target dependenciy graph">​</a></h2>
<p>Now about the main concern of so many stages.</p>
<p>Why would I build all the stages for releasing my go app?</p>
<p>You will not, if you turned on buildkit it will behave as a smarter and build only the necessary dependencies, it means it builds the dependency graph and builds only necessary part, so your production CI will never install delve to waste your time.
The <a href="https://docs.docker.com/build/building/multi-stage/#differences-between-legacy-builder-and-buildkit" target="_blank" rel="noopener noreferrer">documentation</a> explains it very well.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-few-caveats-on-debugging-remote-dap">A few caveats on debugging remote DAP.<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#a-few-caveats-on-debugging-remote-dap" class="hash-link" aria-label="Direct link to A few caveats on debugging remote DAP." title="Direct link to A few caveats on debugging remote DAP.">​</a></h2>
<p>If you start a debugging process as is you will find your breakpoints Rejected.
It happens because your DAP communicates breakpoints state with DAP server using the client paths, and your client IDE is located on your machine, while the Go binary was built inside an image, another host machine.</p>
<p>You can find the fix in the official <a href="https://github.com/go-delve/delve/blob/master/Documentation/cli/substitutepath.md" target="_blank" rel="noopener noreferrer">doc</a>.</p>
<p>First, I would connect to dlv <code>dlv connect localhost:40000</code> and test path substitution,
for instance <code>config substitute-path /path/in/docker /local/path</code> where /path/in/docker is just your WORKDIR statement and /local/path is your local dir (input <code>pwd</code> in the project folder).
After that you can try <code>list main.main</code> and make sure it lists you a main function without an error.</p>
<p>Eventually I have the following config to configure remote debugger:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "type": "go",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "name": "debug remote service",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "mode": "remote",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "request": "attach",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "port": 40000,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "substitutePath": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "from": "${env:HOME}/projects/project-name",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "to": "/app"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "from": "${env:HOME}/go/pkg/mod/",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "to": "/go/pkg/mod/"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://dennypenta.github.io/mynameis/blog/go-dockerfile#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>Sorry, have nothing to say. Appreciate if you leave things better than you found it.</p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="software" term="software"/>
        <category label="go" term="go"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Unit test in observability]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/unit-test-observability</id>
        <link href="https://dennypenta.github.io/mynameis/blog/unit-test-observability"/>
        <updated>2024-10-06T21:43:35.000Z</updated>
        <summary type="html"><![CDATA[On this page, I want to cover the caveats I encountered while shaping my approach to unit testing in the context of observability.]]></summary>
        <content type="html"><![CDATA[<p>On this page, I want to cover the caveats I encountered while shaping my approach to unit testing in the context of observability.</p>
<p>It's important to clarify that I’m not referring to testing logs or metrics delivery.
Instead, I want to focus on testing modules that perform business logic but also include observability calls, like loggers or meters.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="regular-unit-test">Regular Unit Test<a href="https://dennypenta.github.io/mynameis/blog/unit-test-observability#regular-unit-test" class="hash-link" aria-label="Direct link to Regular Unit Test" title="Direct link to Regular Unit Test">​</a></h2>
<p>Let’s start with a typical example of a unit test containing a logger call.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">s </span><span class="token operator">*</span><span class="token plain">service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Do</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> request model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Response</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">repo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Do</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With a straightforward approach, you'd mock the repository and verify in a unit test that the mock was called with the expected parameters.</p>
<p>This is the conventional way of handling things.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="side-effects">Side Effects<a href="https://dennypenta.github.io/mynameis/blog/unit-test-observability#side-effects" class="hash-link" aria-label="Direct link to Side Effects" title="Direct link to Side Effects">​</a></h2>
<p>Now, let’s complicate the example by adding a logger.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">s </span><span class="token operator">*</span><span class="token plain">service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Do</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> request model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Object</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Response</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  err </span><span class="token operator">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">notImportantRepo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Something</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> another</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Model</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"can't do something"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"err"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Following the same approach, we can mock both dependencies. Here's how the mock preparation might look:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">notImportantRepoErr </span><span class="token operator">:=</span><span class="token plain"> errors</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">New</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"err"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">notImportantRepo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">On</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Something"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Return</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">notImportantRepoErr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">On</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Error"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> mock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Anything</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"err"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> notImportantRepoErr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we make the logger call more realistic, extracting all the values we need for emergency debugging, we end up with this:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">s</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"can't do something"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"err"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ctx"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> logging</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">FromContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"another"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> mapper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">From</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">req</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>At this point, engineers often use mock.Anything for the logger parameters:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">On</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"Error"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> mock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Anything</span><span class="token operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This leads to a couple of issues:</p>
<ul>
<li>The logger call becomes a side effect that doesn’t affect the result being tested.</li>
<li>Nobody bothers to test what's actually logged.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sustainability">Sustainability<a href="https://dennypenta.github.io/mynameis/blog/unit-test-observability#sustainability" class="hash-link" aria-label="Direct link to Sustainability" title="Direct link to Sustainability">​</a></h2>
<p>Real-world software isn’t always as clean as in theory, raising a few important questions.</p>
<ol>
<li><strong>1.</strong> Does this approach improve the <strong>quality</strong> of logging?</li>
</ol>
<p>In some ways, yes.
At least we confirm that a log message with the correct severity level was sent.
However, ensuring that the necessary parameters are logged requires strict discipline, which isn’t always feasible.
We can’t "fix people."</p>
<ol start="2">
<li><strong>2.</strong> Does it <strong>reduce PRs</strong> focused solely on improving logging?</li>
</ol>
<p>Sadly, no.
There's no validation of the parameters being logged, their mapping, formatting, or even the actual log message.</p>
<p>Often, only in production do we realize, "Oh, it's missing field X." After another debugging round, we might say, "Oh, it's missing field Z." This cycle continues.</p>
<ol start="3">
<li><strong>3.</strong> Does it help deliver more <strong>observable software</strong>?</li>
</ol>
<p>This is tricky.
While it might seem like a yes (if we answer question 1), the lack of validation means we’re still prone to errors.
The absence of data model testing only slows down software delivery.</p>
<p>Every time an engineer touches the function, they might copy a mock from a previous test.
If the function behaves differently, they’ll see a failed unit test like this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">assert: mock: I don't know what to return because the method call was unexpected.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Either do Mock.On("Error").Return(...) first, or remove the Error() call.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  This method was unexpected:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Error(params)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then, they’ll blindly copy the previous mock statement, and the test will pass—despite the logger parameters being completely different.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="is-it-worth-it">Is It Worth It?<a href="https://dennypenta.github.io/mynameis/blog/unit-test-observability#is-it-worth-it" class="hash-link" aria-label="Direct link to Is It Worth It?" title="Direct link to Is It Worth It?">​</a></h2>
<p>Here’s my evaluation:</p>
<ul>
<li>Patching takes more time because of the added mock statements.</li>
<li>More CI failures occur due to forgotten mocks.</li>
</ul>
<p>All these costs offer no real benefit.
We only confirm that the log was called.
But for all we know, we might have sent nil to the logger and won’t realize it until an emergency.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-better-approach">A Better Approach<a href="https://dennypenta.github.io/mynameis/blog/unit-test-observability#a-better-approach" class="hash-link" aria-label="Direct link to A Better Approach" title="Direct link to A Better Approach">​</a></h2>
<p>There are two paths to improve this situation:</p>
<ul>
<li>Never allow loggers to accept mock.Anything.</li>
<li>Don’t test loggers in the business layer.</li>
</ul>
<p>The first option is ideal but impractical unless you have years to experiment with uncertain payoffs.</p>
<p>The second option is more radical but effective: don’t mix observability tests with business logic.
Let me explain in two steps.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="nop-logger">Nop Logger<a href="https://dennypenta.github.io/mynameis/blog/unit-test-observability#nop-logger" class="hash-link" aria-label="Direct link to Nop Logger" title="Direct link to Nop Logger">​</a></h4>
<p>Start by defining the logger mock as a no-op and remove it from the mocks preparation.
You can use one of the following loggers for unit tests:</p>
<ul>
<li>An empty value logger</li>
<li>A package-defined nop logger</li>
<li>A mock logger with no assertions</li>
<li>A logger that writes to io.Discard (no impact on unit test output)</li>
</ul>
<p>Any of these options will ignore logger calls and simplify development.</p>
<p>You can apply the same approach to other observability components.
For example, <em>OpenTelemetry</em> provides <code>"go.opentelemetry.io/otel/metric/noop"</code> to create an empty counter or meter.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="isolation">Isolation<a href="https://dennypenta.github.io/mynameis/blog/unit-test-observability#isolation" class="hash-link" aria-label="Direct link to Isolation" title="Direct link to Isolation">​</a></h4>
<p>Finally, I’m not suggesting we skip logging tests entirely.</p>
<p>We should still test them, but in <strong>isolation</strong> rather than as a side effect.
Here’s how:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> tt </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">range</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">testCase</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"regular log"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HandlerFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r </span><span class="token operator">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				</span><span class="token function" style="color:rgb(80, 250, 123)">LoggerFromContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ErrorContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"test"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"arg1"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"text"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">WriteHeader</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			expectedLogFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t </span><span class="token operator">*</span><span class="token plain">testing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> m </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">map</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Helper</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">				assert</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Equal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ERROR"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"level"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token operator">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			expectedStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">200</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">tt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t </span><span class="token operator">*</span><span class="token plain">testing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			buf </span><span class="token operator">:=</span><span class="token plain"> bytes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewBuffer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			l </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">NewLogger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> slog</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">LevelInfo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			m </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">NewLoggingMiddleware</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">l</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			h </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">m</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">tt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			w </span><span class="token operator">:=</span><span class="token plain"> httptest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewRecorder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			h</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ServeHTTP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> httptest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NewRequest</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"POST"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			res </span><span class="token operator">:=</span><span class="token plain"> buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">String</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			jsonRes </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">map</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			err </span><span class="token operator">:=</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Unmarshal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token function" style="color:rgb(80, 250, 123)">byte</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">jsonRes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">NoError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			tt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">expectedLogFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> jsonRes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">			assert</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Equal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> tt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">expectedStatus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Code</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Instead of writing to stderr/stdout, substitute the logger’s writer with bytes.Buffer, allowing you to capture and validate the exact log message.</p>
<p>This way, we’re testing the logger implementation itself, not the side effect of a function that has little to no impact on the application's core functionality.</p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="software" term="software"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Web API Design: A Simplified Approach]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/api-design</id>
        <link href="https://dennypenta.github.io/mynameis/blog/api-design"/>
        <updated>2024-09-19T20:45:05.000Z</updated>
        <summary type="html"><![CDATA[Note: This page won’t teach you how to design an API from scratch, but it will give you insights into how I recently designed one while developing my PaaS.]]></summary>
        <content type="html"><![CDATA[<p><strong>Note</strong>: This page won’t teach you how to design an API from scratch, but it will give you insights into how I recently designed one while developing my <a href="https://github.com/treenq/treenq" target="_blank" rel="noopener noreferrer">PaaS</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preface">Preface<a href="https://dennypenta.github.io/mynameis/blog/api-design#preface" class="hash-link" aria-label="Direct link to Preface" title="Direct link to Preface">​</a></h2>
<p>Feel free to skip to the next section if you want to avoid the backstory.</p>
<p>After working with various communication protocols (e.g., web form-data, REST, JSON-RPC 2.0), I’ve realized that many of them aim to cover a wide range of use cases. This broad focus introduces a lot of complexity:</p>
<ul>
<li>Network implementations require special handling, such as decoding domain-level errors into transport error codes and messages.</li>
<li>Encoding and decoding messages require marshalling domain models into protocol-specific formats.</li>
<li>Protocols like REST involve lengthy discussions about naming conventions and URL structures.</li>
<li>Some protocols, like JSON-RPC, demand custom solutions, such as middleware for handling requests.</li>
</ul>
<p>These factors complicate implementations and slow down team agreements.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-grpc-shift">The gRPC Shift<a href="https://dennypenta.github.io/mynameis/blog/api-design#the-grpc-shift" class="hash-link" aria-label="Direct link to The gRPC Shift" title="Direct link to The gRPC Shift">​</a></h2>
<p>When I started working with gRPC, it introduced some important improvements:</p>
<ul>
<li>Models are generated automatically.</li>
<li>Service interfaces are provided and generated.</li>
<li>Clients are generated, allowing you to focus on just creating requests.</li>
<li>Error codes are simplified, reducing them from hundreds to around 15 (which is still more than needed, but we’ll get to that).</li>
<li>The error format is predefined, so you don’t have to design it—just reuse <a href="https://cloud.google.com/apis/design/errors" target="_blank" rel="noopener noreferrer">the model</a></li>
</ul>
<p>And I liked. I don't know who didn't.</p>
<p>I loved it. Most people who use gRPC feel the same.
However, gRPC doesn’t naturally align with web browsers due to its reliance on HTTP/2, often necessitating additional layers to adapt to HTTP/1.1.
Still, browser compatibility remains a common requirement.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bringing-grpc-ideas-to-the-web">Bringing gRPC Ideas to the Web<a href="https://dennypenta.github.io/mynameis/blog/api-design#bringing-grpc-ideas-to-the-web" class="hash-link" aria-label="Direct link to Bringing gRPC Ideas to the Web" title="Direct link to Bringing gRPC Ideas to the Web">​</a></h2>
<p>This made me think: what can we adopt from gRPC for web APIs? The most obvious feature is <strong>code generation</strong>.</p>
<p>Swagger attempts client generation but introduces its own challenges:</p>
<ol>
<li>Swagger has too many plugins, requires specific formats, and its "standard" is fragmented. Many web renderers are incompatible with each other. For example, Apiary’s requirements may contradict code generation.</li>
<li>Swagger focuses on defining documentation instead of the API itself, adding complexity.</li>
</ol>
<p>The I discovered <a href="https://trpc.io/docs/quickstart" target="_blank" rel="noopener noreferrer">tRPC</a>, which offered many things I’d been hoping for—network handling as a natural consequence of defining models.
The catch? It’s limited to JavaScript.</p>
<p>So, I decided to design my own API approach.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="my-api-design-principles">My API Design Principles<a href="https://dennypenta.github.io/mynameis/blog/api-design#my-api-design-principles" class="hash-link" aria-label="Direct link to My API Design Principles" title="Direct link to My API Design Principles">​</a></h2>
<p>Here are the guiding principles I followed:</p>
<ul>
<li>It must be built on top of HTTP to support the web.</li>
<li>No URL queries, forms, or arguments in the path—these overcomplicate things. Most people don’t even know that URL queries are essentially <a href="https://en.wikipedia.org/wiki/Multimap" target="_blank" rel="noopener noreferrer">multimaps</a>, which leads to more bugs.</li>
<li>Every API call uses only POST. The payload is always in the body, and for simplicity, in my case, it’s JSON.</li>
<li>The procedure naming follows the same conventions we use in code. For instance, instead of REST’s <code>/users/{id}/wallet</code>, I use <code>/getUserWallet</code>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-does-this-achieve">What Does This Achieve?<a href="https://dennypenta.github.io/mynameis/blog/api-design#what-does-this-achieve" class="hash-link" aria-label="Direct link to What Does This Achieve?" title="Direct link to What Does This Achieve?">​</a></h2>
<ul>
<li>I only define the models I need — no extra complexity.</li>
<li>Optionally, I can add descriptions to make the generated documentation more talkative.</li>
<li>From the defined router, I can generate both the client code and the API specification (including Swagger).</li>
<li>The code generation process is simplified: a single - word URL, consistent HTTP method, and uniform marshalling strategy make everything easy to implement and maintain.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="error-handling">Error Handling<a href="https://dennypenta.github.io/mynameis/blog/api-design#error-handling" class="hash-link" aria-label="Direct link to Error Handling" title="Direct link to Error Handling">​</a></h2>
<p>Error handling is a crucial part of any API design, and the model needs to be flexible enough to cover a wide range of scenarios.
Based on my experience, a simple yet effective error model looks like this:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> Error </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Code    </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Message </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Meta    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">map</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">any</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>Code</strong>: This holds a unique value that identifies the specific issue.
It helps narrow down the location of the problem in the code and quickly leads developers to the exact line or area where the error occurred. Additionally, it provides clear guidance to users about the expected behavior or how to resolve the issue.</li>
<li><strong>Message</strong>: The message field can serve a dual purpose:<!-- -->
<ol>
<li><strong>UserMessage</strong>: This is a user-friendly message that can be translated into different languages on the server side. It's meant to be shown in the user interface to guide the user.</li>
<li><strong>DevMessage</strong>: This contains a technical explanation intended for developers or logs. It explains what went wrong, why it happened, and what actions can be taken to resolve it.
While you could use a single string for both, in complex applications with internationalization (i18n) needs, separating them into two distinct lines would help.</li>
</ol>
</li>
<li><strong>Meta</strong>: This is a flexible map that can contain any additional context or metadata about the error. For example, if you're validating a form with multiple fields, the Meta map can list which fields failed validation and why.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-error-response">Example Error Response<a href="https://dennypenta.github.io/mynameis/blog/api-design#example-error-response" class="hash-link" aria-label="Direct link to Example Error Response" title="Direct link to Example Error Response">​</a></h3>
<p>Here’s an example of how this error model might be used in a real-world scenario. Suppose a user submits a tax form with several invalid fields. The API can return an error response like this:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Code</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"TAX_FORM_INVALID"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  Meta</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">map</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"tax_class"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"expected a number between 1 and 4"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"house_number"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"must be a number"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this example:</p>
<ul>
<li>The <strong>Code</strong> is <code>"TAX_FORM_INVALID"</code>, which indicates a validation failure specific to the tax form.</li>
<li>The <strong>Meta</strong> map provides detailed feedback on specific fields (<code>tax_class</code>, <code>house_number</code>) that need attention, making it easier for the user to correct their input.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="error-handling-in-api-handlers">Error Handling in API Handlers<a href="https://dennypenta.github.io/mynameis/blog/api-design#error-handling-in-api-handlers" class="hash-link" aria-label="Direct link to Error Handling in API Handlers" title="Direct link to Error Handling in API Handlers">​</a></h3>
<p>In my API, the handler interface is designed to consistently return errors using this model.
This ensures that all errors adhere to a common structure, simplifying error handling on both the client and server side.</p>
<p>For instance, a typical API handler might look like this:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">GetProfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">GetProfileResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, instead of returning a plain error, the handler returns a pointer to the *Error type.
This approach ensures that any error returned strictly follows the predefined error format.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-from-my-application">Example from My Application<a href="https://dennypenta.github.io/mynameis/blog/api-design#example-from-my-application" class="hash-link" aria-label="Direct link to Example from My Application" title="Direct link to Example from My Application">​</a></h3>
<p>Here’s a practical example of how I’ve implemented this in my app:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> domain</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"context"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"github.com/treenq/treenq/pkg/vel"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">type</span><span class="token plain"> GetProfileResponse </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Email    </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">`json:"email"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Username </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">`json:"username"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Name     </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">`json:"name"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">h </span><span class="token operator">*</span><span class="token plain">Handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">GetProfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">struct</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">GetProfileResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain">vel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    profile </span><span class="token operator">:=</span><span class="token plain"> h</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">authProfiler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">GetProfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> GetProfileResponse</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Email</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">    profile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Email</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Username</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> profile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Username</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">     profile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this code:</p>
<ul>
<li>The <code>GetProfile</code> function fetches the user profile and returns it as a <code>GetProfileResponse</code>.</li>
<li>The second return value is <code>*Error</code> instead of a generic <code>error</code>, making it clear that the function follows the structured error format.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-use-a-custom-error-type">Why Use a Custom Error Type?<a href="https://dennypenta.github.io/mynameis/blog/api-design#why-use-a-custom-error-type" class="hash-link" aria-label="Direct link to Why Use a Custom Error Type?" title="Direct link to Why Use a Custom Error Type?">​</a></h2>
<p>By using a custom <code>Error</code> type instead of the standard <code>error</code>, we enforce consistency across the API.
The error itself still implements Go’s built-in <code>error</code> interface, allowing it to work seamlessly with existing Go error-handling patterns.
However, the benefit is that every error now carries additional structured information, like the error code and metadata, making it easier to debug and handle errors programmatically.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="epiloge">Epiloge<a href="https://dennypenta.github.io/mynameis/blog/api-design#epiloge" class="hash-link" aria-label="Direct link to Epiloge" title="Direct link to Epiloge">​</a></h2>
<p>I ended up building a "framework" in Go on top of net/http that is able to generate clients for any language.</p>
<p>You can check it out <a href="https://github.com/treenq/treenq/blob/main/pkg/vel/router.go" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>I don’t recommend using it as-is — it’s better to copy and adapt it for your own needs.</p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="software" term="software"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[PaaS devlog |#0]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/tq-devlog-0</id>
        <link href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0"/>
        <updated>2024-09-02T20:12:28.000Z</updated>
        <summary type="html"><![CDATA[Devlog #0: logging, linter, Zitadel, codegen, e2e tests]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="devlog-0-logging-linter-zitadel-codegen-e2e-tests">Devlog #0: logging, linter, Zitadel, codegen, e2e tests<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#devlog-0-logging-linter-zitadel-codegen-e2e-tests" class="hash-link" aria-label="Direct link to Devlog #0: logging, linter, Zitadel, codegen, e2e tests" title="Direct link to Devlog #0: logging, linter, Zitadel, codegen, e2e tests">​</a></h2>
<p>Today I want to share with your my first steps of creating new project.
For a long time I've wanted created something cool, really meaninful, and after all I step into my idea: Platform as a service.</p>
<p>The main tech stack has beeen defined: Go for a main backend, perhaps JavaScript for cdk integration.
All the infra will be used from a well known cloud providers (not aws ofc, no clue who can understand how to user it).
First iteration will not such words as a frontend, ui, design. Ofc I want to make it, but only future history can judge me.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem">The problem<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#the-problem" class="hash-link" aria-label="Direct link to The problem" title="Direct link to The problem">​</a></h3>
<p>The technical problem exists, it's fun to figure out.
But no the main one. The biggest fight Im gonna accept is <strong>procrastination</strong>. Im such a person who pushes further all the tasks very often. I just have little to do with time discipline. That's what will stop me from the progress.
So the easiest way to move progress away - do whatever, but not the progress.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-planing">The planing<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#the-planing" class="hash-link" aria-label="Direct link to The planing" title="Direct link to The planing">​</a></h3>
<p>So I decided to plan everything and understand how big the actual project is gonna be.
So I start speaking with GPT in order to express my mind, kinda talking to a duck.
Instead of asking what I should do I explained my plan and asked to ask <strong>more questions</strong> so it could help me to clarify the technical solution and the plan.</p>
<p><img loading="lazy" alt="img" src="https://dennypenta.github.io/mynameis/assets/images/gpt-b6084e0c9c75c7a74f335fb999dde350.png" width="817" height="1036" class="img_ev3q"></p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><p>Here you can find a prompt I used</p></summary><div><div class="collapsibleContent_i85q"><p>I want to develop a platform like digitalocean app, vercel, render, fly.io, heroku, etc. My value is the following: I give observability with 0 code changes, and a localdev opportunity with connecting to a cloud environment, for instance a request comes from a frontend app on staging to my backend app locally so I could intercept it and make my laptop appear kinda in the cloud. It's a multitenant project. There are 2 paths: kubernetes and a custom architecture. To build a custom architecture the app must be on a few virtual machines, a load balancer on top including firewall. The challenge: ask me necessary questions so we could make a right decision. I have to highlight, we build a users' environment, not the product architecture I will create in order to reproduce the given environment, so we need to decide that would fit me and users better.</p></div></div></details>
<p>Initially I thought I will do it providing a user set of virtual machines connected under VPC, putting a load balancer on top, back to 2000. I thought it will make it cheaper and some tools just easier to implement.</p>
<p>Chatting to GPT I realized - Kubernetes will provide it a way quicker, most of the stuff is just ready to go like network policies, load balancing, SSL, deployment/rollback, health monitoring, resources observability, Istio adoption. Istio is very useful for observability and local first development, it became a new word today - <strong>remocal</strong>.</p>
<p>When stepped into the planning I decided to make it even longer.
I wanted to researched all the kanban boards, unresistable.
I used to use Trello and it was ok, but using api in power-ups boundaries sucks. Not really somethign I need right now though.</p>
<p>I tried Cluckup, it's a laggish joke, even worse than Jira to make you feel you are already enterprise.
I tried Asana and saw 0 difference with Trello, I spent about 2 minutes to confirm it and exist.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-ugly-thing">The ugly thing<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#the-ugly-thing" class="hash-link" aria-label="Direct link to The ugly thing" title="Direct link to The ugly thing">​</a></h3>
<p>In the end I found Linear.
To be fair it looked ugly, the design is equal to supabase: fonts, buttons.</p>
<p>A few minutes later I started catching.
Keyboard first design - that's what I buy.</p>
<p>So I read Linear Method, the framework they apply internally. It was hard to accept it, I think older I get more conservatibe I become, but I dig it anyway.
The basic element is an issue. It might have sub-issues. And they might have.
They can be collected in a project.</p>
<p>There are bunch of other staff I don't use, but I will share it below.</p>
<ul>
<li><strong>Cycle</strong> - like a sprint, hate it.</li>
<li><strong>Triage</strong> - inbox, it's a boss feature in my opinion, you can aggregate communication channels in a single place, then an on-call person can carry them, create issues or remove.</li>
<li><strong>Initiative</strong> - collection of the projects, they can be presented as a time line or a strategy decision, or even a roadmap on a timeline.</li>
</ul>
<p>As a result I cooked quite a few cards (48 projects in a backlog 😱️️️️️️).</p>
<p><img loading="lazy" alt="img" src="https://dennypenta.github.io/mynameis/assets/images/few-a8829c782e27ba5f7f88f18ced787cf4.png" width="1632" height="1121" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="infra-preparation">Infra preparation<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#infra-preparation" class="hash-link" aria-label="Direct link to Infra preparation" title="Direct link to Infra preparation">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="logging-and-recovery">Logging and recovery<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#logging-and-recovery" class="hash-link" aria-label="Direct link to Logging and recovery" title="Direct link to Logging and recovery">​</a></h3>
<p>I implemented a simple logging solution combined with a recovery middleware.
I find logging panic behaviors essential, and instead of separating these middlewares, I combined them for simplicity.</p>
<p>There are several ways to handle logging in Go applications:</p>
<ul>
<li>Inject a logger into every struct</li>
<li>Define a global (singleton) logger</li>
<li>Inject a logger into <code>context.Context</code></li>
</ul>
<p><strong>I prefer the last approach</strong> because it offers the flexibility to:</p>
<ul>
<li>Add request IDs to log messages, useful when logging in the data layer</li>
<li>Attach additional data fields to the logger for use in middleware, e.g. computed properties in a business layer</li>
</ul>
<p>The implementation is straightforward, and you can find the code <a href="https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/log/log.go#L72" target="_blank" rel="noopener noreferrer">here</a></p>
<p>A couple of <em>caveats</em> I encountered:</p>
<ol>
<li>There’s a timestamp formatting issue in the slog package. It sometimes fails to format correctly, so I added a simple fix:</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> slog</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">KindTime </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  t </span><span class="token operator">:=</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  a</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Value </span><span class="token operator">=</span><span class="token plain"> slog</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">StringValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Format</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">RFC3339</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>I wanted to adjust the log level based on the HTTP response status: log warnings for client errors (4xx) and errors for server errors (5xx):</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">logFunc </span><span class="token operator">:=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">DebugContext</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> resp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">status </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">500</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  logFunc </span><span class="token operator">=</span><span class="token plain"> logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ErrorContext</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>Finally, I added panic recovery and logged the error:</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">defer</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> recovered </span><span class="token operator">:=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">recover</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> recovered </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ErrorContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"recovered from panic"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token operator">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">"recovered"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> recovered</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">"stack"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">debug</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Stack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    resp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">WriteHeader</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">StatusInternalServerError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> resp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Write</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token function" style="color:rgb(80, 250, 123)">byte</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"internal server error"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      logger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ErrorContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"failed to write response"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"error"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It’s crucial to override the HTTP status during recovery, which is why I had to implement my own response writer.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="linter">Linter<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#linter" class="hash-link" aria-label="Direct link to Linter" title="Direct link to Linter">​</a></h3>
<p>I kept my linter setup as simple as possible.
I don’t use a complex configuration—just a single command added to the Makefile:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">go</span><span class="token plain"> install github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">com</span><span class="token operator">/</span><span class="token plain">golangci</span><span class="token operator">/</span><span class="token plain">golangci</span><span class="token operator">-</span><span class="token plain">lint</span><span class="token operator">/</span><span class="token plain">cmd</span><span class="token operator">/</span><span class="token plain">golangci</span><span class="token operator">-</span><span class="token plain">lint@v1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token number">59.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authz">AuthZ<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#authz" class="hash-link" aria-label="Direct link to AuthZ" title="Direct link to AuthZ">​</a></h3>
<p>My goal was to define the simplest authentication solution, one that could be extended later to support role-based access control (RBAC).</p>
<p>I considered a few options, including <strong>Ory</strong> and <strong>Keycloak</strong>, but both felt like overkill for my needs—too complex and cumbersome.
I wanted something:</p>
<ul>
<li>Easy to configure</li>
<li>A single binary to allow self-hosting</li>
<li>With a simple, clear open-source license (like Apache 2.0)</li>
<li>Dependent only on PostgreSQL</li>
</ul>
<p>I initially looked at <strong>Logto</strong>, a fresh new solution that seemed simple and clean.
However, it felt geared more toward frontend developers rather than backend engineers, and lacked some of the features I needed.</p>
<p>That’s when I found <strong>Zitadel</strong>.
Created by some of the folks behind Ory, <strong>Zitadel</strong> has strong security foundations.
Since I’m building only a backend API, I focused on authZ, using token introspection (i.e., validation), rather than issuing tokens.</p>
<p>It was straightforward to create a service account token for my e2e tests to check the authorization middleware.</p>
<p>I also verified that configuring RBAC and identity brokering with providers like Google and GitHub wouldn’t be an issue (i.e., “Sign in with Google”).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate-api-client">Generate api client<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#generate-api-client" class="hash-link" aria-label="Direct link to Generate api client" title="Direct link to Generate api client">​</a></h3>
<p>As I explain in my API design <a href="https://dennypenta.github.io/mynameis/blog/api-design" target="_blank" rel="noopener noreferrer">page</a> one of the benefits I want to achieve is easy API client generation for multiple languages.
The first language, naturally, is Go, as I need it for my e2e tests.
Since the implementation will change frequently, I’m skipping unit tests for now and focusing on e2e tests to ensure the app’s overall stability.</p>
<p>The client generation involves:</p>
<ul>
<li>Collecting <a href="https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/router.go#L124" target="_blank" rel="noopener noreferrer">API definition</a> from the router (models, routes)</li>
<li><a href="https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/gen/client.go#L35" target="_blank" rel="noopener noreferrer">Building</a> the data from the definitions to use in the client generation.</li>
<li>Feeding that data into a <a href="https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/pkg/vel/gen/templates/client.tpl#L1" target="_blank" rel="noopener noreferrer">template</a></li>
</ul>
<p>The result is a generated Go <a href="https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/client/client.go#L11" target="_blank" rel="noopener noreferrer">client</a>. I can easily add other templates later, such as for TypeScript, and use them in my tests.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="defining-e2e-tests">Defining e2e tests<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#defining-e2e-tests" class="hash-link" aria-label="Direct link to Defining e2e tests" title="Direct link to Defining e2e tests">​</a></h3>
<p>With the generated client, I can now define the simplest setup for my e2e tests.</p>
<p>First, I created a Docker image and a Docker Compose setup.
These are similar to a regular production environment but with a few additional tricks.</p>
<p>My <a href="https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/Dockerfile#L15" target="_blank" rel="noopener noreferrer">Dockerfile</a> includes an extra <a href="https://docs.docker.com/build/building/multi-stage/#stop-at-a-specific-build-stage" target="_blank" rel="noopener noreferrer">target</a> to run a debugger in the tests:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token constant" style="color:rgb(189, 147, 249)">FROM</span><span class="token plain"> builder </span><span class="token constant" style="color:rgb(189, 147, 249)">AS</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># </span><span class="token maybe-class-name">Install</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">Delve</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">debugger</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token constant" style="color:rgb(189, 147, 249)">RUN</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">mount</span><span class="token operator">=</span><span class="token plain">type</span><span class="token operator">=</span><span class="token plain">cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">target</span><span class="token operator">=</span><span class="token operator">/</span><span class="token plain">go</span><span class="token operator">/</span><span class="token plain">pkg</span><span class="token operator">/</span><span class="token plain">mod</span><span class="token operator">/</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">mount</span><span class="token operator">=</span><span class="token plain">type</span><span class="token operator">=</span><span class="token plain">cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">target</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token plain"> go install github</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">com</span><span class="token operator">/</span><span class="token plain">go</span><span class="token operator">-</span><span class="token plain">delve</span><span class="token operator">/</span><span class="token plain">delve</span><span class="token operator">/</span><span class="token plain">cmd</span><span class="token operator">/</span><span class="token plain">dlv@v1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token number">23.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token constant" style="color:rgb(189, 147, 249)">RUN</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">mount</span><span class="token operator">=</span><span class="token plain">type</span><span class="token operator">=</span><span class="token plain">cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">target</span><span class="token operator">=</span><span class="token operator">/</span><span class="token plain">go</span><span class="token operator">/</span><span class="token plain">pkg</span><span class="token operator">/</span><span class="token plain">mod</span><span class="token operator">/</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">mount</span><span class="token operator">=</span><span class="token plain">type</span><span class="token operator">=</span><span class="token plain">cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">target</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"/root/.cache/go-build"</span><span class="token plain"> go build </span><span class="token operator">-</span><span class="token plain">gcflags</span><span class="token operator">=</span><span class="token plain">all</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"-N -l"</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain">o server </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token operator">/</span><span class="token plain">cmd</span><span class="token operator">/</span><span class="token plain">server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token constant" style="color:rgb(189, 147, 249)">CMD</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"dlv"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"--listen=:40000"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"--continue"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"--headless=true"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"--api-version=2"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"--accept-multiclient"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"exec"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"server"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Next, I updated my <a href="https://github.com/treenq/treenq/blob/21dd255da33b7255ac1338edf75b36d048a6b2b7/docker-compose.e2e.yaml#L19" target="_blank" rel="noopener noreferrer">Docker Compose</a> file to expose the debugger port and allow clients to attach:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">target</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'8000:8000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'40000:40000'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">security_opt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> seccomp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">unconfined</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">cap_add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> SYS_PTRACE</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">env_file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    e2e.env</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">postgrese2e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">condition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> service_healthy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> always</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I also created a dedicated PostgreSQL instance for e2e tests to keep it separate from my local development environment:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">postgrese2e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> postgres</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">16.3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">POSTGRES_HOST_AUTH_METHOD</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'trust'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">POSTGRES_DB</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> tq</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"5432:5432"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">tmpfs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> /var/lib/postgresql/data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">healthcheck</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">test</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"CMD-SHELL"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"pg_isready -U postgres -d tq"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">interval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 3s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">timeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 3s</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">retries</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, I defined a simple Makefile command to run the tests:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">start</span><span class="token operator">-</span><span class="token plain">e2e</span><span class="token operator">-</span><span class="token plain">test</span><span class="token operator">-</span><span class="token plain">env</span><span class="token operator">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	docker</span><span class="token operator">-</span><span class="token plain">compose </span><span class="token operator">-</span><span class="token plain">f docker</span><span class="token operator">-</span><span class="token plain">compose</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">e2e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">yaml</span><span class="token plain"> up </span><span class="token operator">-</span><span class="token plain">d </span><span class="token operator">--</span><span class="token plain">build</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	@echo </span><span class="token string" style="color:rgb(255, 121, 198)">"Checking e2e test environment is running..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	until </span><span class="token function" style="color:rgb(80, 250, 123)">$$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">curl </span><span class="token operator">--</span><span class="token plain">output </span><span class="token operator">/</span><span class="token plain">dev</span><span class="token operator">/</span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token plain"> </span><span class="token operator">--</span><span class="token plain">silent </span><span class="token operator">--</span><span class="token plain">fail http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">localhost</span><span class="token operator">:</span><span class="token number">8000</span><span class="token operator">/</span><span class="token plain">healthz</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">do</span><span class="token plain"> printf </span><span class="token string" style="color:rgb(255, 121, 198)">'.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> sleep </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> done </span><span class="token operator">&amp;&amp;</span><span class="token plain"> echo </span><span class="token string" style="color:rgb(255, 121, 198)">"Service Ready!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	echo </span><span class="token string" style="color:rgb(255, 121, 198)">'Service has been started'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>curl</code> loop waits for the service to be ready since the app depends on the database connection, and migrations need to be applied.
This kind of delay is common — you can imagine even more delays due to cache warming, downstream API fetching, etc.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="bye">Bye<a href="https://dennypenta.github.io/mynameis/blog/tq-devlog-0#bye" class="hash-link" aria-label="Direct link to Bye" title="Direct link to Bye">​</a></h4>
<p>Thank you for reading, come here and see what's gonna be in the end.</p>
<p>Repository is here: <a href="http://github.com/treenq/treenq" target="_blank" rel="noopener noreferrer">http://github.com/treenq/treenq</a></p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="paas" term="paas"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[250mb json in a 40mb service limit]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/big-json</id>
        <link href="https://dennypenta.github.io/mynameis/blog/big-json"/>
        <updated>2024-05-26T15:48:12.000Z</updated>
        <summary type="html"><![CDATA[This article has been created to remind us of one simple thing: HTTP is a stream.]]></summary>
        <content type="html"><![CDATA[<p>This article has been created to remind us of one simple thing: HTTP is a stream.</p>
<p>As a practical outcome we can learn how to reduce memory requirements for our services in a typical task: cache warming.</p>
<p>Let's look at the challenge first.</p>
<p>We have a service that must download the data and keep it in memory.
The issue is the JSON document we have to download is 10 times larger than the encoded data.
Therefore we have to increase the memory limit 2-3 times to download it once.
Later on, the service doesn't consume as much memory, so it's a start up cost.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-challenge-cut-down-the-memory-consumption-as-much-as-we-can">The challenge: cut down the memory consumption as much as we can.<a href="https://dennypenta.github.io/mynameis/blog/big-json#the-challenge-cut-down-the-memory-consumption-as-much-as-we-can" class="hash-link" aria-label="Direct link to The challenge: cut down the memory consumption as much as we can." title="Direct link to The challenge: cut down the memory consumption as much as we can.">​</a></h3>
<p>Let's get back to the basic of network communication.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>We skip TLS termination for the sake of simplicity.</p></div></div>
<p>There is a great book that explains it very well: <a href="https://hpbn.co/building-blocks-of-tcp/#slow-start" target="_blank" rel="noopener noreferrer">https://hpbn.co/building-blocks-of-tcp/#slow-start</a></p>
<p><img loading="lazy" alt="img" src="https://dennypenta.github.io/mynameis/assets/images/syn-b9d07c0830813f49866fd02e5f6dcacb.svg" width="343" height="171" class="img_ev3q"></p>
<p>Just a litle picture to remind us how a connection starts: we do a handshake with the service.</p>
<p>Then we can start exchanging data.
Typical API responses are at most ~50kb.</p>
<p>But what if you want to warm a cache? How much can it be?
It can be a lot, around tens of megabytes.
In my example, we take 250mb.</p>
<p>How does the server send such data?</p>
<p><img loading="lazy" alt="img" src="https://dennypenta.github.io/mynameis/assets/images/congestion-d6e58562593cc5752c5bc8b39ab87735.svg" width="283" height="142" class="img_ev3q"></p>
<p>Slowly, packet by packet.</p>
<p>The server tries to understand your throughput. The protocol itself rarely provides an accurate value of a packet size, so by relying on the imperical latency, it tunes the packet size little by little.
It needs to send a lot of packets to transfer a really big response.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-ways-to-do-it">3 Ways to do it<a href="https://dennypenta.github.io/mynameis/blog/big-json#3-ways-to-do-it" class="hash-link" aria-label="Direct link to 3 Ways to do it" title="Direct link to 3 Ways to do it">​</a></h3>
<p>Below we will consider 3 approaches to solve this task.
There is no such thing as the only right solution; all of them are fine as long as you understand the costs and risks well enough, and we are gonna cover them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="first-brute-force-solution">First, Brute Force solution.<a href="https://dennypenta.github.io/mynameis/blog/big-json#first-brute-force-solution" class="hash-link" aria-label="Direct link to First, Brute Force solution." title="Direct link to First, Brute Force solution.">​</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you want to reproduce an example make sure to untar server/json.tar.gz; it must contain the f.json file since GitHub has a limit of up to 100mb for a file.</p></div></div>
<p>You can imagine how the simplest Go HTTP client can implement it or just look at the code.</p>
<p><a href="https://github.com/dennypenta/http-response-lab/blob/543510947c0b19dbc0097adf403ae5cd6954c1cc/client/main.go" target="_blank" rel="noopener noreferrer">Link</a></p>
<p>The implementation is straight forward: it sends a request, gets a response, reads, marhsals it into a defined structure, holds it in the memory and ready to serve it further.</p>
<p>And here is the pprof output:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 229.48MB, 100% of 229.48MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  229.48MB   100%   100%   229.48MB   100%  io.ReadAll</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%   229.48MB   100%  main.main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%   229.48MB   100%  runtime.main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Yes, it's not real win, with huge memory consumption, but it works ok.</p>
<p>We see all the memory consumed on reading the HTTP stream.</p>
<p>Or you might say, "What a noob, you must use <code>json.Decoder</code>" so as to let the decoder work with the HTTP pipe closer.</p>
<p>And it's pretty much the same, in my example, even worse.
<a href="https://github.com/dennypenta/http-response-lab/blob/b6ee7fcfd69fdffad844eb6a3d324d2fe3040985/client/main.go" target="_blank" rel="noopener noreferrer">Link</a> to code with Decoder</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 384MB, 100% of 384MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     384MB   100%   100%      384MB   100%  encoding/json.(*Decoder).refill</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  encoding/json.(*Decoder).Decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  encoding/json.(*Decoder).readValue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  main.main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  runtime.main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To recall why let's dig a little into the json/encoding library <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.22.3:src/encoding/json/stream.go;l=49" target="_blank" rel="noopener noreferrer">implementation</a>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dec </span><span class="token operator">*</span><span class="token plain">Decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">tokenPrepareForDecode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">tokenValueAllowed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">SyntaxError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"not at beginning of value"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Offset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">InputOffset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// Read whole value into buffer.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	n</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">readValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">init</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">scanp </span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">scanp</span><span class="token operator">+</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">scanp </span><span class="token operator">+=</span><span class="token plain"> n</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// Don't save err from unmarshal into dec.err:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// the connection is still usable since we read a complete JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// object from it before the error happened.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	err </span><span class="token operator">=</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">unmarshal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// fixup token streaming state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">tokenValueEnd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It does exactly the same, it calls <code>dec.readValue()</code> first to read all the response and then <code>dec.d.unmarshal</code> to parse it.</p>
<p>And it's ok; the reason is very simple: <strong>encoding/json doesn't know the nature of your data.</strong></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Libraries like <a href="https://github.com/json-iterator/go" target="_blank" rel="noopener noreferrer">json-iter</a> or <a href="https://github.com/mailru/easyjson" target="_blank" rel="noopener noreferrer">easyjson</a> offer zero improvements in memory consumption.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="second-decode-object-by-object">Second, decode object by object.<a href="https://dennypenta.github.io/mynameis/blog/big-json#second-decode-object-by-object" class="hash-link" aria-label="Direct link to Second, decode object by object." title="Direct link to Second, decode object by object.">​</a></h3>
<p>Go json library provides a method of the Decoder called <a href="https://pkg.go.dev/encoding/json#Decoder.Token" target="_blank" rel="noopener noreferrer"><code>Token</code></a></p>
<p>This approach, parsing manually token by token, can give us an option to manually parse the json.
A token might be every symbol, such as as open bracket, quote, key, value, etc.
But I found this approach quite complex. Having a deeply nested JSON object makes it very confusing to understand the relation for a given token. An solution could be to hold every key and designated level, but the decision gets worse with duplicated keys on a couple of levels.</p>
<p>That's why I prefer another approach.</p>
<p>There is a well-known problem on LeetCode called "<a href="https://leetcode.com/problems/valid-parentheses/description/" target="_blank" rel="noopener noreferrer">Valid Parentheses</a>"</p>
<p>We can simply read the beginning of a given object and the end, understanding when the last bracket of the object comes.</p>
<p><a href="https://github.com/dennypenta/http-response-lab/blob/b5890cbb74282416b5adacc92de95f18f7ee766f/client/main.go#L110" target="_blank" rel="noopener noreferrer">Link</a></p>
<p>pprof gives the following output</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(pprof) top 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 68.56MB, 100% of 68.56MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing top 5 nodes out of 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   27.55MB 40.18% 40.18%    68.56MB   100%  main.decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      20MB 29.17% 69.35%       20MB 29.17%  encoding/json.(*decodeState).literalStore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      20MB 29.17% 98.52%       20MB 29.17%  bufio.NewReaderSize (inline)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    1.01MB  1.48%   100%     1.01MB  1.48%  bufio.(*Scanner).Text (inline)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%       20MB 29.17%  encoding/json.(*decodeState).object</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Usually, the output varies between 65-80mb.</p>
<p>Such adventages is achieved due to marshalling the json <strong>and</strong> reading the HTTP response at the same time.</p>
<p>Let's get back to the introduction. Such a huge response gives us a stream of HTTP chunks we read step by step until the FIN message comes.
We can't make the HTTP server split every object in the response for us (probably we can, but it brings even more complexity).
Instead, every given chunk window we can ask, "Does it contain a valid json object?"</p>
<p>As soon as a valid object has come, we can marshal it and continue reading the response further <strong>until the next valid JSON object comes</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="third-the-simplest-data-compression">Third, the simplest: data compression.<a href="https://dennypenta.github.io/mynameis/blog/big-json#third-the-simplest-data-compression" class="hash-link" aria-label="Direct link to Third, the simplest: data compression." title="Direct link to Third, the simplest: data compression.">​</a></h3>
<p>It was new to me to discover that the most efficient solution will nott be related to the response handling.</p>
<p><strong>We simply must transfer as little data as we can.</strong></p>
<p>JSON is not the only way to represent the data.
It's easy and human-readable, but sometimes we have to trade it.</p>
<p>There are plenty of formats we can apply:</p>
<ul>
<li>Avro</li>
<li>Tthrift</li>
<li>MessagePack</li>
<li>Gob (Go only)</li>
<li>Protobuf</li>
</ul>
<p>And most likely more I don't even know.</p>
<p>I tried replacing decoding to MessagePack and gave very litle result (zero _(ツ)_/).</p>
<p>The best outcome showed Protobuf.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>We still use HTTP/1.1; we don't use gRPC transport.</p></div></div>
<p>The output from pprof is even better with less effort to implement.
It may vary up to 50mb sometimes.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(pprof) top5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 30.79MB, 100% of 30.79MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   30.79MB   100%   100%    30.79MB   100%  io.ReadAll</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    30.79MB   100%  main.decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    30.79MB   100%  main.main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    30.79MB   100%  runtime.main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is the solution: <a href="https://github.com/dennypenta/http-response-lab/blob/main/client/main.go#L14" target="_blank" rel="noopener noreferrer">Link</a></p>
<p>What we can say about Gob?</p>
<p>It offers very specific decoding and is a Go-only implementation, but it doesn't provide any benefit, here is the pprof output</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(pprof) top5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 70.81MB, 100% of 70.81MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing top 5 nodes out of 20</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   30.53MB 43.12% 43.12%    30.53MB 43.12%  internal/saferio.ReadData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   28.28MB 39.94% 83.05%    28.28MB 39.94%  reflect.growslice</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      12MB 16.95%   100%       12MB 16.95%  encoding/gob.decString</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    70.81MB   100%  encoding/gob.(*Decoder).Decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    70.81MB   100%  encoding/gob.(*Decoder).DecodeValue</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Perhaps for someone, having schemaless implementation is valuable, so here is the solution <a href="https://github.com/dennypenta/http-response-lab/blob/main/client/main.go#L40" target="_blank" rel="noopener noreferrer">link</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://dennypenta.github.io/mynameis/blog/big-json#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3>
<p>I found 2 interesting ideas to me during the investigation.</p>
<ol>
<li>The best, or one of them, solution might be the most obvious, so obvious to one is not to everyone.</li>
<li>It's not hard to implement and dig into fundamentals; some may win from engineering a new bicycle.</li>
</ol>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="software" term="software"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Why this page exists]]></title>
        <id>https://dennypenta.github.io/mynameis/blog/why-a-blog</id>
        <link href="https://dennypenta.github.io/mynameis/blog/why-a-blog"/>
        <updated>2023-12-13T21:25:34.000Z</updated>
        <summary type="html"><![CDATA[Blog is a  system to spread ideas across the internet. Shout out about a thing "Look, I have an opinion on that if you care".]]></summary>
        <content type="html"><![CDATA[<p>Blog is a&nbsp; system to spread ideas across the internet. Shout out about a thing "Look, I have an opinion on that if you care".</p>
<p>I have opinion on different things, especially in software. I've been working on it since 2015.</p>
<p>So let's start from reasoning why you might want to own one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="it-makes-more-than-0-chances-somebody-will-find-it-and-share-your-opinion">It makes more than 0 chances somebody will find it and share your opinion<a href="https://dennypenta.github.io/mynameis/blog/why-a-blog#it-makes-more-than-0-chances-somebody-will-find-it-and-share-your-opinion" class="hash-link" aria-label="Direct link to It makes more than 0 chances somebody will find it and share your opinion" title="Direct link to It makes more than 0 chances somebody will find it and share your opinion">​</a></h2>
<p>Or disagree, it's also fine and in some cases means almost the the same for you.</p>
<p>You get audience.&nbsp;</p>
<p>And it's a big deal.</p>
<p>First, the audience challenges your ideas. It's good to find a person to discuss your ideas. It allows your either find weaknesses in the idea itself, or perhaps your mindset to find crucial vocabulary to express what it means for you, or become even more confident on a topic. After all, it's just a joy to discuss what you have on top of your head.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="more-than-0-chances-your-future-team-knows-you">More than 0 chances your future team knows you<a href="https://dennypenta.github.io/mynameis/blog/why-a-blog#more-than-0-chances-your-future-team-knows-you" class="hash-link" aria-label="Direct link to More than 0 chances your future team knows you" title="Direct link to More than 0 chances your future team knows you">​</a></h2>
<p>It's a well known that having a referral in a company makes hiring easier to everyone. They get plus a point in confidence they hire not a dumbass, you may skip long questionnaire. They refer you not because you are good at contribution, but it's easier to build ubiquitous language in the team when you know each other.</p>
<p>I want to say having written something valuable for others makes you a little more known that you used to be. And if you apply to a new job and they have found it - it bumps your chances a lot.</p>
<p>Im convinced in the idea that not just delivering good result to your company, but telling the best pieces to the others will pay me off later on.</p>
<p>The only thing is under question if we really have built and understood something important for the industry.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memo-is-good">Memo is good<a href="https://dennypenta.github.io/mynameis/blog/why-a-blog#memo-is-good" class="hash-link" aria-label="Direct link to Memo is good" title="Direct link to Memo is good">​</a></h2>
<p>During software experience I realised the wide range technologies I apply can hardly be stored in my head.</p>
<p>Tools such Obsidian are fancy, but Im not disciplined enough to handle my cloud to store it or just structure them well enough, it doesn't fit me.</p>
<p>So Im going to structure my experience here.</p>
<p>It's not just putting all I have in my memory, but also try structuring all new stuff I have in my head.</p>
<p>For instance, I want to memoize a way to define alerts using terraform. Even though I've done it I have no idea what those queries to an observability provider mean.&nbsp;</p>
<p>What should I do?</p>
<p>Not to fool people. I will figure out in order to explain it to the others. Otherwise the article will be one of the thousands on medium or linkedin.</p>
<p>Eventually I have to push my skill up to give my audience valuable experience shared.</p>
<p>In the same time I get structured my experience and making it better by reading more in order to write a little.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="expressing-better">Expressing better<a href="https://dennypenta.github.io/mynameis/blog/why-a-blog#expressing-better" class="hash-link" aria-label="Direct link to Expressing better" title="Direct link to Expressing better">​</a></h2>
<p>And my personal reason.</p>
<p>Im poor at structuring my speach. If you read it you know how hard it was to catch my ideas. But I fight against it and I believe the blog may make me write more often and amend the way I express myself.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="you-are-ready-what-now">You are ready. what now?<a href="https://dennypenta.github.io/mynameis/blog/why-a-blog#you-are-ready-what-now" class="hash-link" aria-label="Direct link to You are ready. what now?" title="Direct link to You are ready. what now?">​</a></h2>
<p>Ok, let's say you confirmed you have a reason to have a blog.</p>
<p>A couple of hints I want to add.</p>
<p>Platforms like medium blocks people from reading your content without subscription.
And definitely it's not what I want.</p>
<p>I can understand if you want to setup patreon to provide sub only data, but I don't consider such option.&nbsp;
Moreover, the platforms get bigger revenue chunk of your ad and don't do more than google does.</p>
<p>I picked docusaurus because I have full control on codebase, fonts, styles, ads, comments, structuring. And I was lucky enough to find a template I wanted to reuse by <a href="https://takken.io/" target="_blank" rel="noopener noreferrer">takken</a>.</p>
<p>Or you can just clone this <a href="https://github.com/dennypenta/mynameis" target="_blank" rel="noopener noreferrer">project</a>.</p>]]></content>
        <author>
            <name>Denis</name>
        </author>
        <category label="career" term="career"/>
    </entry>
</feed>