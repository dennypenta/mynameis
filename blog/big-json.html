<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">250mb json in a 40mb service limit | Denny&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://dennypenta.github.io/mynameis/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://dennypenta.github.io/mynameis/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://dennypenta.github.io/mynameis/blog/big-json"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="250mb json in a 40mb service limit | Denny&#x27;s blog"><meta data-rh="true" name="description" content="This article has been created to remind us of one simple thing: HTTP is a stream."><meta data-rh="true" property="og:description" content="This article has been created to remind us of one simple thing: HTTP is a stream."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-05-26T15:48:12.000Z"><meta data-rh="true" property="article:tag" content="software"><link data-rh="true" rel="icon" href="/mynameis/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://dennypenta.github.io/mynameis/blog/big-json"><link data-rh="true" rel="alternate" href="https://dennypenta.github.io/mynameis/blog/big-json" hreflang="en"><link data-rh="true" rel="alternate" href="https://dennypenta.github.io/mynameis/blog/big-json" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/mynameis/blog/rss.xml" title="Denny&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mynameis/blog/atom.xml" title="Denny&#39;s blog Atom Feed"><link rel="stylesheet" href="/mynameis/assets/css/styles.255ed7f8.css">
<script src="/mynameis/assets/js/runtime~main.26cb761a.js" defer="defer"></script>
<script src="/mynameis/assets/js/main.e52686ee.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mynameis/"><b class="navbar__title text--truncate">hi! Im Denis</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/mynameis/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/web-sucks">Web in 2026 is a tragedy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/tq-devlog-1">PaaS devlog |#1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/container-in-container-09">How Treenq builds workload images</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/gopls-08">gopls: how your IDE becomes better every day</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/mynameis/blog/go-dockerfile">Go Dockerfile</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="This article has been created to remind us of one simple thing: HTTP is a stream."><header><h1 class="title_f1Hy" itemprop="headline">250mb json in a 40mb service limit</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-05-26T15:48:12.000Z" itemprop="datePublished">May 26, 2024</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><span itemprop="name">Denis</span></div><small class="avatar__subtitle" itemprop="description">Software Experience Dude</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>This article has been created to remind us of one simple thing: HTTP is a stream.</p>
<p>As a practical outcome we can learn how to reduce memory requirements for our services in a typical task: cache warming.</p>
<p>Let&#x27;s look at the challenge first.</p>
<p>We have a service that must download the data and keep it in memory.
The issue is the JSON document we have to download is 10 times larger than the encoded data.
Therefore we have to increase the memory limit 2-3 times to download it once.
Later on, the service doesn&#x27;t consume as much memory, so it&#x27;s a start up cost.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-challenge-cut-down-the-memory-consumption-as-much-as-we-can">The challenge: cut down the memory consumption as much as we can.<a href="#the-challenge-cut-down-the-memory-consumption-as-much-as-we-can" class="hash-link" aria-label="Direct link to The challenge: cut down the memory consumption as much as we can." title="Direct link to The challenge: cut down the memory consumption as much as we can.">​</a></h3>
<p>Let&#x27;s get back to the basic of network communication.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>We skip TLS termination for the sake of simplicity.</p></div></div>
<p>There is a great book that explains it very well: <a href="https://hpbn.co/building-blocks-of-tcp/#slow-start" target="_blank" rel="noopener noreferrer">https://hpbn.co/building-blocks-of-tcp/#slow-start</a></p>
<p><img loading="lazy" alt="img" src="/mynameis/assets/images/syn-b9d07c0830813f49866fd02e5f6dcacb.svg" width="343" height="171" class="img_ev3q"></p>
<p>Just a litle picture to remind us how a connection starts: we do a handshake with the service.</p>
<p>Then we can start exchanging data.
Typical API responses are at most ~50kb.</p>
<p>But what if you want to warm a cache? How much can it be?
It can be a lot, around tens of megabytes.
In my example, we take 250mb.</p>
<p>How does the server send such data?</p>
<p><img loading="lazy" alt="img" src="/mynameis/assets/images/congestion-d6e58562593cc5752c5bc8b39ab87735.svg" width="283" height="142" class="img_ev3q"></p>
<p>Slowly, packet by packet.</p>
<p>The server tries to understand your throughput. The protocol itself rarely provides an accurate value of a packet size, so by relying on the imperical latency, it tunes the packet size little by little.
It needs to send a lot of packets to transfer a really big response.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-ways-to-do-it">3 Ways to do it<a href="#3-ways-to-do-it" class="hash-link" aria-label="Direct link to 3 Ways to do it" title="Direct link to 3 Ways to do it">​</a></h3>
<p>Below we will consider 3 approaches to solve this task.
There is no such thing as the only right solution; all of them are fine as long as you understand the costs and risks well enough, and we are gonna cover them.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="first-brute-force-solution">First, Brute Force solution.<a href="#first-brute-force-solution" class="hash-link" aria-label="Direct link to First, Brute Force solution." title="Direct link to First, Brute Force solution.">​</a></h3>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you want to reproduce an example make sure to untar server/json.tar.gz; it must contain the f.json file since GitHub has a limit of up to 100mb for a file.</p></div></div>
<p>You can imagine how the simplest Go HTTP client can implement it or just look at the code.</p>
<p><a href="https://github.com/dennypenta/http-response-lab/blob/543510947c0b19dbc0097adf403ae5cd6954c1cc/client/main.go" target="_blank" rel="noopener noreferrer">Link</a></p>
<p>The implementation is straight forward: it sends a request, gets a response, reads, marhsals it into a defined structure, holds it in the memory and ready to serve it further.</p>
<p>And here is the pprof output:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 229.48MB, 100% of 229.48MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  229.48MB   100%   100%   229.48MB   100%  io.ReadAll</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%   229.48MB   100%  main.main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%   229.48MB   100%  runtime.main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Yes, it&#x27;s not real win, with huge memory consumption, but it works ok.</p>
<p>We see all the memory consumed on reading the HTTP stream.</p>
<p>Or you might say, &quot;What a noob, you must use <code>json.Decoder</code>&quot; so as to let the decoder work with the HTTP pipe closer.</p>
<p>And it&#x27;s pretty much the same, in my example, even worse.
<a href="https://github.com/dennypenta/http-response-lab/blob/b6ee7fcfd69fdffad844eb6a3d324d2fe3040985/client/main.go" target="_blank" rel="noopener noreferrer">Link</a> to code with Decoder</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 384MB, 100% of 384MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     384MB   100%   100%      384MB   100%  encoding/json.(*Decoder).refill</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  encoding/json.(*Decoder).Decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  encoding/json.(*Decoder).readValue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  main.main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%      384MB   100%  runtime.main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To recall why let&#x27;s dig a little into the json/encoding library <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.22.3:src/encoding/json/stream.go;l=49" target="_blank" rel="noopener noreferrer">implementation</a>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dec </span><span class="token operator">*</span><span class="token plain">Decoder</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">Decode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v any</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">error</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">tokenPrepareForDecode</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">tokenValueAllowed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain">SyntaxError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">msg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;not at beginning of value&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> Offset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">InputOffset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// Read whole value into buffer.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	n</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">readValue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">		</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">init</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">buf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">scanp </span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">scanp</span><span class="token operator">+</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">scanp </span><span class="token operator">+=</span><span class="token plain"> n</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// Don&#x27;t save err from unmarshal into dec.err:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// the connection is still usable since we read a complete JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// object from it before the error happened.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	err </span><span class="token operator">=</span><span class="token plain"> dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">unmarshal</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token comment" style="color:rgb(98, 114, 164)">// fixup token streaming state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	dec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">tokenValueEnd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">	</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It does exactly the same, it calls <code>dec.readValue()</code> first to read all the response and then <code>dec.d.unmarshal</code> to parse it.</p>
<p>And it&#x27;s ok; the reason is very simple: <strong>encoding/json doesn&#x27;t know the nature of your data.</strong></p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Libraries like <a href="https://github.com/json-iterator/go" target="_blank" rel="noopener noreferrer">json-iter</a> or <a href="https://github.com/mailru/easyjson" target="_blank" rel="noopener noreferrer">easyjson</a> offer zero improvements in memory consumption.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="second-decode-object-by-object">Second, decode object by object.<a href="#second-decode-object-by-object" class="hash-link" aria-label="Direct link to Second, decode object by object." title="Direct link to Second, decode object by object.">​</a></h3>
<p>Go json library provides a method of the Decoder called <a href="https://pkg.go.dev/encoding/json#Decoder.Token" target="_blank" rel="noopener noreferrer"><code>Token</code></a></p>
<p>This approach, parsing manually token by token, can give us an option to manually parse the json.
A token might be every symbol, such as as open bracket, quote, key, value, etc.
But I found this approach quite complex. Having a deeply nested JSON object makes it very confusing to understand the relation for a given token. An solution could be to hold every key and designated level, but the decision gets worse with duplicated keys on a couple of levels.</p>
<p>That&#x27;s why I prefer another approach.</p>
<p>There is a well-known problem on LeetCode called &quot;<a href="https://leetcode.com/problems/valid-parentheses/description/" target="_blank" rel="noopener noreferrer">Valid Parentheses</a>&quot;</p>
<p>We can simply read the beginning of a given object and the end, understanding when the last bracket of the object comes.</p>
<p><a href="https://github.com/dennypenta/http-response-lab/blob/b5890cbb74282416b5adacc92de95f18f7ee766f/client/main.go#L110" target="_blank" rel="noopener noreferrer">Link</a></p>
<p>pprof gives the following output</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(pprof) top 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 68.56MB, 100% of 68.56MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing top 5 nodes out of 10</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   27.55MB 40.18% 40.18%    68.56MB   100%  main.decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      20MB 29.17% 69.35%       20MB 29.17%  encoding/json.(*decodeState).literalStore</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      20MB 29.17% 98.52%       20MB 29.17%  bufio.NewReaderSize (inline)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    1.01MB  1.48%   100%     1.01MB  1.48%  bufio.(*Scanner).Text (inline)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%       20MB 29.17%  encoding/json.(*decodeState).object</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Usually, the output varies between 65-80mb.</p>
<p>Such adventages is achieved due to marshalling the json <strong>and</strong> reading the HTTP response at the same time.</p>
<p>Let&#x27;s get back to the introduction. Such a huge response gives us a stream of HTTP chunks we read step by step until the FIN message comes.
We can&#x27;t make the HTTP server split every object in the response for us (probably we can, but it brings even more complexity).
Instead, every given chunk window we can ask, &quot;Does it contain a valid json object?&quot;</p>
<p>As soon as a valid object has come, we can marshal it and continue reading the response further <strong>until the next valid JSON object comes</strong>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="third-the-simplest-data-compression">Third, the simplest: data compression.<a href="#third-the-simplest-data-compression" class="hash-link" aria-label="Direct link to Third, the simplest: data compression." title="Direct link to Third, the simplest: data compression.">​</a></h3>
<p>It was new to me to discover that the most efficient solution will nott be related to the response handling.</p>
<p><strong>We simply must transfer as little data as we can.</strong></p>
<p>JSON is not the only way to represent the data.
It&#x27;s easy and human-readable, but sometimes we have to trade it.</p>
<p>There are plenty of formats we can apply:</p>
<ul>
<li>Avro</li>
<li>Tthrift</li>
<li>MessagePack</li>
<li>Gob (Go only)</li>
<li>Protobuf</li>
</ul>
<p>And most likely more I don&#x27;t even know.</p>
<p>I tried replacing decoding to MessagePack and gave very litle result (zero _(ツ)_/).</p>
<p>The best outcome showed Protobuf.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>We still use HTTP/1.1; we don&#x27;t use gRPC transport.</p></div></div>
<p>The output from pprof is even better with less effort to implement.
It may vary up to 50mb sometimes.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(pprof) top5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 30.79MB, 100% of 30.79MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   30.79MB   100%   100%    30.79MB   100%  io.ReadAll</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    30.79MB   100%  main.decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    30.79MB   100%  main.main</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    30.79MB   100%  runtime.main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is the solution: <a href="https://github.com/dennypenta/http-response-lab/blob/main/client/main.go#L14" target="_blank" rel="noopener noreferrer">Link</a></p>
<p>What we can say about Gob?</p>
<p>It offers very specific decoding and is a Go-only implementation, but it doesn&#x27;t provide any benefit, here is the pprof output</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">(pprof) top5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing nodes accounting for 70.81MB, 100% of 70.81MB total</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Showing top 5 nodes out of 20</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      flat  flat%   sum%        cum   cum%</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   30.53MB 43.12% 43.12%    30.53MB 43.12%  internal/saferio.ReadData</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   28.28MB 39.94% 83.05%    28.28MB 39.94%  reflect.growslice</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      12MB 16.95%   100%       12MB 16.95%  encoding/gob.decString</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    70.81MB   100%  encoding/gob.(*Decoder).Decode</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         0     0%   100%    70.81MB   100%  encoding/gob.(*Decoder).DecodeValue</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Perhaps for someone, having schemaless implementation is valuable, so here is the solution <a href="https://github.com/dennypenta/http-response-lab/blob/main/client/main.go#L40" target="_blank" rel="noopener noreferrer">link</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3>
<p>I found 2 interesting ideas to me during the investigation.</p>
<ol>
<li>The best, or one of them, solution might be the most obvious, so obvious to one is not to everyone.</li>
<li>It&#x27;s not hard to implement and dig into fundamentals; some may win from engineering a new bicycle.</li>
</ol></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/mynameis/blog/tags/software">software</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/mynameis/blog/tq-devlog-0"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">PaaS devlog |#0</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/mynameis/blog/why-a-blog"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Why this page exists</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-challenge-cut-down-the-memory-consumption-as-much-as-we-can" class="table-of-contents__link toc-highlight">The challenge: cut down the memory consumption as much as we can.</a></li><li><a href="#3-ways-to-do-it" class="table-of-contents__link toc-highlight">3 Ways to do it</a></li><li><a href="#first-brute-force-solution" class="table-of-contents__link toc-highlight">First, Brute Force solution.</a></li><li><a href="#second-decode-object-by-object" class="table-of-contents__link toc-highlight">Second, decode object by object.</a></li><li><a href="#third-the-simplest-data-compression" class="table-of-contents__link toc-highlight">Third, the simplest: data compression.</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div></div>
</body>
</html>